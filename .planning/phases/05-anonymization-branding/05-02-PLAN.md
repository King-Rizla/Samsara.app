---
phase: 05-anonymization-branding
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - python-src/export/theme.py
  - python-src/export/blind_profile.py
  - python-src/export/__init__.py
  - python-src/main.py
  - src/main/settings.ts
  - src/main/index.ts
  - src/main/preload.ts
  - resources/theme.json
autonomous: true

must_haves:
  truths:
    - "User can generate a one-page Blind Profile front sheet prepended to CV"
    - "Blind Profile shows name (or 'Candidate' in punt mode), location, key skills, last 3 jobs"
    - "Blind Profile footer shows recruiter contact details from app settings"
    - "Blind Profile uses theme colors and styling from theme.json"
  artifacts:
    - path: "python-src/export/blind_profile.py"
      provides: "ReportLab-based front sheet generation"
      exports: ["generate_blind_profile"]
    - path: "python-src/export/theme.py"
      provides: "Theme loading and validation"
      exports: ["load_theme", "Theme"]
    - path: "resources/theme.json"
      provides: "Default theme configuration"
      contains: "primary_color"
    - path: "src/main/settings.ts"
      provides: "Recruiter settings storage"
      contains: "recruiterName"
  key_links:
    - from: "python-src/export/blind_profile.py"
      to: "resources/theme.json"
      via: "load_theme()"
      pattern: "load_theme"
    - from: "src/main/index.ts"
      to: "src/main/settings.ts"
      via: "getRecruiterSettings()"
      pattern: "getRecruiterSettings"
---

<objective>
Implement Blind Profile front sheet generation using ReportLab with theme support and recruiter settings.

Purpose: Provide recruiters with a one-page summary prepended to CVs that includes candidate skills and experience while featuring the recruiter's contact details as the point of contact.

Output: Theme-aware Blind Profile PDF generator + recruiter settings infrastructure.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-anonymization-branding/05-CONTEXT.md
@.planning/phases/05-anonymization-branding/05-RESEARCH.md
@.planning/phases/05-anonymization-branding/05-01-SUMMARY.md
@python-src/export/redaction.py
@python-src/main.py
@src/main/settings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme.json and theme loader</name>
  <files>
    resources/theme.json
    python-src/export/theme.py
    python-src/export/__init__.py
  </files>
  <action>
1. Create `resources/theme.json` with default branding:
   ```json
   {
     "primary_color": "#6B21A8",
     "secondary_color": "#374151",
     "header_font": "Helvetica-Bold",
     "body_font": "Helvetica",
     "logo_path": null,
     "company_name": "Samsara Recruitment"
   }
   ```
   - Purple primary matches existing terminal aesthetic (#6B21A8)
   - Use Helvetica (built-in, no font embedding issues)
   - logo_path null by default (clients can customize)

2. Create `python-src/export/theme.py`:
   ```python
   import json
   import os
   import sys
   from dataclasses import dataclass
   from typing import Optional

   @dataclass
   class Theme:
       primary_color: str
       secondary_color: str
       header_font: str
       body_font: str
       logo_path: Optional[str]
       company_name: str

   def get_theme_path() -> str:
       """Get theme.json path, handling PyInstaller frozen context."""
       if getattr(sys, 'frozen', False):
           # PyInstaller bundle - theme in extraResources
           base = os.path.dirname(sys.executable)
           # Go up from sidecar to resources
           return os.path.join(base, '..', 'resources', 'theme.json')
       else:
           # Development - theme in resources folder
           base = os.path.dirname(os.path.dirname(os.path.dirname(__file__)))
           return os.path.join(base, 'resources', 'theme.json')

   def load_theme() -> Theme:
       """Load theme from theme.json file."""
       theme_path = get_theme_path()

       # Default theme if file not found
       defaults = {
           'primary_color': '#6B21A8',
           'secondary_color': '#374151',
           'header_font': 'Helvetica-Bold',
           'body_font': 'Helvetica',
           'logo_path': None,
           'company_name': 'Samsara Recruitment'
       }

       try:
           with open(theme_path, 'r') as f:
               data = json.load(f)
               return Theme(
                   primary_color=data.get('primary_color', defaults['primary_color']),
                   secondary_color=data.get('secondary_color', defaults['secondary_color']),
                   header_font=data.get('header_font', defaults['header_font']),
                   body_font=data.get('body_font', defaults['body_font']),
                   logo_path=data.get('logo_path'),
                   company_name=data.get('company_name', defaults['company_name'])
               )
       except (FileNotFoundError, json.JSONDecodeError):
           return Theme(**defaults)
   ```

3. Update `python-src/export/__init__.py`:
   - Add exports: `from .theme import load_theme, Theme`
  </action>
  <verify>
Test theme loading:
```python
from export.theme import load_theme
theme = load_theme()
print(theme.primary_color)  # Should print #6B21A8
```
  </verify>
  <done>
Theme loader exists with defaults. resources/theme.json exists with purple terminal theme.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Blind Profile generator with ReportLab</name>
  <files>
    python-src/export/blind_profile.py
    python-src/export/__init__.py
  </files>
  <action>
Create `python-src/export/blind_profile.py`:

1. Imports:
   ```python
   from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
   from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
   from reportlab.lib.pagesizes import A4
   from reportlab.lib.units import mm
   from reportlab.lib import colors
   from io import BytesIO
   from .theme import Theme
   ```

2. Implement `generate_blind_profile(cv_data: dict, theme: Theme, recruiter: dict, mode: str) -> bytes`:
   - mode: 'client' or 'punt' (punt shows "Candidate" instead of name)
   - Returns PDF bytes of single-page front sheet

3. Front sheet structure (from CONTEXT.md):
   - **Header**: Name (or "Candidate" for punt mode), Location
   - **Key Skills section**: First 15 skills from skills array (pipe-separated)
   - **Recent Experience section**: Last 3 jobs with:
     - Position at Company
     - Start date - End date
     - Description (max 150 chars, ~3 lines)
   - **Recruiter footer box**: Name, phone, email on light gray background

4. Style from theme:
   - Title text in primary_color
   - Section headers in primary_color
   - Body text in secondary_color
   - Use header_font for titles, body_font for content

5. Handle missing data gracefully:
   - No skills: Skip section
   - No work history: Show "Experience details available on request"
   - No recruiter info: Skip footer box

Update `python-src/export/__init__.py`:
- Add: `from .blind_profile import generate_blind_profile`
  </action>
  <verify>
Test blind profile generation:
```python
from export.blind_profile import generate_blind_profile
from export.theme import load_theme

cv_data = {
    'contact': {'name': 'John Smith', 'address': 'London, UK'},
    'skills': [{'category': 'Tech', 'skills': ['Python', 'JavaScript', 'SQL']}],
    'work_history': [{'position': 'Developer', 'company': 'Tech Co', 'start_date': '2020-01', 'end_date': 'Present', 'description': 'Built stuff'}]
}
theme = load_theme()
recruiter = {'name': 'Jane Doe', 'phone': '555-1234', 'email': 'jane@recruit.com'}

pdf_bytes = generate_blind_profile(cv_data, theme, recruiter, 'client')
with open('test_profile.pdf', 'wb') as f:
    f.write(pdf_bytes)
# Open test_profile.pdf and verify layout
```
  </verify>
  <done>
Blind Profile generator creates themed one-page PDF with candidate summary and recruiter footer.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add recruiter settings and integrate blind profile into export</name>
  <files>
    src/main/settings.ts
    src/main/index.ts
    src/main/preload.ts
    python-src/main.py
  </files>
  <action>
1. Update `src/main/settings.ts` - add recruiter fields:
   ```typescript
   export interface AppSettings {
     llmMode: 'local' | 'cloud';
     openaiApiKey?: string;
     // Recruiter details for blind profile footer
     recruiterName?: string;
     recruiterPhone?: string;
     recruiterEmail?: string;
   }
   ```

   Add helper functions:
   ```typescript
   export interface RecruiterSettings {
     name?: string;
     phone?: string;
     email?: string;
   }

   export function getRecruiterSettings(): RecruiterSettings {
     const settings = loadSettings();
     return {
       name: settings.recruiterName,
       phone: settings.recruiterPhone,
       email: settings.recruiterEmail,
     };
   }

   export function setRecruiterSettings(recruiter: RecruiterSettings): void {
     saveSettings({
       recruiterName: recruiter.name,
       recruiterPhone: recruiter.phone,
       recruiterEmail: recruiter.email,
     });
   }
   ```

2. Update `src/main/preload.ts` - add recruiter settings API:
   ```typescript
   // Recruiter settings for blind profile
   getRecruiterSettings: (): Promise<{ success: boolean; data?: { name?: string; phone?: string; email?: string }; error?: string }> =>
     ipcRenderer.invoke('get-recruiter-settings'),

   setRecruiterSettings: (settings: { name?: string; phone?: string; email?: string }): Promise<{ success: boolean; error?: string }> =>
     ipcRenderer.invoke('set-recruiter-settings', settings),
   ```

3. Update `src/main/index.ts`:
   - Import `getRecruiterSettings, setRecruiterSettings` from settings
   - Add IPC handlers:
   ```typescript
   ipcMain.handle('get-recruiter-settings', async () => {
     return { success: true, data: getRecruiterSettings() };
   });

   ipcMain.handle('set-recruiter-settings', async (_event, settings) => {
     try {
       setRecruiterSettings(settings);
       return { success: true };
     } catch (error) {
       return { success: false, error: String(error) };
     }
   });
   ```

4. Update `src/main/index.ts` 'export-cv' handler to include blind profile:
   - Add optional `includeBlindProfile: boolean` parameter
   - Pass recruiter settings to Python
   - Modify call:
   ```typescript
   ipcMain.handle('export-cv', async (_event, cvId: string, mode: string, outputDir?: string, includeBlindProfile: boolean = true) => {
     // ... existing code ...
     const recruiter = getRecruiterSettings();

     const result = await sendPythonRequest({
       action: 'export_cv',
       cv_id: cvId,
       source_path: cvRecord.file_path,
       contact_info: contact,
       mode: mode,
       output_dir: actualOutputDir,
       include_blind_profile: includeBlindProfile,
       recruiter: recruiter,
       cv_data: cvData  // Full CV data for blind profile
     });
   });
   ```

5. Update preload.ts exportCV signature:
   ```typescript
   exportCV: (cvId: string, mode: 'full' | 'client' | 'punt', outputDir?: string, includeBlindProfile?: boolean): Promise<...>
   ```

6. Update `python-src/main.py` export_cv handler:
   - Import blind_profile and theme modules
   - If include_blind_profile, generate front sheet
   - Merge front sheet with redacted CV using PyMuPDF
   - See RESEARCH.md pattern for merging:
   ```python
   if include_blind_profile and cv_data:
       from export.blind_profile import generate_blind_profile
       from export.theme import load_theme
       import pymupdf

       theme = load_theme()
       profile_bytes = generate_blind_profile(cv_data, theme, recruiter or {}, mode)

       # Merge: profile first, then CV
       front_doc = pymupdf.open(stream=profile_bytes, filetype="pdf")
       cv_doc = pymupdf.open(stream=redacted_bytes, filetype="pdf")
       front_doc.insert_pdf(cv_doc)

       output_bytes = front_doc.tobytes()
       front_doc.close()
       cv_doc.close()
   else:
       output_bytes = redacted_bytes
   ```
  </action>
  <verify>
1. TypeScript compiles: `npm run type-check`
2. Test full integration from DevTools:
   ```javascript
   // Set recruiter
   await api.setRecruiterSettings({name: 'Jane', phone: '555', email: 'j@r.com'})
   // Export with blind profile
   await api.exportCV(cvId, 'client', null, true)
   // Check Downloads folder for combined PDF
   ```
  </verify>
  <done>
Recruiter settings persist. Export includes optional blind profile front sheet. Combined PDF (profile + CV) exports correctly.
  </done>
</task>

</tasks>

<verification>
1. `npm run type-check` passes
2. `python -c "from export.blind_profile import generate_blind_profile; from export.theme import load_theme"` succeeds
3. Export with blind profile produces combined PDF:
   - Page 1: Blind Profile with candidate summary and recruiter footer
   - Page 2+: Original CV with redacted contact info
4. Punt mode shows "Candidate" instead of real name on front sheet
5. Theme colors visible in PDF output (purple headers)
</verification>

<success_criteria>
- Blind Profile generates as single A4 page with ReportLab
- Front sheet includes: candidate info, skills, last 3 jobs, recruiter box
- Theme.json colors applied to text
- Recruiter settings persist across app restarts
- Combined PDF (profile + CV) generates correctly
- Performance: Blind profile generation <100ms (ReportLab is fast)
</success_criteria>

<output>
After completion, create `.planning/phases/05-anonymization-branding/05-02-SUMMARY.md`
</output>
