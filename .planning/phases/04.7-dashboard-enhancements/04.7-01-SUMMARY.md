---
phase: 04.7-dashboard-enhancements
plan: 01
subsystem: database
tags: [sqlite, usage-tracking, token-counting, project-pinning, migration]

# Dependency graph
requires:
  - phase: 04.5-project-homepage
    provides: projects table with id, name, client_name, description, is_archived
  - phase: 04.6-queue-infrastructure
    provides: cvs table with status column and queue functions
provides:
  - usage_events table for raw token usage per LLM call
  - usage_daily table for aggregated daily totals
  - SQLite trigger for auto-aggregation on insert
  - is_pinned and pin_order columns for project quick-access
  - CRUD functions for usage tracking and project pinning
affects: [04.7-02, 04.7-03, 04.7-04]

# Tech tracking
tech-stack:
  added: []
  patterns: [SQLite trigger for auto-aggregation, transaction-based reordering]

key-files:
  created: []
  modified:
    - src/main/database.ts

key-decisions:
  - "SQLite trigger update_daily_usage auto-aggregates tokens into usage_daily on INSERT"
  - "Current month filtering via strftime('%Y-%m-01', 'now') for usage stats"
  - "Pin order uses simple incrementing integers, transactions for reorder"

patterns-established:
  - "Usage tracking: Insert raw events, let trigger aggregate daily"
  - "Project pinning: is_pinned flag + pin_order integer for drag-drop reorder"

# Metrics
duration: 3min
completed: 2026-01-27
---

# Phase 4.7 Plan 01: Database Schema for Usage Tracking and Pinning Summary

**Migration v3 adds usage_events and usage_daily tables with auto-aggregation trigger, plus is_pinned/pin_order columns for project quick-access sidebar**

## Performance

- **Duration:** 3 min (175 seconds)
- **Started:** 2026-01-27T20:28:23Z
- **Completed:** 2026-01-27T20:31:18Z
- **Tasks:** 2
- **Files modified:** 1

## Accomplishments
- Created usage_events table to store raw token counts per LLM call with project/event type/mode tracking
- Created usage_daily table with UNIQUE(project_id, date) constraint for efficient aggregation
- Implemented SQLite trigger that auto-aggregates on INSERT using ON CONFLICT DO UPDATE pattern
- Added is_pinned and pin_order columns to projects table for sidebar quick-access
- Implemented seven CRUD functions for usage tracking and project pinning

## Task Commits

Each task was committed atomically:

1. **Task 1: Add usage tracking tables and trigger** - `36b51e4` (feat)
2. **Task 2: Add usage tracking and pinning CRUD functions** - `1939904` (feat)

## Files Created/Modified
- `src/main/database.ts` - Added migration v3, usage tracking interfaces (UsageEventInput, UsageStats, ProjectUsageStats), and 7 new functions

## New Functions Added

### Usage Tracking Functions
1. `recordUsageEvent(input: UsageEventInput): void` - Insert usage event (trigger auto-aggregates)
2. `getUsageStatsByProject(projectId: string): UsageStats` - Get stats for specific project (current month)
3. `getGlobalUsageStats(): UsageStats` - Get aggregate stats across all projects (current month)
4. `getAllUsageStats(): ProjectUsageStats` - Get both global and per-project stats

### Project Pinning Functions
5. `updateProjectPinned(projectId: string, isPinned: boolean): boolean` - Pin/unpin with auto pin_order
6. `getPinnedProjects(): ProjectSummary[]` - Get pinned projects sorted by pin_order
7. `reorderPinnedProjects(projectIds: string[]): void` - Atomic reorder via transaction

## Decisions Made
- Used SQLite trigger for auto-aggregation to ensure atomic updates and survive crashes
- Current month filtering uses `strftime('%Y-%m-01', 'now')` for consistent start-of-month boundary
- Pin order uses simple incrementing integers; max + 1 on pin, 0 on unpin
- Transaction wrapping for reorder ensures atomicity

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Database schema ready for IPC handlers (04.7-02)
- Usage functions ready to be called from QueueManager after CV extraction
- Pinning functions ready for sidebar UI integration
- No blockers

---
*Phase: 04.7-dashboard-enhancements*
*Completed: 2026-01-27*
