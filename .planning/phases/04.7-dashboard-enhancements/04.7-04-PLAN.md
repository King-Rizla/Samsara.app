---
phase: 04.7-dashboard-enhancements
plan: 04
type: execute
wave: 2
depends_on: ["04.7-01"]
files_modified:
  - package.json
  - src/renderer/App.tsx
  - src/renderer/components/sidebar/AppSidebar.tsx
  - src/renderer/components/dashboard/ProjectCard.tsx
  - src/renderer/routes/Dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Project cards are draggable from dashboard"
    - "Sidebar has a drop zone that accepts dragged projects"
    - "Dragged project gets pinned to sidebar on drop"
    - "DragOverlay renders project preview outside DOM hierarchy"
  artifacts:
    - path: "package.json"
      provides: "@dnd-kit libraries installed"
      contains: "@dnd-kit/core"
    - path: "src/renderer/App.tsx"
      provides: "DndContext wrapping routes"
      contains: "DndContext"
    - path: "src/renderer/components/sidebar/AppSidebar.tsx"
      provides: "Sidebar drop zone for pinned projects"
      contains: "useDroppable"
  key_links:
    - from: "src/renderer/App.tsx"
      to: "src/renderer/components/sidebar/AppSidebar.tsx"
      via: "DndContext onDragEnd handler"
      pattern: "onDragEnd"
---

<objective>
Install @dnd-kit and implement drag-drop infrastructure for pinning projects to sidebar.

Purpose: Enables quick-access workflow where users drag frequently-used projects to sidebar.
Output: Draggable project cards, sidebar drop zone, pinned projects list.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.7-dashboard-enhancements/04.7-RESEARCH.md
@.planning/phases/04.7-dashboard-enhancements/04.7-01-SUMMARY.md
@src/renderer/App.tsx
@src/renderer/components/sidebar/AppSidebar.tsx
@src/renderer/components/dashboard/ProjectCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @dnd-kit libraries</name>
  <files>package.json</files>
  <action>
    Run npm install to add @dnd-kit packages:
    ```bash
    npm install @dnd-kit/core @dnd-kit/utilities
    ```

    Note: We don't need @dnd-kit/sortable since we're doing simple drag-to-pin, not reordering.

    After installation, verify package.json includes:
    - @dnd-kit/core: ^6.x
    - @dnd-kit/utilities: ^3.x
  </action>
  <verify>npm list @dnd-kit/core shows version installed</verify>
  <done>@dnd-kit libraries installed</done>
</task>

<task type="auto">
  <name>Task 2: Make ProjectCard draggable</name>
  <files>src/renderer/components/dashboard/ProjectCard.tsx</files>
  <action>
    Import useDraggable from @dnd-kit/core:
    ```typescript
    import { useDraggable } from '@dnd-kit/core';
    import { CSS } from '@dnd-kit/utilities';
    ```

    Modify the ProjectCard component to be draggable:

    1. Add useDraggable hook inside component:
    ```typescript
    const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
      id: `project-${project.id}`,
      data: { type: 'project', project },
    });
    ```

    2. Create style object for transform:
    ```typescript
    const style = {
      transform: CSS.Translate.toString(transform),
      opacity: isDragging ? 0.5 : 1,
    };
    ```

    3. Apply to the Card element:
    - Add ref={setNodeRef}
    - Add style={style}
    - Add {...listeners} and {...attributes} but NOT on the dropdown menu trigger (to prevent drag when clicking menu)

    The structure should look like:
    ```tsx
    <Card
      ref={setNodeRef}
      style={style}
      className="..."
      {...attributes}
    >
      <CardHeader className="..." {...listeners}>
        {/* Header content - this is the drag handle */}
        <div className="space-y-1" {...listeners}>
          <CardTitle>...</CardTitle>
          <CardDescription>...</CardDescription>
        </div>
        {/* Dropdown menu should NOT have listeners */}
        <DropdownMenu>...</DropdownMenu>
      </CardHeader>
      {/* Card content also draggable */}
      <CardContent {...listeners} onClick={() => navigate(...)}>
        ...
      </CardContent>
    </Card>
    ```

    Note: Keep the onClick for navigation - it fires when not dragging. Add a check:
    ```typescript
    onClick={() => !isDragging && navigate(`/project/${project.id}`)}
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>ProjectCard is draggable with proper event handling</done>
</task>

<task type="auto">
  <name>Task 3: Add drop zone and pinned projects to sidebar</name>
  <files>src/renderer/components/sidebar/AppSidebar.tsx</files>
  <action>
    Import required hooks and components:
    ```typescript
    import { useDroppable } from '@dnd-kit/core';
    import { useState, useEffect } from 'react';
    import { FolderOpen, Pin } from 'lucide-react';
    ```

    Add state for pinned projects:
    ```typescript
    const [pinnedProjects, setPinnedProjects] = useState<Array<{ id: string; name: string }>>([]);
    ```

    Add useEffect to load pinned projects on mount:
    ```typescript
    useEffect(() => {
      const loadPinned = async () => {
        const result = await window.api.getPinnedProjects();
        if (result.success && result.data) {
          setPinnedProjects(result.data.map(p => ({ id: p.id, name: p.name })));
        }
      };
      loadPinned();
    }, []);
    ```

    Create a SidebarDropZone component (can be inline or extracted):
    ```typescript
    function SidebarDropZone() {
      const { setNodeRef, isOver } = useDroppable({ id: 'sidebar-quick-access' });

      return (
        <div
          ref={setNodeRef}
          className={`
            mx-2 my-1 p-2 rounded-md border-2 border-dashed
            text-xs text-muted-foreground text-center
            transition-colors
            ${isOver ? 'border-primary bg-primary/10' : 'border-border'}
          `}
        >
          <Pin className="h-4 w-4 mx-auto mb-1" />
          Drop to pin
        </div>
      );
    }
    ```

    Add to the sidebar structure (after the Dashboard nav item, before SidebarFooter):
    ```tsx
    <SidebarGroup>
      <SidebarGroupLabel className="text-xs text-muted-foreground">
        Quick Access
      </SidebarGroupLabel>
      <SidebarGroupContent>
        <SidebarMenu>
          {pinnedProjects.map((project) => (
            <SidebarMenuItem key={project.id}>
              <SidebarMenuButton
                onClick={() => navigate(`/project/${project.id}`)}
                tooltip={project.name}
              >
                <FolderOpen className="h-4 w-4" />
                <span className="truncate">{project.name}</span>
              </SidebarMenuButton>
            </SidebarMenuItem>
          ))}
          <SidebarDropZone />
        </SidebarMenu>
      </SidebarGroupContent>
    </SidebarGroup>
    ```

    Import SidebarGroupLabel:
    ```typescript
    import {
      // ... existing
      SidebarGroupLabel,
    } from '../ui/sidebar';
    ```

    Export a method to refresh pinned projects (for App.tsx to call after drop):
    ```typescript
    // Add to component
    export const refreshPinnedProjects = async () => {
      // This will be called from App after successful pin
    };
    ```

    Actually, better approach: Accept pinnedProjects as a prop from App.tsx which manages the DndContext state:
    ```typescript
    interface AppSidebarProps {
      pinnedProjects?: Array<{ id: string; name: string }>;
    }

    export function AppSidebar({ pinnedProjects = [] }: AppSidebarProps) {
      // Remove local state, use prop instead
      ...
    }
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>Sidebar has Quick Access section with drop zone and pinned projects</done>
</task>

<task type="auto">
  <name>Task 4: Add DndContext to App.tsx</name>
  <files>src/renderer/App.tsx</files>
  <action>
    Import DndContext and related utilities:
    ```typescript
    import {
      DndContext,
      DragOverlay,
      DragStartEvent,
      DragEndEvent,
      PointerSensor,
      useSensor,
      useSensors,
    } from '@dnd-kit/core';
    import { useState, useEffect } from 'react';
    ```

    Add state for drag and pinned projects:
    ```typescript
    const [activeProject, setActiveProject] = useState<{ id: string; name: string } | null>(null);
    const [pinnedProjects, setPinnedProjects] = useState<Array<{ id: string; name: string }>>([]);
    ```

    Add sensors configuration (with distance constraint to prevent accidental drags):
    ```typescript
    const sensors = useSensors(
      useSensor(PointerSensor, {
        activationConstraint: {
          distance: 8, // 8px movement required to start drag
        },
      })
    );
    ```

    Add useEffect to load pinned projects:
    ```typescript
    useEffect(() => {
      const loadPinned = async () => {
        const result = await window.api.getPinnedProjects();
        if (result.success && result.data) {
          setPinnedProjects(result.data.map(p => ({ id: p.id, name: p.name })));
        }
      };
      loadPinned();
    }, []);
    ```

    Add drag handlers:
    ```typescript
    const handleDragStart = (event: DragStartEvent) => {
      if (event.active.data.current?.type === 'project') {
        setActiveProject({
          id: event.active.data.current.project.id,
          name: event.active.data.current.project.name,
        });
      }
    };

    const handleDragEnd = async (event: DragEndEvent) => {
      const { active, over } = event;
      setActiveProject(null);

      if (over?.id === 'sidebar-quick-access' && active.data.current?.type === 'project') {
        const project = active.data.current.project;
        // Check if already pinned
        if (!pinnedProjects.some(p => p.id === project.id)) {
          // Pin via IPC
          const result = await window.api.setPinnedProject(project.id, true);
          if (result.success) {
            setPinnedProjects(prev => [...prev, { id: project.id, name: project.name }]);
          }
        }
      }
    };
    ```

    Wrap the existing JSX with DndContext:
    ```tsx
    return (
      <DndContext
        sensors={sensors}
        onDragStart={handleDragStart}
        onDragEnd={handleDragEnd}
      >
        {/* Existing SidebarProvider/Router structure */}
        <SidebarProvider ...>
          <AppSidebar pinnedProjects={pinnedProjects} />
          ...
        </SidebarProvider>

        {/* DragOverlay renders outside normal DOM for z-index */}
        <DragOverlay>
          {activeProject ? (
            <div className="bg-card border border-primary rounded-md p-3 shadow-lg opacity-90">
              <span className="font-medium">{activeProject.name}</span>
            </div>
          ) : null}
        </DragOverlay>
      </DndContext>
    );
    ```

    Pass pinnedProjects prop to AppSidebar.
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>DndContext wraps app, handles drag-to-pin flow</done>
</task>

</tasks>

<verification>
After all tasks:
1. Run `npm run lint --quiet` - no errors
2. Run `npm run build` - builds successfully
3. Manual test: Start app, drag a project card toward sidebar, see drop zone highlight
4. Manual test: Drop on sidebar, project appears in Quick Access section
</verification>

<success_criteria>
- @dnd-kit/core and @dnd-kit/utilities installed
- Project cards are draggable (with 8px activation distance)
- Sidebar shows "Quick Access" section with drop zone
- Dropping project on sidebar pins it and adds to list
- DragOverlay shows project name during drag
- No z-index/clipping issues (overlay renders in portal)
</success_criteria>

<output>
After completion, create `.planning/phases/04.7-dashboard-enhancements/04.7-04-SUMMARY.md`
</output>
