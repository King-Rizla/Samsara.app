---
phase: 08-samsara-wheel-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/database.ts
autonomous: true

must_haves:
  truths:
    - "Database migrates to version 5 on app start adding all 7 M2 tables"
    - "Existing data (projects, CVs, JDs) is preserved after migration"
    - "All M2 tables are scoped to project via project_id foreign key with CASCADE delete"
    - "provider_credentials table supports global (NULL project_id) credentials"
  artifacts:
    - path: "src/main/database.ts"
      provides: "Migration v5 with 7 new tables: messages, call_records, transcripts, outreach_templates, outreach_sequences, provider_credentials, ats_mappings"
      contains: "user_version = 5"
  key_links:
    - from: "src/main/database.ts"
      to: "SQLite database file"
      via: "version < 5 migration block"
      pattern: "version < 5"
---

<objective>
Add SQLite migration v5 with all 7 M2 outreach tables to the database initialization.

Purpose: Future phases (9-13) need these tables for messages, calls, transcripts, templates, sequences, credentials, and ATS mappings. Creating them now means no migration work blocks later phases.

Output: Database automatically migrates to version 5 on app start, creating all M2 tables with proper foreign keys and indexes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-samsara-wheel-foundation/08-RESEARCH.md
@src/main/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add migration v5 with all M2 outreach tables</name>
  <files>src/main/database.ts</files>
  <action>
Find the last migration block (version < 4) in the initializeDatabase function. After it, add:

```typescript
if (version < 5) {
  console.log("Migrating database to version 5 (M2 outreach tables)...");

  db.exec(`
    -- Messages (SMS + email)
    CREATE TABLE IF NOT EXISTS messages (
      id TEXT PRIMARY KEY,
      project_id TEXT NOT NULL,
      cv_id TEXT,
      type TEXT NOT NULL,
      direction TEXT NOT NULL,
      status TEXT NOT NULL,
      from_address TEXT,
      to_address TEXT NOT NULL,
      subject TEXT,
      body TEXT NOT NULL,
      template_id TEXT,
      provider_message_id TEXT,
      error_message TEXT,
      sent_at TEXT,
      delivered_at TEXT,
      created_at TEXT NOT NULL,
      FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
      FOREIGN KEY (cv_id) REFERENCES cvs(id) ON DELETE SET NULL
    );

    -- Call records
    CREATE TABLE IF NOT EXISTS call_records (
      id TEXT PRIMARY KEY,
      project_id TEXT NOT NULL,
      cv_id TEXT,
      type TEXT NOT NULL,
      status TEXT NOT NULL,
      provider_call_id TEXT,
      phone_number TEXT NOT NULL,
      duration_seconds INTEGER,
      screening_outcome TEXT,
      screening_confidence REAL,
      recording_path TEXT,
      started_at TEXT,
      ended_at TEXT,
      created_at TEXT NOT NULL,
      FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
      FOREIGN KEY (cv_id) REFERENCES cvs(id) ON DELETE SET NULL
    );

    -- Transcripts
    CREATE TABLE IF NOT EXISTS transcripts (
      id TEXT PRIMARY KEY,
      call_id TEXT NOT NULL,
      project_id TEXT NOT NULL,
      raw_text TEXT NOT NULL,
      segments_json TEXT,
      summary TEXT,
      created_at TEXT NOT NULL,
      FOREIGN KEY (call_id) REFERENCES call_records(id) ON DELETE CASCADE,
      FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
    );

    -- Outreach templates
    CREATE TABLE IF NOT EXISTS outreach_templates (
      id TEXT PRIMARY KEY,
      project_id TEXT NOT NULL,
      name TEXT NOT NULL,
      type TEXT NOT NULL,
      subject TEXT,
      body TEXT NOT NULL,
      variables_json TEXT,
      is_default INTEGER DEFAULT 0,
      created_at TEXT NOT NULL,
      updated_at TEXT NOT NULL,
      FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
    );

    -- Outreach sequences
    CREATE TABLE IF NOT EXISTS outreach_sequences (
      id TEXT PRIMARY KEY,
      project_id TEXT NOT NULL,
      cv_id TEXT NOT NULL,
      status TEXT NOT NULL,
      current_step INTEGER DEFAULT 0,
      steps_json TEXT NOT NULL,
      started_at TEXT,
      completed_at TEXT,
      created_at TEXT NOT NULL,
      FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
      FOREIGN KEY (cv_id) REFERENCES cvs(id) ON DELETE CASCADE
    );

    -- Provider credentials (encrypted via safeStorage)
    CREATE TABLE IF NOT EXISTS provider_credentials (
      id TEXT PRIMARY KEY,
      project_id TEXT,
      provider TEXT NOT NULL,
      credential_type TEXT NOT NULL,
      encrypted_value TEXT NOT NULL,
      label TEXT,
      created_at TEXT NOT NULL,
      updated_at TEXT NOT NULL,
      FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
    );

    -- ATS field mappings
    CREATE TABLE IF NOT EXISTS ats_mappings (
      id TEXT PRIMARY KEY,
      project_id TEXT NOT NULL,
      ats_vendor TEXT NOT NULL,
      mapping_json TEXT NOT NULL,
      created_at TEXT NOT NULL,
      updated_at TEXT NOT NULL,
      FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
    );

    -- Indexes for common queries
    CREATE INDEX IF NOT EXISTS idx_messages_project ON messages(project_id);
    CREATE INDEX IF NOT EXISTS idx_messages_cv ON messages(cv_id);
    CREATE INDEX IF NOT EXISTS idx_call_records_project ON call_records(project_id);
    CREATE INDEX IF NOT EXISTS idx_call_records_cv ON call_records(cv_id);
    CREATE INDEX IF NOT EXISTS idx_transcripts_call ON transcripts(call_id);
    CREATE INDEX IF NOT EXISTS idx_transcripts_project ON transcripts(project_id);
    CREATE INDEX IF NOT EXISTS idx_outreach_templates_project ON outreach_templates(project_id);
    CREATE INDEX IF NOT EXISTS idx_outreach_sequences_project ON outreach_sequences(project_id);
    CREATE INDEX IF NOT EXISTS idx_outreach_sequences_cv ON outreach_sequences(cv_id);
    CREATE INDEX IF NOT EXISTS idx_provider_credentials_project ON provider_credentials(project_id);
    CREATE INDEX IF NOT EXISTS idx_ats_mappings_project ON ats_mappings(project_id);
  `);

  db.pragma("user_version = 5");
  console.log("Database migrated to version 5");
}
```

Key points:

- Must be `version < 5` (current max is version < 4, per research pitfall #6)
- All tables use TEXT PRIMARY KEY (UUID pattern established in existing schema)
- All tables scoped to project_id with CASCADE delete (DAT-01)
- provider_credentials.project_id is nullable (NULL = global credential)
- Use CREATE TABLE IF NOT EXISTS for safety
- Add indexes on foreign key columns for query performance
- Match exact schema from 08-RESEARCH.md
  </action>
  <verify> - `npx tsc --noEmit` passes - `npx vitest run` — tests pass - App starts successfully: `npm start` — no migration errors in console - After start, check database has version 5: migration log appears in console
  </verify>
  <done> - 7 new tables exist: messages, call_records, transcripts, outreach_templates, outreach_sequences, provider_credentials, ats_mappings - All tables have project_id foreign key with CASCADE delete - Database version is 5 - Existing data (projects, CVs, JDs) unaffected - Indexes created on all foreign key columns
  </done>
  </task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors
2. `npx vitest run` — tests pass
3. App starts and logs "Migrating database to version 5"
4. All 7 tables queryable (no errors on SELECT from each)
</verification>

<success_criteria>

- DAT-01: All outreach data scoped to project via project_id foreign keys
- DAT-02: SQLite schema extended with all 7 M2 tables (messages, call_records, transcripts, outreach_templates, outreach_sequences, provider_credentials, ats_mappings)
- Migration follows established pattern (version < 5, pragma user_version = 5)
- No data loss on existing projects/CVs/JDs
  </success_criteria>

<output>
After completion, create `.planning/phases/08-samsara-wheel-foundation/08-03-SUMMARY.md`
</output>
