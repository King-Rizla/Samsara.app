---
phase: 07-testing-and-bug-fixing-protocol
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - python-src/tests/conftest.py
  - python-src/tests/test_parsers.py
  - python-src/tests/test_extractors.py
  - python-src/tests/test_normalizers.py
  - python-src/tests/test_export.py
  - python-src/tests/test_schema.py
  - python-src/tests/test_edge_cases.py
autonomous: true

must_haves:
  truths:
    - "20+ unit tests exist per critical Python module (parsers, extractors, normalizers, export)"
    - "Edge case corpus covers null, empty, unicode, injection, path traversal, huge inputs"
    - "Hypothesis property-based tests generate thousands of fuzz cases for parsers"
    - "All tests pass with pytest"
  artifacts:
    - path: "python-src/tests/conftest.py"
      provides: "Shared fixtures (sample CV text, mock PDF paths, edge case corpus)"
      contains: "pytest.fixture"
    - path: "python-src/tests/test_parsers.py"
      provides: "Parser unit tests (PDF, DOCX)"
      min_lines: 100
    - path: "python-src/tests/test_extractors.py"
      provides: "Extractor unit tests (contact, education, skills, work history)"
      min_lines: 150
    - path: "python-src/tests/test_normalizers.py"
      provides: "Normalizer unit tests (dates, text)"
      min_lines: 80
    - path: "python-src/tests/test_export.py"
      provides: "Export unit tests (redaction, blind profile, theme)"
      min_lines: 80
    - path: "python-src/tests/test_edge_cases.py"
      provides: "Edge case corpus + hypothesis fuzz tests"
      contains: "hypothesis"
  key_links:
    - from: "python-src/tests/test_parsers.py"
      to: "python-src/parsers/"
      via: "import from parsers"
      pattern: "from parsers"
    - from: "python-src/tests/test_edge_cases.py"
      to: "python-src/parsers/"
      via: "fuzz testing parser functions"
      pattern: "hypothesis"
---

<objective>
Generate a comprehensive self-audit test suite for all critical Python modules: parsers, extractors, normalizers, export, and schema. Include adversarial edge cases (null, empty, unicode, injection, huge inputs) and Hypothesis property-based tests for fuzzing.

Purpose: Find bugs by trying to break every function with hostile inputs. These tests act as a permanent regression safety net.
Output: 7 test files with 100+ tests total, all passing with pytest.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@pyproject.toml
@python-src/main.py
@python-src/parsers/pdf_parser.py
@python-src/parsers/docx_parser.py
@python-src/parsers/base.py
@python-src/extractors/contact.py
@python-src/extractors/education.py
@python-src/extractors/skills.py
@python-src/extractors/work_history.py
@python-src/extractors/sections.py
@python-src/normalizers/dates.py
@python-src/normalizers/text.py
@python-src/export/redaction.py
@python-src/export/blind_profile.py
@python-src/export/theme.py
@python-src/schema/cv_schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conftest.py and test parsers, normalizers, and schema</name>
  <files>
    python-src/tests/__init__.py
    python-src/tests/conftest.py
    python-src/tests/test_parsers.py
    python-src/tests/test_normalizers.py
    python-src/tests/test_schema.py
  </files>
  <action>
1. Create `python-src/tests/__init__.py` (empty).

2. Create `python-src/tests/conftest.py` with shared fixtures:
   - `sample_cv_text`: Multi-paragraph realistic CV text with contact info, work history, education, skills
   - `edge_case_strings`: List of adversarial strings (None, "", " ", "\n", "\x00", "\ufeff", "a"*100000, XSS payloads, SQL injection, path traversal, Windows reserved names, lone surrogates)
   - `sample_contact_block`: Text block with name, phone, email, address
   - `tmp_pdf_path`: Creates a minimal valid PDF file in tmp for parser testing (use reportlab or just write raw PDF bytes)
   - Add `sys.path.insert(0, ...)` to ensure python-src is importable

3. Create `python-src/tests/test_parsers.py`:
   - Test PDF parser with valid PDF (use tmp fixture)
   - Test PDF parser with empty file (should not crash)
   - Test PDF parser with non-PDF file (text file renamed to .pdf)
   - Test PDF parser with None/missing path
   - Test DOCX parser with None/missing path
   - Test base parser interface
   - 20+ tests targeting parser resilience

4. Create `python-src/tests/test_normalizers.py`:
   - Test date normalizer with valid dates ("Jan 2020", "01/2020", "2020-01-01", "January 2020")
   - Test date normalizer with British format (3/2/2020 = 3rd Feb)
   - Test date normalizer with "Present", "Current", "Ongoing"
   - Test date normalizer with garbage input ("not a date", "", None)
   - Test text normalizer with unicode, whitespace, special chars
   - Test text normalizer with empty/None
   - 20+ tests

5. Create `python-src/tests/test_schema.py`:
   - Test CV schema validation with valid data
   - Test CV schema with missing required fields
   - Test CV schema with wrong types
   - Test CV schema with empty arrays
   - 10+ tests

Run `cd python-src && python -m pytest tests/ -v` to verify all pass.
  </action>
  <verify>
    - `cd python-src && python -m pytest tests/test_parsers.py tests/test_normalizers.py tests/test_schema.py -v` all pass
    - Each test file has 10+ test functions
  </verify>
  <done>Parser tests cover valid/invalid/missing/corrupt inputs. Normalizer tests cover all date formats and edge cases. Schema tests validate structure. All pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create extractor, export, and edge case fuzz tests</name>
  <files>
    python-src/tests/test_extractors.py
    python-src/tests/test_export.py
    python-src/tests/test_edge_cases.py
  </files>
  <action>
1. Create `python-src/tests/test_extractors.py`:
   - Test contact extractor: valid email, phone, name, address
   - Test contact extractor: missing fields (no email, no phone)
   - Test contact extractor: multiple emails/phones (should pick best)
   - Test contact extractor: international phone formats
   - Test contact extractor: empty/None text
   - Test education extractor: standard degree formats
   - Test education extractor: no education section
   - Test skills extractor: comma-separated, bullet-pointed, grouped
   - Test skills extractor: empty/None text
   - Test work history extractor: standard format with dates
   - Test work history extractor: missing dates, missing company
   - Test sections extractor: standard CV headings
   - 25+ tests targeting extraction accuracy and resilience

2. Create `python-src/tests/test_export.py`:
   - Test redaction: removes contact fields from text
   - Test redaction modes: full, client, punt
   - Test redaction with missing/empty CV data
   - Test blind profile generation with valid data
   - Test blind profile with minimal data (only name)
   - Test theme loading with valid/invalid theme JSON
   - Test output filename generation (name-based, fallback to "Candidate")
   - 15+ tests

3. Create `python-src/tests/test_edge_cases.py`:
   - Import `edge_case_strings` from conftest
   - Parametrized test: every extractor function handles every edge case string without crashing
   - Parametrized test: every normalizer function handles every edge case string without crashing
   - Hypothesis property-based test: `@given(st.text(min_size=0, max_size=10000))` for parser text input
   - Hypothesis property-based test: `@given(st.text())` for date normalizer
   - Hypothesis property-based test: `@given(st.text())` for text normalizer
   - Test with 100,000 character string (memory/performance boundary)
   - Test with binary data disguised as text
   - Test with SQL injection payloads in every field
   - Test with path traversal in filename fields
   - 30+ tests (parametrized expand to hundreds of cases)

Run full suite: `cd python-src && python -m pytest tests/ -v --tb=short`
Fix any bugs found (this is expected - the tests are designed to find bugs).
  </action>
  <verify>
    - `cd python-src && python -m pytest tests/ -v` all pass (after bug fixes)
    - `python -m pytest tests/ --co -q` shows 100+ test items (including parametrized)
    - `test_edge_cases.py` includes `from hypothesis import given, strategies`
  </verify>
  <done>Extractor tests cover all extraction modules with valid/invalid/edge inputs. Export tests cover redaction modes and blind profiles. Edge case corpus with 15+ adversarial strings parametrized across all functions. Hypothesis fuzz tests generate thousands of random inputs. All pass after bug fixes.</done>
</task>

</tasks>

<verification>
1. `cd python-src && python -m pytest tests/ -v` shows all tests passing
2. `python -m pytest tests/ --co -q | wc -l` shows 100+ test items
3. `grep -c "def test_" python-src/tests/*.py` shows 20+ per file
4. `grep "hypothesis" python-src/tests/test_edge_cases.py` confirms property-based tests
</verification>

<success_criteria>
- 100+ Python test cases across 7 files, all passing
- Edge case corpus: null, empty, negative, unicode, 100k strings, injection payloads
- Hypothesis property-based tests for parsers and normalizers
- Any bugs found during testing are FIXED (tests should pass, not be skipped)
</success_criteria>

<output>
After completion, create `.planning/phases/07-testing-and-bug-fixing-protocol/07-02-SUMMARY.md`
</output>
