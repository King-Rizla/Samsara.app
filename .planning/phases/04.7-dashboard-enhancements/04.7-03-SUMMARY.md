---
phase: 04.7-dashboard-enhancements
plan: 03
subsystem: ipc
tags: [electron, ipc, usage-tracking, settings, preload]

# Dependency graph
requires:
  - phase: 04.7-01
    provides: Database functions for usage tracking and project pinning
  - phase: 04.7-02
    provides: Python token_usage in extraction responses
provides:
  - IPC handlers for usage tracking (get-usage-stats)
  - IPC handlers for pinning (set-pinned-project, get-pinned-projects, reorder-pinned-projects)
  - IPC handlers for extended settings (get-app-settings, update-app-settings)
  - Usage recording in extract-cv and extract-jd handlers
  - Preload API exposure for all new handlers
affects: [04.7-04, 04.7-05]

# Tech tracking
tech-stack:
  added: []
  patterns: [Token usage capture from Python responses, Settings extension with usage limits]

key-files:
  created: []
  modified:
    - src/main/settings.ts
    - src/main/index.ts
    - src/main/preload.ts

key-decisions:
  - "Usage recorded with 'default-project' if no projectId provided"
  - "Token usage captured from Python response's token_usage field"
  - "Settings extended with globalTokenLimit and warningThreshold (80% default)"

patterns-established:
  - "Usage tracking: Capture token_usage from Python, call recordUsageEvent"
  - "Extended settings: Add fields to AppSettings, expose via get-app-settings/update-app-settings"

# Metrics
duration: 6min
completed: 2026-01-27
---

# Phase 4.7 Plan 03: IPC Handlers for Usage Tracking and Settings Summary

**Added IPC layer for usage tracking, project pinning, and extended settings - bridges Python token counts to SQLite and exposes usage data to renderer**

## Performance

- **Duration:** 6 min (371 seconds)
- **Started:** 2026-01-27T20:35:59Z
- **Completed:** 2026-01-27T20:42:10Z
- **Tasks:** 3
- **Files modified:** 3

## Accomplishments

- Extended AppSettings interface with globalTokenLimit and warningThreshold (80% default)
- Added usage recording to extract-cv handler (captures token_usage from Python)
- Added usage recording to extract-jd handler (captures token_usage from Python)
- Added 6 new IPC handlers:
  - get-usage-stats: Returns global and per-project token counts
  - set-pinned-project: Pin/unpin a project
  - get-pinned-projects: Get pinned projects sorted by pin_order
  - reorder-pinned-projects: Update pin order after drag-drop
  - get-app-settings: Get usage limits and settings
  - update-app-settings: Update settings (excluding API key)
- Exposed all new APIs in preload with proper TypeScript interfaces

## Task Commits

Each task was committed atomically:

1. **Task 1: Extend settings interface** - `45ffecf` (feat)
2. **Task 2: Add IPC handlers** - `1669a6d` (feat)
3. **Task 3: Expose APIs in preload** - `40ee758` (feat)

## Files Modified

- `src/main/settings.ts` - Added globalTokenLimit and warningThreshold to AppSettings
- `src/main/index.ts` - Imported database functions, added usage recording to extract handlers, added 6 new IPC handlers
- `src/main/preload.ts` - Added usage/settings type definitions, exposed 6 new API methods

## New Preload APIs

### Usage Tracking
1. `getUsageStats()` - Get current month token statistics (global + per-project)

### Project Pinning
2. `setPinnedProject(projectId, isPinned)` - Pin/unpin for sidebar quick-access
3. `getPinnedProjects()` - Get pinned projects in order
4. `reorderPinnedProjects(projectIds)` - Reorder after drag-drop

### Extended Settings
5. `getAppSettings()` - Get settings including usage limits
6. `updateAppSettings(updates)` - Update settings (globalTokenLimit, warningThreshold)

## Decisions Made

- Usage recorded with 'default-project' if no projectId provided (ensures all usage is tracked)
- Token usage captured from Python response's token_usage field (matches 04.7-02 schema)
- warningThreshold defaults to 80 (warn at 80% of limit per CONTEXT.md)
- API key not exposed via get-app-settings (security: only hasApiKey boolean)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- IPC layer complete for usage tracking and pinning
- Preload APIs ready for UI components (04.7-04)
- Settings ready for usage limits UI (04.7-05)
- No blockers

---
*Phase: 04.7-dashboard-enhancements*
*Completed: 2026-01-27*
