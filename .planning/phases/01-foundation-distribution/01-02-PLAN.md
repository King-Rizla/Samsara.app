---
phase: 01-foundation-distribution
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - python-src/main.py
  - python-src/requirements.txt
  - python-src/samsara.spec
  - scripts/build-python.ps1
  - scripts/build-python.sh
autonomous: true

must_haves:
  truths:
    - "Python sidecar loads spaCy en_core_web_sm model on startup"
    - "Sidecar responds to health_check action via stdin/stdout JSON"
    - "PyInstaller builds --onedir bundle without missing imports"
    - "Bundled executable runs standalone without Python installed"
  artifacts:
    - path: "python-src/main.py"
      provides: "Python sidecar entry point"
      contains: "spacy.load"
    - path: "python-src/requirements.txt"
      provides: "Python dependencies"
      contains: "spacy"
    - path: "python-src/samsara.spec"
      provides: "PyInstaller spec with spaCy hooks"
      contains: "hiddenimports"
    - path: "scripts/build-python.ps1"
      provides: "Windows build script"
      contains: "pyinstaller"
  key_links:
    - from: "python-src/main.py"
      to: "en_core_web_sm"
      via: "spacy.load"
      pattern: "spacy\\.load.*en_core_web_sm"
    - from: "python-src/samsara.spec"
      to: "spacy hidden imports"
      via: "hiddenimports list"
      pattern: "srsly\\.msgpack\\.util"
---

<objective>
Create the Python sidecar with spaCy model loading and PyInstaller bundling.

Purpose: Proves that spaCy can be bundled with PyInstaller --onedir and loads within acceptable time. This is the highest-risk technical component that must work before any features are built.
Output: Standalone Python executable that loads spaCy and responds to JSON commands via stdio.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-distribution/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Python sidecar with spaCy and stdio JSON protocol</name>
  <files>
    python-src/main.py
    python-src/requirements.txt
  </files>
  <action>
    1. Create python-src/ directory in project root

    2. Create python-src/requirements.txt:
       ```
       spacy==3.8.11
       pyinstaller==6.18.0
       ```

    3. Create python-src/main.py with:
       - Imports: sys, json, spacy
       - At module level (before main loop):
         - Print status message: `{"status": "loading_model"}`
         - Load spaCy model: `nlp = spacy.load("en_core_web_sm", disable=["parser", "lemmatizer"])`
         - Print status message: `{"status": "model_loaded"}`

       - Create handle_request(request) function that:
         - Extracts 'action' and 'id' from request
         - For action='health_check': returns success response with status='healthy' and model='en_core_web_sm'
         - For action='shutdown': prints goodbye message and calls sys.exit(0)
         - For unknown actions: returns error response

       - Main loop (for line in sys.stdin):
         - Parse JSON from line
         - Call handle_request
         - Print JSON response with flush=True
         - Wrap in try/except for JSONDecodeError and general exceptions

    Reference the Python code example in 01-RESEARCH.md for exact format.

    4. Set up Python virtual environment and install dependencies:
       ```bash
       cd python-src
       python -m venv venv
       venv\Scripts\activate  # Windows
       pip install -r requirements.txt
       python -m spacy download en_core_web_sm
       ```
  </action>
  <verify>
    Test the Python sidecar directly:
    ```bash
    cd python-src
    echo '{"action": "health_check", "id": "test-1"}' | python main.py
    ```
    Should output JSON with status "loading_model", "model_loaded", then health check response.
  </verify>
  <done>
    Python sidecar loads spaCy model and responds to health_check via stdin/stdout JSON protocol.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PyInstaller spec file with spaCy hidden imports</name>
  <files>
    python-src/samsara.spec
  </files>
  <action>
    Create python-src/samsara.spec with the following structure (based on 01-RESEARCH.md):

    1. Import statements:
       ```python
       # -*- mode: python ; coding: utf-8 -*-
       import spacy
       import en_core_web_sm
       from PyInstaller.utils.hooks import collect_data_files, collect_submodules
       ```

    2. Get paths:
       ```python
       spacy_path = spacy.__path__[0]
       model_path = en_core_web_sm.__path__[0]
       ```

    3. Analysis block with:
       - scripts: ['main.py']
       - datas: [(spacy_path, 'spacy'), (model_path, 'en_core_web_sm')]
       - hiddenimports: Full list from research:
         - 'srsly.msgpack.util'
         - 'cymem', 'cymem.cymem'
         - 'preshed.maps'
         - 'thinc.backends.linalg'
         - 'blis'
         - 'spacy.lang.en'
         - 'spacy_legacy'
       - Extend hiddenimports with collect_submodules for: thinc, blis, spacy, spacy_legacy

    4. Collect additional data:
       ```python
       a.datas += collect_data_files('thinc')
       a.datas += collect_data_files('spacy')
       a.datas += collect_data_files('en_core_web_sm')
       ```

    5. PYZ, EXE, COLLECT blocks:
       - name='samsara-backend'
       - console=True (for debugging; can change later)
       - upx=False (UPX causes issues with spaCy)
       - strip=False

    CRITICAL: Use --onedir mode (via COLLECT block), NOT --onefile. This is required for acceptable startup time.
  </action>
  <verify>
    Verify spec file has all required hidden imports by checking the file contents.
    The actual build test is in Task 3.
  </verify>
  <done>
    PyInstaller spec file created with all spaCy hidden imports and data collection.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create build scripts and verify PyInstaller bundle</name>
  <files>
    scripts/build-python.ps1
    scripts/build-python.sh
  </files>
  <action>
    1. Create scripts/ directory in project root

    2. Create scripts/build-python.ps1 (Windows):
       ```powershell
       # Build Python sidecar with PyInstaller
       $ErrorActionPreference = "Stop"

       Push-Location $PSScriptRoot\..\python-src

       # Ensure virtual environment is activated
       if (-not (Test-Path "venv")) {
           Write-Host "Creating virtual environment..."
           python -m venv venv
       }

       .\venv\Scripts\Activate.ps1

       # Install dependencies if needed
       pip install -r requirements.txt
       python -m spacy download en_core_web_sm

       # Build with PyInstaller
       Write-Host "Building Python sidecar..."
       pyinstaller --clean samsara.spec

       # Move output to python-dist
       $distPath = "..\python-dist"
       if (Test-Path $distPath) {
           Remove-Item -Recurse -Force $distPath
       }
       Move-Item -Path "dist\samsara-backend" -Destination $distPath

       # Cleanup
       Remove-Item -Recurse -Force "dist" -ErrorAction SilentlyContinue
       Remove-Item -Recurse -Force "build" -ErrorAction SilentlyContinue

       Pop-Location

       Write-Host "Build complete! Output in python-dist/"
       ```

    3. Create scripts/build-python.sh (macOS/Linux):
       ```bash
       #!/bin/bash
       set -e

       cd "$(dirname "$0")/../python-src"

       # Ensure virtual environment
       if [ ! -d "venv" ]; then
           echo "Creating virtual environment..."
           python3 -m venv venv
       fi

       source venv/bin/activate

       # Install dependencies
       pip install -r requirements.txt
       python -m spacy download en_core_web_sm

       # Build
       echo "Building Python sidecar..."
       pyinstaller --clean samsara.spec

       # Move output
       rm -rf ../python-dist
       mv dist/samsara-backend ../python-dist

       # Cleanup
       rm -rf dist build

       echo "Build complete! Output in python-dist/"
       ```

    4. Run the Windows build script:
       ```powershell
       .\scripts\build-python.ps1
       ```

    5. Test the bundled executable:
       ```powershell
       echo '{"action": "health_check", "id": "test-1"}' | .\python-dist\samsara-backend.exe
       ```
  </action>
  <verify>
    1. python-dist/samsara-backend/ directory exists with samsara-backend.exe
    2. Running the health check command returns valid JSON response
    3. No "missing module" errors during model loading
    4. Startup time (from launch to health check response) is under 10 seconds
  </verify>
  <done>
    PyInstaller bundle created successfully. Standalone executable loads spaCy model and responds to health check without requiring Python installation.
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify the Phase 1 Plan 02 success criteria:

1. **spaCy loads**: Run bundled executable, see "loading_model" then "model_loaded" status
2. **Health check works**: Send health_check action, receive success response
3. **No missing imports**: No ModuleNotFoundError during startup or health check
4. **Startup time**: Measure time from executable start to health check response (target: <10s)
5. **Standalone operation**: Test on a machine without Python installed (or in a clean VM)

Measure bundle size:
```powershell
(Get-ChildItem -Recurse python-dist | Measure-Object -Property Length -Sum).Sum / 1MB
```
Note the size for future optimization decisions.
</verification>

<success_criteria>
- python-dist/samsara-backend/samsara-backend.exe exists and runs
- Health check returns `{"id": "...", "success": true, "data": {"status": "healthy", "model": "en_core_web_sm"}}`
- No Python import errors (especially srsly.msgpack.util, cymem, preshed)
- Model loads and health check completes within 10 seconds of executable start
- Bundle size documented (expected: 100-200MB)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-distribution/01-02-SUMMARY.md`
</output>
