---
phase: 07-testing-and-bug-fixing-protocol
plan: 04
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - python-src/**/*.py
  - src/main/*.ts
autonomous: false

must_haves:
  truths:
    - "Ruff security scan (Bandit rules) passes with no high-severity findings"
    - "Gitleaks secret scan passes with no secrets in codebase"
    - "mypy type check runs without blocking errors"
    - "All identified security bugs are fixed"
    - "tsc --noEmit passes"
  artifacts:
    - path: "CLAUDE.md"
      provides: "Updated session gate (verified working)"
      contains: "Mandatory Pre-Completion Checks"
  key_links:
    - from: "CLAUDE.md"
      to: "all source files"
      via: "checklist enforcement"
      pattern: "Pre-Completion Checks"
---

<objective>
Run the full security audit: ruff with Bandit rules on Python, gitleaks secret scan on entire repo, mypy type check, tsc type check, and eslint. Fix all identified security vulnerabilities, input validation gaps, and type errors. Verify the complete quality gate chain works end-to-end.

Purpose: Close all security gaps and verify the automated safety net catches real issues.
Output: Clean scan results, all bugs fixed, quality gate verified.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/07-testing-and-bug-fixing-protocol/07-01-SUMMARY.md
@.planning/phases/07-testing-and-bug-fixing-protocol/07-02-SUMMARY.md
@.planning/phases/07-testing-and-bug-fixing-protocol/07-03-SUMMARY.md
@CLAUDE.md
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run security audit and fix all findings</name>
  <files>
    python-src/**/*.py
    src/main/*.ts
  </files>
  <action>
1. Run ruff security scan:
   ```bash
   cd python-src && python -m ruff check . --select S --output-format=full
   ```
   Fix all findings:
   - S101: assert usage (only in tests, already allowed via per-file-ignores)
   - S105/S106: hardcoded passwords/secrets
   - S108: temp file usage without secure permissions
   - S301: pickle usage (deserialization vulnerability)
   - S602/S603: subprocess shell=True
   - S608: SQL injection via string formatting
   - Any other Bandit security rule violations

2. Run gitleaks secret scan:
   ```bash
   gitleaks detect --source . --no-git -v
   ```
   If gitleaks is not installed, use: `pip install gitleaks` or scan manually for:
   - API keys in code/comments (grep for common patterns: sk-, pk-, api_key, secret, password, token)
   - Hardcoded credentials in config files
   - Tokens in error messages or logs
   Fix all real findings. Add false positives to `.gitleaks.toml` allowlist.

3. Run mypy:
   ```bash
   cd python-src && python -m mypy . --ignore-missing-imports --check-untyped-defs
   ```
   Fix blocking errors. For existing untyped code, add minimal type annotations where mypy reports actual bugs (wrong types being passed). Do NOT add full strict typing - just fix real type bugs.

4. Run tsc:
   ```bash
   npx tsc --noEmit
   ```
   Fix any type errors found.

5. Run eslint:
   ```bash
   npx eslint src/ --ext .ts,.tsx
   ```
   Fix lint errors.

6. Run full test suites to verify fixes don't break anything:
   ```bash
   npx vitest run
   cd python-src && python -m pytest tests/ -v
   ```

7. Scan for common security anti-patterns manually:
   - `eval()` or `exec()` in Python code
   - `innerHTML` or `dangerouslySetInnerHTML` in React code
   - Raw SQL string concatenation (should use parameterized queries)
   - User-controlled file paths without sanitization
   - IPC handlers that don't validate input types
   Fix any findings.
  </action>
  <verify>
    - `cd python-src && python -m ruff check . --select S` reports 0 errors (or only allowed ones)
    - `npx tsc --noEmit` exits 0
    - `npx vitest run` all pass
    - `cd python-src && python -m pytest tests/ -v` all pass
  </verify>
  <done>Ruff security scan clean. No secrets in codebase. mypy runs without blocking errors. tsc passes. All tests still pass after fixes. Manual security patterns checked.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete quality gate chain: CLAUDE.md session checklist, pre-commit hooks (Husky + lint-staged), scanner stack (ruff/Bandit, mypy, gitleaks), 160+ unit tests (Python pytest + JS vitest), security audit with all findings fixed.</what-built>
  <how-to-verify>
    1. Run `git add -A && git stash` then `git stash pop` to verify pre-commit hooks don't block
    2. Review CLAUDE.md - does the 7-point checklist make sense for daily development?
    3. Run `npx vitest run` - all TypeScript tests pass?
    4. Run `cd python-src && python -m pytest tests/ -v` - all Python tests pass?
    5. Run `cd python-src && python -m ruff check . --select S` - clean security scan?
    6. Check `.husky/pre-commit` exists and contains lint-staged call
    7. Spot-check a few test files - do they test meaningful scenarios?
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. All scanners run clean (ruff, mypy, tsc, eslint, gitleaks)
2. All test suites pass (vitest + pytest)
3. Pre-commit hook triggers on staged file changes
4. CLAUDE.md checklist is complete and actionable
</verification>

<success_criteria>
- Zero high-severity security findings from ruff Bandit scan
- Zero secrets detected by gitleaks
- tsc and mypy pass without blocking errors
- All 160+ tests pass (Python + TypeScript combined)
- Security audit complete: no eval/exec, no raw SQL, no unsanitized paths
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/07-testing-and-bug-fixing-protocol/07-04-SUMMARY.md`
</output>
