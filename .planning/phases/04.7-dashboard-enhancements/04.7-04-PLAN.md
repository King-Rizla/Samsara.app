---
phase: 04.7-dashboard-enhancements
plan: 04
type: execute
wave: 2
depends_on: ["04.7-01"]
files_modified:
  - package.json
  - src/renderer/App.tsx
  - src/renderer/components/sidebar/AppSidebar.tsx
  - src/renderer/components/dashboard/ProjectCard.tsx
autonomous: true

must_haves:
  truths:
    - "Project cards are draggable from dashboard with ghost preview"
    - "Sidebar has a drop zone that accepts dragged projects with highlight feedback"
    - "Dragged project gets pinned to sidebar on drop"
    - "Pinned projects in sidebar can be reordered via drag-drop"
    - "Two unpin methods: X button on hover AND drag project out of sidebar"
    - "DragOverlay renders project preview outside DOM hierarchy"
  artifacts:
    - path: "package.json"
      provides: "@dnd-kit libraries installed (core + sortable + utilities)"
      contains: "@dnd-kit/core"
    - path: "src/renderer/App.tsx"
      provides: "DndContext wrapping routes"
      contains: "DndContext"
    - path: "src/renderer/components/sidebar/AppSidebar.tsx"
      provides: "Sidebar drop zone and sortable pinned projects list"
      contains: "useDroppable"
  key_links:
    - from: "src/renderer/App.tsx"
      to: "src/renderer/components/sidebar/AppSidebar.tsx"
      via: "DndContext onDragEnd handler"
      pattern: "onDragEnd"
---

<objective>
Install @dnd-kit and implement drag-drop infrastructure for pinning projects to sidebar with reordering and two unpin methods.

Purpose: Enables quick-access workflow where users drag frequently-used projects to sidebar, reorder them, and unpin via X button or drag-back.
Output: Draggable project cards, sidebar drop zone, sortable pinned projects list with unpin controls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.7-dashboard-enhancements/04.7-RESEARCH.md
@.planning/phases/04.7-dashboard-enhancements/04.7-CONTEXT.md
@.planning/phases/04.7-dashboard-enhancements/04.7-01-SUMMARY.md
@src/renderer/App.tsx
@src/renderer/components/sidebar/AppSidebar.tsx
@src/renderer/components/dashboard/ProjectCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @dnd-kit libraries</name>
  <files>package.json</files>
  <action>
    Run npm install to add @dnd-kit packages (need sortable for reordering pinned projects):
    ```bash
    npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
    ```

    After installation, verify package.json includes:
    - @dnd-kit/core: ^6.x
    - @dnd-kit/sortable: ^8.x
    - @dnd-kit/utilities: ^3.x
  </action>
  <verify>npm list @dnd-kit/core @dnd-kit/sortable shows versions installed</verify>
  <done>@dnd-kit libraries installed</done>
</task>

<task type="auto">
  <name>Task 2: Make ProjectCard draggable</name>
  <files>src/renderer/components/dashboard/ProjectCard.tsx</files>
  <action>
    Import useDraggable from @dnd-kit/core:
    ```typescript
    import { useDraggable } from '@dnd-kit/core';
    import { CSS } from '@dnd-kit/utilities';
    ```

    Modify the ProjectCard component to be draggable:

    1. Add useDraggable hook inside component:
    ```typescript
    const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
      id: `project-${project.id}`,
      data: { type: 'project', project },
    });
    ```

    2. Create style object for transform:
    ```typescript
    const style: React.CSSProperties = {
      transform: CSS.Translate.toString(transform),
      opacity: isDragging ? 0.5 : 1,
      cursor: isDragging ? 'grabbing' : 'grab',
    };
    ```

    3. Apply to the Card element:
    - Add ref={setNodeRef}
    - Add style={style}
    - Add {...attributes} to Card
    - Add {...listeners} to the main draggable area (NOT on dropdown menu trigger)

    The structure should look like:
    ```tsx
    <Card
      ref={setNodeRef}
      style={style}
      className="..."
      {...attributes}
    >
      <CardHeader className="..." {...listeners}>
        {/* Header content - this is the drag handle */}
        <div className="space-y-1">
          <CardTitle>...</CardTitle>
          <CardDescription>...</CardDescription>
        </div>
        {/* Dropdown menu should NOT have listeners - stop propagation */}
        <DropdownMenu>
          <DropdownMenuTrigger onClick={(e) => e.stopPropagation()} onPointerDown={(e) => e.stopPropagation()}>
            ...
          </DropdownMenuTrigger>
          ...
        </DropdownMenu>
      </CardHeader>
      {/* Card content - also draggable area */}
      <CardContent {...listeners} onClick={() => !isDragging && navigate(`/project/${project.id}`)}>
        ...
      </CardContent>
    </Card>
    ```

    Note: Keep the onClick for navigation - add isDragging check to prevent navigation during drag.
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>ProjectCard is draggable with proper event handling</done>
</task>

<task type="auto">
  <name>Task 3: Add drop zone and sortable pinned projects to sidebar</name>
  <files>src/renderer/components/sidebar/AppSidebar.tsx</files>
  <action>
    Import required hooks and components:
    ```typescript
    import { useDroppable } from '@dnd-kit/core';
    import { SortableContext, useSortable, verticalListSortingStrategy } from '@dnd-kit/sortable';
    import { CSS } from '@dnd-kit/utilities';
    import { FolderOpen, Pin, X } from 'lucide-react';
    import { SidebarGroupLabel } from '../ui/sidebar';
    ```

    Accept props from App.tsx for state management:
    ```typescript
    interface AppSidebarProps {
      pinnedProjects?: Array<{ id: string; name: string }>;
      onUnpin?: (projectId: string) => void;
    }

    export function AppSidebar({ pinnedProjects = [], onUnpin }: AppSidebarProps) {
    ```

    Create a SortablePinnedProject component for reorderable items:
    ```typescript
    function SortablePinnedProject({
      project,
      onUnpin,
    }: {
      project: { id: string; name: string };
      onUnpin?: (id: string) => void;
    }) {
      const navigate = useNavigate();
      const {
        attributes,
        listeners,
        setNodeRef,
        transform,
        transition,
        isDragging,
      } = useSortable({
        id: `pinned-${project.id}`,
        data: { type: 'pinned-project', project },
      });

      const style: React.CSSProperties = {
        transform: CSS.Transform.toString(transform),
        transition,
        opacity: isDragging ? 0.5 : 1,
      };

      return (
        <SidebarMenuItem ref={setNodeRef} style={style}>
          <SidebarMenuButton
            {...attributes}
            {...listeners}
            onClick={() => navigate(`/project/${project.id}`)}
            tooltip={project.name}
            className="group"
          >
            <FolderOpen className="h-4 w-4" />
            <span className="truncate flex-1">{project.name}</span>
            {/* X button to unpin - visible on hover */}
            <button
              onClick={(e) => {
                e.stopPropagation();
                onUnpin?.(project.id);
              }}
              onPointerDown={(e) => e.stopPropagation()}
              className="opacity-0 group-hover:opacity-100 p-1 hover:bg-destructive/20 rounded transition-opacity"
              title="Unpin project"
            >
              <X className="h-3 w-3" />
            </button>
          </SidebarMenuButton>
        </SidebarMenuItem>
      );
    }
    ```

    Create a SidebarDropZone component for accepting new pins:
    ```typescript
    function SidebarDropZone({ isOver }: { isOver: boolean }) {
      return (
        <div
          className={`
            mx-2 my-1 p-2 rounded-md border-2 border-dashed
            text-xs text-muted-foreground text-center
            transition-colors
            ${isOver ? 'border-primary bg-primary/10' : 'border-border'}
          `}
        >
          <Pin className="h-4 w-4 mx-auto mb-1" />
          Drop to pin
        </div>
      );
    }
    ```

    Update AppSidebar to use useDroppable for the Quick Access section:
    ```typescript
    const { setNodeRef, isOver } = useDroppable({ id: 'sidebar-quick-access' });
    ```

    Add to the sidebar structure (after the Dashboard nav item, before SidebarFooter):
    ```tsx
    <SidebarGroup>
      <SidebarGroupLabel className="text-xs text-muted-foreground">
        Quick Access
      </SidebarGroupLabel>
      <SidebarGroupContent ref={setNodeRef}>
        <SortableContext
          items={pinnedProjects.map(p => `pinned-${p.id}`)}
          strategy={verticalListSortingStrategy}
        >
          <SidebarMenu>
            {pinnedProjects.map((project) => (
              <SortablePinnedProject
                key={project.id}
                project={project}
                onUnpin={onUnpin}
              />
            ))}
          </SidebarMenu>
        </SortableContext>
        <SidebarDropZone isOver={isOver} />
      </SidebarGroupContent>
    </SidebarGroup>
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>Sidebar has Quick Access section with sortable pinned projects, drop zone, and X button unpin</done>
</task>

<task type="auto">
  <name>Task 4: Add DndContext to App.tsx with full drag-drop handling</name>
  <files>src/renderer/App.tsx</files>
  <action>
    Import DndContext and related utilities:
    ```typescript
    import {
      DndContext,
      DragOverlay,
      DragStartEvent,
      DragEndEvent,
      DragOverEvent,
      PointerSensor,
      useSensor,
      useSensors,
      closestCenter,
    } from '@dnd-kit/core';
    import { arrayMove } from '@dnd-kit/sortable';
    import { useState, useEffect, useCallback } from 'react';
    ```

    Add state for drag and pinned projects:
    ```typescript
    const [activeProject, setActiveProject] = useState<{ id: string; name: string } | null>(null);
    const [pinnedProjects, setPinnedProjects] = useState<Array<{ id: string; name: string }>>([]);
    ```

    Add sensors configuration (with distance constraint to prevent accidental drags):
    ```typescript
    const sensors = useSensors(
      useSensor(PointerSensor, {
        activationConstraint: {
          distance: 8, // 8px movement required to start drag
        },
      })
    );
    ```

    Add useEffect to load pinned projects:
    ```typescript
    const loadPinnedProjects = useCallback(async () => {
      const result = await window.api.getPinnedProjects();
      if (result.success && result.data) {
        setPinnedProjects(result.data.map(p => ({ id: p.id, name: p.name })));
      }
    }, []);

    useEffect(() => {
      loadPinnedProjects();
    }, [loadPinnedProjects]);
    ```

    Add drag handlers:
    ```typescript
    const handleDragStart = (event: DragStartEvent) => {
      const data = event.active.data.current;
      if (data?.type === 'project' || data?.type === 'pinned-project') {
        setActiveProject({
          id: data.project.id,
          name: data.project.name,
        });
      }
    };

    const handleDragEnd = async (event: DragEndEvent) => {
      const { active, over } = event;
      setActiveProject(null);

      const activeData = active.data.current;

      // Case 1: Dropping unpinned project onto sidebar drop zone
      if (over?.id === 'sidebar-quick-access' && activeData?.type === 'project') {
        const project = activeData.project;
        if (!pinnedProjects.some(p => p.id === project.id)) {
          const result = await window.api.setPinnedProject(project.id, true);
          if (result.success) {
            setPinnedProjects(prev => [...prev, { id: project.id, name: project.name }]);
          }
        }
        return;
      }

      // Case 2: Reordering pinned projects within sidebar
      if (activeData?.type === 'pinned-project' && over) {
        const activeId = active.id.toString().replace('pinned-', '');
        const overId = over.id.toString().replace('pinned-', '');

        if (activeId !== overId && overId !== 'sidebar-quick-access') {
          const oldIndex = pinnedProjects.findIndex(p => p.id === activeId);
          const newIndex = pinnedProjects.findIndex(p => p.id === overId);

          if (oldIndex !== -1 && newIndex !== -1) {
            const newOrder = arrayMove(pinnedProjects, oldIndex, newIndex);
            setPinnedProjects(newOrder);
            // Persist new order
            await window.api.reorderPinnedProjects(newOrder.map(p => p.id));
          }
        }
      }

      // Case 3: Dragging pinned project OUT of sidebar (unpin via drag-back)
      // If dropped anywhere that's not the sidebar or another pinned item, unpin it
      if (activeData?.type === 'pinned-project' && over?.id !== 'sidebar-quick-access') {
        const overId = over?.id?.toString() || '';
        const isOverPinnedItem = overId.startsWith('pinned-');
        if (!isOverPinnedItem) {
          const projectId = activeData.project.id;
          const result = await window.api.setPinnedProject(projectId, false);
          if (result.success) {
            setPinnedProjects(prev => prev.filter(p => p.id !== projectId));
          }
        }
      }
    };

    // Handle unpin via X button
    const handleUnpin = async (projectId: string) => {
      const result = await window.api.setPinnedProject(projectId, false);
      if (result.success) {
        setPinnedProjects(prev => prev.filter(p => p.id !== projectId));
      }
    };
    ```

    Wrap the existing JSX with DndContext:
    ```tsx
    return (
      <DndContext
        sensors={sensors}
        collisionDetection={closestCenter}
        onDragStart={handleDragStart}
        onDragEnd={handleDragEnd}
      >
        <MemoryRouter initialEntries={['/']}>
          <TooltipProvider>
            <SidebarProvider>
              <div className="flex h-screen w-full bg-background">
                <AppSidebar
                  pinnedProjects={pinnedProjects}
                  onUnpin={handleUnpin}
                />
                <SidebarInset className="flex flex-col flex-1 overflow-hidden">
                  {/* ... existing content ... */}
                </SidebarInset>
              </div>
            </SidebarProvider>
          </TooltipProvider>
        </MemoryRouter>

        {/* DragOverlay renders outside normal DOM for z-index (per Research pitfall #1) */}
        <DragOverlay>
          {activeProject ? (
            <div className="bg-card border border-primary rounded-md p-3 shadow-lg opacity-90 min-w-[150px]">
              <div className="flex items-center gap-2">
                <FolderOpen className="h-4 w-4 text-primary" />
                <span className="font-medium truncate">{activeProject.name}</span>
              </div>
            </div>
          ) : null}
        </DragOverlay>
      </DndContext>
    );
    ```

    Import FolderOpen icon at top:
    ```typescript
    import { FolderOpen } from 'lucide-react';
    ```

    Pass pinnedProjects and onUnpin props to AppSidebar.
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>DndContext wraps app with full pin/unpin/reorder drag-drop handling</done>
</task>

</tasks>

<verification>
After all tasks:
1. Run `npm run lint --quiet` - no errors
2. Run `npm run build` - builds successfully
3. Manual test: Start app, drag a project card toward sidebar, see drop zone highlight
4. Manual test: Drop on sidebar, project appears in Quick Access section
5. Manual test: Hover pinned project, click X to unpin
6. Manual test: Drag pinned project out of sidebar to unpin
7. Manual test: Drag pinned project to reorder within sidebar
</verification>

<success_criteria>
- @dnd-kit/core, @dnd-kit/sortable, and @dnd-kit/utilities installed
- Project cards are draggable (with 8px activation distance)
- Sidebar shows "Quick Access" section with drop zone
- Dropping project on sidebar pins it and adds to list
- Pinned projects can be reordered by dragging within sidebar
- Two unpin methods work: X button on hover, drag project out of sidebar
- DragOverlay shows ghost preview during drag (no z-index/clipping issues)
</success_criteria>

<output>
After completion, create `.planning/phases/04.7-dashboard-enhancements/04.7-04-SUMMARY.md`
</output>
