---
phase: 01-foundation-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - forge.config.ts
  - vite.main.config.ts
  - vite.preload.config.ts
  - vite.renderer.config.ts
  - tsconfig.json
  - src/main/index.ts
  - src/main/preload.ts
  - src/main/database.ts
  - src/renderer/index.html
  - src/renderer/renderer.ts
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Electron window opens and displays a basic UI"
    - "Renderer can send message to main process and receive response via IPC"
    - "SQLite database file exists in userData directory with WAL mode"
    - "App runs in development mode with hot reload"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies and scripts"
      contains: "electron"
    - path: "forge.config.ts"
      provides: "Electron Forge build configuration"
      contains: "VitePlugin"
    - path: "src/main/index.ts"
      provides: "Main process entry point"
      exports: ["createWindow"]
    - path: "src/main/preload.ts"
      provides: "Context bridge for IPC"
      contains: "contextBridge"
    - path: "src/main/database.ts"
      provides: "SQLite database wrapper"
      contains: "WAL"
    - path: "src/renderer/index.html"
      provides: "Renderer entry HTML"
      min_lines: 10
  key_links:
    - from: "src/main/index.ts"
      to: "src/main/preload.ts"
      via: "webPreferences.preload"
      pattern: "preload.*preload"
    - from: "src/main/index.ts"
      to: "src/main/database.ts"
      via: "import"
      pattern: "import.*database"
    - from: "src/renderer/renderer.ts"
      to: "window.electronAPI"
      via: "contextBridge exposure"
      pattern: "electronAPI"
---

<objective>
Create the Electron shell with Forge/Vite toolchain, basic IPC infrastructure, and SQLite database initialization.

Purpose: Establishes the desktop app foundation that will host the Python sidecar in Plan 01-02.
Output: Working Electron app with dev mode, IPC bridge, and database ready for sidecar integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-distribution/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Electron Forge project with Vite template</name>
  <files>
    package.json
    forge.config.ts
    vite.main.config.ts
    vite.preload.config.ts
    vite.renderer.config.ts
    tsconfig.json
    .gitignore
  </files>
  <action>
    Initialize Electron Forge project using the Vite TypeScript template:

    1. Run `npm init electron-app@latest . -- --template=vite-typescript` in the project root (Samsara directory)
       - If prompted about existing files, proceed (only .planning exists)

    2. Install additional dependencies:
       - `npm install better-sqlite3 python-shell`
       - `npm install -D electron-rebuild @electron-forge/maker-nsis @types/better-sqlite3`

    3. Run `npx electron-rebuild` to rebuild better-sqlite3 for Electron

    4. Update forge.config.ts to add NSIS maker and extraResource for future Python sidecar:
       - Add MakerNSIS import and maker config
       - Add `extraResource: ['./python-dist/samsara-backend']` to packagerConfig (will exist after Plan 01-02)
       - Keep the VitePlugin as generated

    5. Update .gitignore to add:
       - `python-dist/`
       - `*.db`
       - `*.db-wal`
       - `*.db-shm`

    DO NOT modify the generated Vite configs unless necessary - they work out of the box.
  </action>
  <verify>
    Run `npm run start` - Electron window should open with default Forge template content.
    Run `npm run package` - should complete without errors (creates out/ directory).
  </verify>
  <done>
    Electron Forge project initialized with Vite template, all dependencies installed, electron-rebuild completed successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create main process with IPC and SQLite database</name>
  <files>
    src/main/index.ts
    src/main/preload.ts
    src/main/database.ts
  </files>
  <action>
    1. Create src/main/database.ts:
       - Import better-sqlite3 and electron app
       - Create database at `app.getPath('userData')/samsara.db`
       - Enable WAL mode with `db.pragma('journal_mode = WAL')`
       - Enable NORMAL synchronous mode: `db.pragma('synchronous = NORMAL')`
       - Create initial schema with app_meta table (key TEXT PRIMARY KEY, value TEXT)
       - Export db instance and dbPath

    2. Update src/main/index.ts:
       - Import database module (this initializes SQLite on startup)
       - Keep existing window creation logic from template
       - Add ipcMain handler for 'ping' channel that returns 'pong' (basic IPC test)
       - Add ipcMain handler for 'db-status' that returns { path: dbPath, walMode: true }
       - Log database path on startup

    3. Update src/main/preload.ts:
       - Use contextBridge to expose 'electronAPI' object to renderer
       - Expose `ping: () => ipcRenderer.invoke('ping')` method
       - Expose `getDbStatus: () => ipcRenderer.invoke('db-status')` method
       - Keep contextIsolation: true (security requirement)

    Reference the patterns in 01-RESEARCH.md for exact code structure.
  </action>
  <verify>
    Run `npm run start`:
    - Window opens
    - Check main process console for database path log
    - Verify samsara.db exists in userData folder
  </verify>
  <done>
    SQLite database initializes in userData with WAL mode. IPC handlers registered for ping and db-status.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create renderer UI with IPC test</name>
  <files>
    src/renderer/index.html
    src/renderer/renderer.ts
  </files>
  <action>
    1. Update src/renderer/index.html:
       - Set title to "Samsara"
       - Add a heading: "Samsara - Sovereign CV Formatter"
       - Add a div with id="status" for displaying connection status
       - Add a button with id="test-ipc" labeled "Test IPC"
       - Add a div with id="db-info" for displaying database info
       - Keep the script tag pointing to renderer.ts

    2. Update src/renderer/renderer.ts:
       - Add type declaration for window.electronAPI at top:
         ```typescript
         declare global {
           interface Window {
             electronAPI: {
               ping: () => Promise<string>;
               getDbStatus: () => Promise<{ path: string; walMode: boolean }>;
             };
           }
         }
         ```
       - On DOMContentLoaded:
         - Add click handler to test-ipc button
         - On click: call window.electronAPI.ping(), display result in #status
         - Call window.electronAPI.getDbStatus() and display path in #db-info
       - Show "Ready" in status div initially
  </action>
  <verify>
    Run `npm run start`:
    1. Window shows "Samsara - Sovereign CV Formatter" heading
    2. Click "Test IPC" button - status shows "pong"
    3. Database info section shows the path to samsara.db
  </verify>
  <done>
    Renderer displays UI, successfully calls main process via IPC, and shows database status.
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify the Phase 1 Plan 01 success criteria:

1. **Electron window opens**: `npm run start` opens window with Samsara heading
2. **IPC works**: Click "Test IPC" returns "pong" from main process
3. **SQLite with WAL**: Check userData folder for samsara.db, samsara.db-wal files
4. **Dev mode with HMR**: Modify renderer.ts, save, changes appear without restart
5. **Package builds**: `npm run package` completes, creates executable in out/ folder
</verification>

<success_criteria>
- `npm run start` opens Electron window displaying "Samsara - Sovereign CV Formatter"
- IPC ping/pong round-trip works from renderer to main
- samsara.db exists in app.getPath('userData') with WAL journal
- `npm run package` produces distributable in out/ directory
- No TypeScript errors, no console errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-distribution/01-01-SUMMARY.md`
</output>
