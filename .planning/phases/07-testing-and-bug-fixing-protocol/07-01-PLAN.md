---
phase: 07-testing-and-bug-fixing-protocol
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - CLAUDE.md
  - .husky/pre-commit
  - .lintstagedrc.json
  - pyproject.toml
  - .pre-commit-config.yaml
  - .gitleaks.toml
  - .semgrepignore
  - vitest.config.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Pre-commit hook blocks commits with lint errors or type errors"
    - "CLAUDE.md exists with 7-point mandatory checklist"
    - "Ruff with Bandit rules configured for Python security scanning"
    - "Gitleaks blocks commits containing secrets"
  artifacts:
    - path: "CLAUDE.md"
      provides: "Session gate with mandatory pre-completion checks"
      contains: "Mandatory Pre-Completion Checks"
    - path: ".husky/pre-commit"
      provides: "Dual-stack pre-commit hook"
      contains: "lint-staged"
    - path: "pyproject.toml"
      provides: "Ruff + mypy + pytest config"
      contains: "tool.ruff"
    - path: ".pre-commit-config.yaml"
      provides: "Semgrep, gitleaks, ruff hooks"
      contains: "gitleaks"
    - path: "vitest.config.ts"
      provides: "Vitest unit test configuration"
      contains: "defineConfig"
  key_links:
    - from: ".husky/pre-commit"
      to: ".lintstagedrc.json"
      via: "npx lint-staged invocation"
      pattern: "lint-staged"
    - from: ".husky/pre-commit"
      to: ".pre-commit-config.yaml"
      via: "pre-commit run invocation"
      pattern: "pre-commit run"
---

<objective>
Set up the complete quality gate infrastructure: CLAUDE.md session checklist, Husky 9 + lint-staged pre-commit hooks for JS/TS, Python pre-commit framework for semgrep/gitleaks/ruff, pyproject.toml with ruff+mypy+pytest config, and a standalone vitest.config.ts for unit tests.

Purpose: Establish the automated safety net that prevents vulnerable, untested, or untyped code from being committed.
Output: All config files, hooks installed and functional.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-testing-and-bug-fixing-protocol/07-RESEARCH.md
@package.json
@tsconfig.json
@python-src/requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLAUDE.md and configure pyproject.toml + vitest.config.ts</name>
  <files>
    CLAUDE.md
    pyproject.toml
    vitest.config.ts
  </files>
  <action>
1. Create `CLAUDE.md` in repo root with mandatory pre-completion checklist:
   - 7-point checklist: secrets scan, injection check, path traversal, input validation, tests pass, types check, lint clean
   - Include exact commands for each check (`npx vitest run`, `cd python-src && pytest`, `npx tsc --noEmit`, etc.)
   - Add project context section: Electron + Python sidecar, IPC bridge, SQLite, local-first

2. Create `pyproject.toml` in repo root with:
   - `[tool.ruff]`: target-version = "py312", line-length = 120, src = ["python-src"]
   - `[tool.ruff.lint]`: select = ["E", "W", "F", "I", "B", "S", "UP", "SIM"]
   - `[tool.ruff.lint.per-file-ignores]`: "python-src/tests/*" = ["S101"] (allow assert in tests)
   - `[tool.mypy]`: python_version = "3.12", check_untyped_defs = true, ignore_missing_imports = true, mypy_path = "python-src"
   - `[tool.pytest.ini_options]`: testpaths = ["python-src/tests"], python_files = "test_*.py"

3. Create `vitest.config.ts` in repo root:
   - Standalone config (do NOT extend Forge Vite configs)
   - environment: 'node' (testing main process code)
   - include: ['src/**/__tests__/**/*.test.ts']
   - coverage provider: 'v8', include main process files, exclude preload.ts
   - globals: true

IMPORTANT: Do NOT extend or import from forge vite configs (vite.main.config.ts, vite.renderer.config.ts). vitest.config.ts must be fully standalone.
  </action>
  <verify>
    - `CLAUDE.md` exists and contains "Mandatory Pre-Completion Checks"
    - `pyproject.toml` exists and contains [tool.ruff] and [tool.mypy] sections
    - `vitest.config.ts` exists and imports from 'vitest/config'
  </verify>
  <done>CLAUDE.md has 7-point checklist with exact commands. pyproject.toml configures ruff (with Bandit S rules), mypy, and pytest. vitest.config.ts is standalone and ready for unit tests.</done>
</task>

<task type="auto">
  <name>Task 2: Install and configure Husky 9 + lint-staged + pre-commit framework</name>
  <files>
    package.json
    .husky/pre-commit
    .lintstagedrc.json
    .pre-commit-config.yaml
    .gitleaks.toml
    .semgrepignore
  </files>
  <action>
1. Install JS dev dependencies:
   ```bash
   npm install --save-dev husky lint-staged @vitest/coverage-v8
   ```

2. Initialize Husky 9:
   ```bash
   npx husky init
   ```
   This creates `.husky/` directory and adds "prepare": "husky" to package.json scripts.

3. Create `.husky/pre-commit` hook script:
   ```bash
   npx lint-staged
   ```
   NOTE: Do NOT add `pre-commit run` for Python hooks yet. The Python pre-commit framework requires `pip install pre-commit` which is a dev dependency. Add a comment noting it can be enabled when pre-commit is installed. On Windows, semgrep hooks may have issues - keep it simple.

4. Create `.lintstagedrc.json`:
   ```json
   {
     "*.{ts,tsx}": ["eslint --fix"],
     "*.{ts,tsx,js,json,md}": ["prettier --write"]
   }
   ```
   NOTE: Do NOT include tsc in lint-staged (needs full project context). tsc runs separately.

5. Add scripts to package.json:
   - "test": "vitest run"
   - "test:watch": "vitest"
   - "test:coverage": "vitest run --coverage"
   - "typecheck": "tsc --noEmit"
   - "prepare": "husky" (should already be added by husky init)

6. Create `.pre-commit-config.yaml` for Python-side hooks:
   ```yaml
   repos:
     - repo: https://github.com/astral-sh/ruff-pre-commit
       rev: v0.9.6
       hooks:
         - id: ruff
           args: [--fix]
         - id: ruff-format
     - repo: https://github.com/gitleaks/gitleaks
       rev: v8.24.2
       hooks:
         - id: gitleaks
   ```
   NOTE: Omit semgrep from pre-commit hooks for now (Windows compatibility concern from research). Semgrep can be run manually or in CI.

7. Create `.gitleaks.toml`:
   - Allowlist test fixtures and example data paths
   - Allowlist `.planning/` directory (may contain example configs)

8. Create `.semgrepignore`:
   - Ignore node_modules/, .vite/, out/, dist/, python-dist/, python-build/
   - Ignore e2e/ (test code)

9. Install Python dev dependencies:
   ```bash
   cd python-src && pip install ruff mypy pytest pytest-cov hypothesis
   ```
   Add these to a `requirements-dev.txt` file in python-src/.

10. Run `npx husky` to verify hooks are installed. Run `npx lint-staged --diff="HEAD"` to verify lint-staged config parses correctly.
  </action>
  <verify>
    - `npx husky --version` prints version (Husky installed)
    - `.husky/pre-commit` exists and contains "lint-staged"
    - `cat .lintstagedrc.json` shows valid JSON
    - `.pre-commit-config.yaml` exists with ruff and gitleaks hooks
    - `.gitleaks.toml` exists
    - `package.json` contains "test", "typecheck", "prepare" scripts
    - `python-src/requirements-dev.txt` exists with ruff, mypy, pytest, hypothesis
  </verify>
  <done>Husky 9 pre-commit hook runs lint-staged on JS/TS files. Python pre-commit config has ruff and gitleaks hooks. Gitleaks allowlist prevents false positives. All dev dependencies installed for both ecosystems.</done>
</task>

</tasks>

<verification>
1. `cat CLAUDE.md` shows 7-point checklist
2. `npx tsc --noEmit` runs without config errors (vitest.config.ts is valid)
3. `git add test.txt && git commit -m "test"` triggers pre-commit hook (lint-staged runs)
4. `cd python-src && python -m ruff check .` runs with Bandit rules
5. `cd python-src && python -m mypy .` runs (may have errors, but executes)
</verification>

<success_criteria>
- CLAUDE.md exists with 7-point mandatory checklist
- Pre-commit hook triggers lint-staged on JS/TS staged files
- pyproject.toml configures ruff with security rules, mypy, pytest
- vitest.config.ts ready for unit tests (standalone, not extending Forge)
- All scanner tools installed and individually executable
</success_criteria>

<output>
After completion, create `.planning/phases/07-testing-and-bug-fixing-protocol/07-01-SUMMARY.md`
</output>
