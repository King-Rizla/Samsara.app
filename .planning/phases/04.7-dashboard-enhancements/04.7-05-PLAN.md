---
phase: 04.7-dashboard-enhancements
plan: 05
type: execute
wave: 3
depends_on: ["04.7-03", "04.7-04"]
files_modified:
  - package.json
  - src/renderer/styles/globals.css
  - src/renderer/stores/usageStore.ts
  - src/renderer/components/dashboard/StatsStrip.tsx
  - src/renderer/components/dashboard/ProjectCard.tsx
  - src/renderer/routes/Settings.tsx
  - src/renderer/routes/Dashboard.tsx
  - src/renderer/App.tsx
  - src/renderer/components/sidebar/AppSidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard stats strip shows total token usage with cost estimate"
    - "Project cards show per-project token count with cost estimate inline"
    - "Toast notification appears when approaching usage limit (80%) - dismissable"
    - "Toast notification blocks processing when at limit (100%)"
    - "Unified Settings page with LLM settings and usage limits"
    - "Hidden scrollbars globally throughout the app"
  artifacts:
    - path: "src/renderer/stores/usageStore.ts"
      provides: "Zustand store for usage state"
      contains: "useUsageStore"
    - path: "src/renderer/routes/Settings.tsx"
      provides: "Unified Settings page with all settings"
      contains: "UsageLimits"
    - path: "src/renderer/styles/globals.css"
      provides: "Global hidden scrollbar styles"
      contains: "scrollbar-width: none"
  key_links:
    - from: "src/renderer/routes/Dashboard.tsx"
      to: "src/renderer/stores/usageStore.ts"
      via: "useUsageStore hook"
      pattern: "useUsageStore"
---

<objective>
Integrate usage tracking into UI - display in dashboard, project cards, toast warnings, and create unified Settings page. Apply global hidden scrollbar styling.

Purpose: Gives users visibility into token/API usage with cost estimates and ability to set limits with toast notifications.
Output: Complete UI for usage tracking with toast warnings, unified Settings page, cost display, and global hidden scrollbars.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.7-dashboard-enhancements/04.7-RESEARCH.md
@.planning/phases/04.7-dashboard-enhancements/04.7-CONTEXT.md
@.planning/phases/04.7-dashboard-enhancements/04.7-03-SUMMARY.md
@.planning/phases/04.7-dashboard-enhancements/04.7-04-SUMMARY.md
@src/renderer/stores/queueStore.ts
@src/renderer/components/dashboard/StatsStrip.tsx
@src/renderer/components/dashboard/ProjectCard.tsx
@src/renderer/components/settings/LLMSettings.tsx
@src/renderer/routes/Dashboard.tsx
@src/renderer/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install sonner and add global hidden scrollbar CSS</name>
  <files>package.json, src/renderer/styles/globals.css</files>
  <action>
    Install sonner for toast notifications (per CONTEXT.md decision):
    ```bash
    npm install sonner
    ```

    Add global hidden scrollbar styles to globals.css. Per CONTEXT.md:
    "Global styling rule: Hidden scrollbars throughout the app (scrollable but no visible scrollbar) - applies to Quick Access and all existing/future scrollable areas"

    Add to globals.css after existing styles:
    ```css
    /* Global hidden scrollbars - scrollable but no visible scrollbar */
    * {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }

    *::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    ```
  </action>
  <verify>npm list sonner shows version installed; globals.css contains scrollbar styles</verify>
  <done>Sonner installed and global hidden scrollbar styles added</done>
</task>

<task type="auto">
  <name>Task 2: Create usage store with cost calculation helper</name>
  <files>src/renderer/stores/usageStore.ts</files>
  <action>
    Create a new Zustand store for usage tracking. Follow existing store patterns from queueStore.ts.

    ```typescript
    import { create } from 'zustand';

    interface UsageStats {
      totalTokens: number;
      requestCount: number;
    }

    interface UsageState {
      // Usage data
      globalUsage: UsageStats;
      projectUsage: Record<string, UsageStats>;

      // Settings (cached from main process)
      globalTokenLimit: number | null;
      warningThreshold: number;
      llmMode: 'local' | 'cloud';

      // Loading state
      isLoading: boolean;

      // Actions
      loadUsage: () => Promise<void>;
      loadSettings: () => Promise<void>;
      isOverLimit: () => boolean;
      isNearLimit: () => boolean;
      getProjectUsage: (projectId: string) => UsageStats;
    }

    /**
     * Format token count with abbreviation: 1.2K, 45.3K, 1.1M
     */
    export function formatTokens(tokens: number): string {
      if (tokens >= 1_000_000) return `${(tokens / 1_000_000).toFixed(1)}M`;
      if (tokens >= 1_000) return `${(tokens / 1_000).toFixed(1)}K`;
      return tokens.toString();
    }

    /**
     * Estimate cost for cloud mode tokens.
     * Based on GPT-4o-mini pricing: ~$0.15 per 1M input tokens, ~$0.60 per 1M output tokens
     * Using blended rate of ~$0.30 per 1M tokens (~$0.0003 per 1K tokens)
     * For local mode, returns null (no cost).
     */
    export function estimateCost(tokens: number, mode: 'local' | 'cloud'): string | null {
      if (mode === 'local') return null;
      const cost = (tokens / 1_000_000) * 0.30; // $0.30 per 1M tokens
      if (cost < 0.01) return '<$0.01';
      return `~$${cost.toFixed(2)}`;
    }

    /**
     * Format tokens with cost estimate: "45.3K (~$0.01)"
     */
    export function formatTokensWithCost(tokens: number, mode: 'local' | 'cloud'): string {
      const formatted = formatTokens(tokens);
      const cost = estimateCost(tokens, mode);
      if (cost) {
        return `${formatted} (${cost})`;
      }
      return formatted;
    }

    export const useUsageStore = create<UsageState>((set, get) => ({
      globalUsage: { totalTokens: 0, requestCount: 0 },
      projectUsage: {},
      globalTokenLimit: null,
      warningThreshold: 80,
      llmMode: 'local',
      isLoading: true,

      loadUsage: async () => {
        try {
          const result = await window.api.getUsageStats();
          if (result.success && result.data) {
            set({
              globalUsage: result.data.global,
              projectUsage: result.data.byProject,
              isLoading: false,
            });
          }
        } catch (error) {
          console.error('Failed to load usage:', error);
          set({ isLoading: false });
        }
      },

      loadSettings: async () => {
        try {
          const result = await window.api.getAppSettings();
          if (result.success && result.data) {
            set({
              globalTokenLimit: result.data.globalTokenLimit ?? null,
              warningThreshold: result.data.warningThreshold,
              llmMode: result.data.llmMode,
            });
          }
        } catch (error) {
          console.error('Failed to load settings:', error);
        }
      },

      isOverLimit: () => {
        const { globalUsage, globalTokenLimit } = get();
        if (globalTokenLimit === null) return false;
        return globalUsage.totalTokens >= globalTokenLimit;
      },

      isNearLimit: () => {
        const { globalUsage, globalTokenLimit, warningThreshold } = get();
        if (globalTokenLimit === null) return false;
        const threshold = (globalTokenLimit * warningThreshold) / 100;
        return globalUsage.totalTokens >= threshold && !get().isOverLimit();
      },

      getProjectUsage: (projectId: string) => {
        const { projectUsage } = get();
        return projectUsage[projectId] ?? { totalTokens: 0, requestCount: 0 };
      },
    }));
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>usageStore created with formatters and cost estimation</done>
</task>

<task type="auto">
  <name>Task 3: Update StatsStrip with token usage and cost</name>
  <files>src/renderer/components/dashboard/StatsStrip.tsx</files>
  <action>
    Update imports:
    ```typescript
    import { FileText, Briefcase, Clock, Gauge } from 'lucide-react';
    import { formatTokensWithCost } from '../../stores/usageStore';
    ```

    Update the StatsStripProps interface to include tokens and mode:
    ```typescript
    interface StatsStripProps {
      totalCVs: number;
      totalJDs: number;
      timeSaved: string;
      totalTokens?: number;
      llmMode?: 'local' | 'cloud';
    }
    ```

    Update the component to display tokens with cost (per CONTEXT.md: "45.3K tokens (~$0.12)" format):
    ```typescript
    export function StatsStrip({ totalCVs, totalJDs, timeSaved, totalTokens, llmMode = 'local' }: StatsStripProps) {
      const stats = [
        { label: 'CVs Processed', value: totalCVs.toString(), icon: FileText },
        { label: 'Job Descriptions', value: totalJDs.toString(), icon: Briefcase },
        { label: 'Time Saved', value: timeSaved, icon: Clock },
      ];

      // Add tokens stat if provided (per CONTEXT.md: use gauge/meter icon)
      if (totalTokens !== undefined) {
        stats.push({
          label: 'Tokens Used',
          value: formatTokensWithCost(totalTokens, llmMode),
          icon: Gauge,
        });
      }

      return (
        // ... existing render logic
      );
    }
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>StatsStrip shows token usage with cost estimate</done>
</task>

<task type="auto">
  <name>Task 4: Update ProjectCard with inline token display</name>
  <files>src/renderer/components/dashboard/ProjectCard.tsx</files>
  <action>
    Update imports:
    ```typescript
    import { Gauge } from 'lucide-react';
    import { formatTokensWithCost } from '../../stores/usageStore';
    ```

    Update ProjectCardProps:
    ```typescript
    interface ProjectCardProps {
      project: Project;
      tokenUsage?: number;
      llmMode?: 'local' | 'cloud';
      onArchive: (id: string) => void;
      onDelete: (id: string) => void;
    }
    ```

    Update CardContent to show tokens inline with CV/JD counts (per CONTEXT.md: "5 CVs 路 2 JDs 路 12.4K (~$0.04)"):
    ```typescript
    <CardContent className="..." {...listeners} onClick={() => !isDragging && navigate(`/project/${project.id}`)}>
      <div className="flex flex-wrap gap-x-3 gap-y-1 text-sm text-muted-foreground">
        <span>{project.cv_count} CVs</span>
        <span className="text-muted-foreground/50">路</span>
        <span>{project.jd_count} JDs</span>
        {tokenUsage !== undefined && tokenUsage > 0 && (
          <>
            <span className="text-muted-foreground/50">路</span>
            <span className="flex items-center gap-1">
              <Gauge className="h-3 w-3" />
              {formatTokensWithCost(tokenUsage, llmMode || 'local')}
            </span>
          </>
        )}
      </div>
      <p className="text-xs text-muted-foreground mt-2">
        Last activity: {formatDate(project.updated_at)}
      </p>
    </CardContent>
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>ProjectCard shows inline token usage with cost</done>
</task>

<task type="auto">
  <name>Task 5: Create unified Settings page with UsageLimits</name>
  <files>src/renderer/routes/Settings.tsx</files>
  <action>
    Create a new unified Settings page that aggregates all settings (per CONTEXT.md: "Create unified Settings page accessible from dashboard sidebar. Aggregate ALL settings").

    ```typescript
    import { useState, useEffect } from 'react';
    import { useNavigate } from 'react-router-dom';
    import { ArrowLeft, Settings as SettingsIcon } from 'lucide-react';
    import { Button } from '../components/ui/button';
    import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '../components/ui/card';
    import { LLMSettings } from '../components/settings/LLMSettings';
    import { useUsageStore, formatTokens, estimateCost } from '../stores/usageStore';

    // Preset limits with cost estimates (per CONTEXT.md)
    const LIMIT_PRESETS = [
      { value: 10_000, label: '10K' },
      { value: 50_000, label: '50K' },
      { value: 100_000, label: '100K' },
      { value: 500_000, label: '500K' },
    ];

    export function Settings() {
      const navigate = useNavigate();
      const { globalUsage, globalTokenLimit, warningThreshold, llmMode, loadSettings } = useUsageStore();

      const [limit, setLimit] = useState<string>(globalTokenLimit?.toString() ?? '');
      const [threshold, setThreshold] = useState<string>(warningThreshold.toString());
      const [isSaving, setIsSaving] = useState(false);

      useEffect(() => {
        setLimit(globalTokenLimit?.toString() ?? '');
        setThreshold(warningThreshold.toString());
      }, [globalTokenLimit, warningThreshold]);

      const handleSave = async () => {
        setIsSaving(true);
        try {
          const updates: { globalTokenLimit?: number; warningThreshold?: number } = {};

          if (limit.trim() === '' || limit === '0') {
            updates.globalTokenLimit = undefined;
          } else {
            const parsed = parseInt(limit, 10);
            if (!isNaN(parsed) && parsed > 0) {
              updates.globalTokenLimit = parsed;
            }
          }

          const parsedThreshold = parseInt(threshold, 10);
          if (!isNaN(parsedThreshold) && parsedThreshold > 0 && parsedThreshold <= 100) {
            updates.warningThreshold = parsedThreshold;
          }

          await window.api.updateAppSettings(updates);
          await loadSettings();
        } catch (error) {
          console.error('Failed to save settings:', error);
        } finally {
          setIsSaving(false);
        }
      };

      const handlePresetClick = (value: number) => {
        setLimit(value.toString());
      };

      return (
        <main className="flex-1 overflow-auto p-6">
          <div className="max-w-2xl mx-auto space-y-6">
            {/* Header with back button */}
            <div className="flex items-center gap-4 mb-6">
              <Button variant="ghost" size="icon" onClick={() => navigate('/')}>
                <ArrowLeft className="h-5 w-5" />
              </Button>
              <div className="flex items-center gap-2">
                <SettingsIcon className="h-6 w-6 text-primary" />
                <h1 className="text-2xl font-bold text-foreground">Settings</h1>
              </div>
            </div>

            {/* LLM Settings Card */}
            <Card className="bg-card border-border">
              <CardHeader>
                <CardTitle>Processing Mode</CardTitle>
                <CardDescription>Choose between local privacy or cloud speed</CardDescription>
              </CardHeader>
              <CardContent>
                <LLMSettings />
              </CardContent>
            </Card>

            {/* Usage Limits Card */}
            <Card className="bg-card border-border">
              <CardHeader>
                <CardTitle>Usage Limits</CardTitle>
                <CardDescription>
                  Configure monthly token limits to control API costs. Resets on the 1st of each month.
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                {/* Current usage display */}
                <div className="text-sm text-muted-foreground">
                  Current usage: {formatTokens(globalUsage.totalTokens)} tokens
                  {llmMode === 'cloud' && estimateCost(globalUsage.totalTokens, llmMode) && (
                    <span> ({estimateCost(globalUsage.totalTokens, llmMode)})</span>
                  )}
                </div>

                {/* Preset quick picks (per CONTEXT.md) */}
                <div className="space-y-2">
                  <label className="text-sm font-medium text-foreground">Monthly Token Limit</label>
                  <div className="flex flex-wrap gap-2">
                    {LIMIT_PRESETS.map((preset) => (
                      <Button
                        key={preset.value}
                        variant={limit === preset.value.toString() ? 'default' : 'outline'}
                        size="sm"
                        onClick={() => handlePresetClick(preset.value)}
                      >
                        {preset.label}
                        {llmMode === 'cloud' && (
                          <span className="ml-1 text-xs opacity-70">
                            ({estimateCost(preset.value, llmMode)})
                          </span>
                        )}
                      </Button>
                    ))}
                    <Button
                      variant={!LIMIT_PRESETS.some(p => p.value.toString() === limit) && limit !== '' ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => setLimit('')}
                    >
                      Unlimited
                    </Button>
                  </div>
                </div>

                {/* Custom input */}
                <div className="space-y-2">
                  <label className="text-sm text-muted-foreground">Or enter custom limit:</label>
                  <input
                    type="number"
                    value={limit}
                    onChange={(e) => setLimit(e.target.value)}
                    placeholder="Unlimited"
                    className="w-full px-3 py-2 bg-background border border-input rounded-md text-sm
                               text-foreground placeholder:text-muted-foreground
                               focus:outline-none focus:ring-2 focus:ring-primary"
                  />
                </div>

                {/* Warning threshold */}
                <div className="space-y-2">
                  <label className="text-sm font-medium text-foreground">Warning Threshold (%)</label>
                  <input
                    type="number"
                    min="1"
                    max="100"
                    value={threshold}
                    onChange={(e) => setThreshold(e.target.value)}
                    className="w-full px-3 py-2 bg-background border border-input rounded-md text-sm
                               text-foreground placeholder:text-muted-foreground
                               focus:outline-none focus:ring-2 focus:ring-primary"
                  />
                  <p className="text-xs text-muted-foreground">
                    Show warning toast when usage reaches this percentage of limit (default: 80%)
                  </p>
                </div>

                <Button onClick={handleSave} disabled={isSaving}>
                  {isSaving ? 'Saving...' : 'Save Limits'}
                </Button>
              </CardContent>
            </Card>
          </div>
        </main>
      );
    }
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>Unified Settings page created with LLM settings and usage limits</done>
</task>

<task type="auto">
  <name>Task 6: Add Settings route and update sidebar navigation</name>
  <files>src/renderer/App.tsx, src/renderer/components/sidebar/AppSidebar.tsx</files>
  <action>
    Update App.tsx to add Settings route:
    ```typescript
    import { Settings } from './routes/Settings';

    // In Routes section:
    <Routes>
      <Route path="/" element={<Dashboard />} />
      <Route path="/project/:id" element={<ProjectView />} />
      <Route path="/settings" element={<Settings />} />
    </Routes>
    ```

    Update AppSidebar.tsx to make Settings button navigable:
    ```typescript
    // In SidebarFooter, change the Settings button to navigate:
    <SidebarFooter className="p-2">
      <SidebarMenu>
        <SidebarMenuItem>
          <SidebarMenuButton
            onClick={() => navigate('/settings')}
            isActive={location.pathname === '/settings'}
            tooltip="Settings"
          >
            <Settings />
            <span>Settings</span>
          </SidebarMenuButton>
        </SidebarMenuItem>
      </SidebarMenu>
    </SidebarFooter>
    ```

    Also add Toaster component to App.tsx for toast notifications:
    ```typescript
    import { Toaster } from 'sonner';

    // Inside the return, after DragOverlay:
    <Toaster
      position="bottom-right"
      toastOptions={{
        className: 'bg-card border-border text-foreground',
        duration: Infinity, // Toast stays until dismissed (per CONTEXT.md)
      }}
    />
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>Settings route added and sidebar navigation updated</done>
</task>

<task type="auto">
  <name>Task 7: Integrate usage into Dashboard with toast warnings</name>
  <files>src/renderer/routes/Dashboard.tsx</files>
  <action>
    Update Dashboard.tsx to load usage data and show toast warnings:

    1. Import store and toast:
    ```typescript
    import { useUsageStore } from '../stores/usageStore';
    import { toast } from 'sonner';
    import { useEffect, useRef } from 'react';
    import { AlertTriangle } from 'lucide-react';
    ```

    2. Add usage store hooks:
    ```typescript
    const {
      globalUsage,
      projectUsage,
      globalTokenLimit,
      llmMode,
      loadUsage,
      loadSettings,
      isNearLimit,
      isOverLimit,
      getProjectUsage,
    } = useUsageStore();
    ```

    3. Add useEffect to load usage and settings on mount:
    ```typescript
    useEffect(() => {
      loadUsage();
      loadSettings();
    }, [loadUsage, loadSettings]);
    ```

    4. Add useEffect for toast warnings (per CONTEXT.md: toast notification, stays until dismissed):
    ```typescript
    const toastShownRef = useRef<{ warning: boolean; limit: boolean }>({ warning: false, limit: false });

    useEffect(() => {
      if (isOverLimit() && !toastShownRef.current.limit) {
        toastShownRef.current.limit = true;
        toast.error(
          <div className="flex flex-col gap-1">
            <div className="flex items-center gap-2 font-medium">
              <AlertTriangle className="h-4 w-4" />
              Usage Limit Reached
            </div>
            <p className="text-sm text-muted-foreground">
              Processing is paused. {' '}
              <button
                onClick={() => {
                  toast.dismiss();
                  navigate('/settings');
                }}
                className="text-primary underline"
              >
                Increase limit in Settings
              </button>
            </p>
          </div>,
          { duration: Infinity }
        );
      } else if (isNearLimit() && !toastShownRef.current.warning) {
        toastShownRef.current.warning = true;
        const percentage = globalTokenLimit
          ? Math.round((globalUsage.totalTokens / globalTokenLimit) * 100)
          : 0;
        toast.warning(
          <div className="flex flex-col gap-1">
            <div className="flex items-center gap-2 font-medium">
              <AlertTriangle className="h-4 w-4" />
              Approaching Usage Limit
            </div>
            <p className="text-sm text-muted-foreground">
              {percentage}% of monthly limit used. {' '}
              <button
                onClick={() => {
                  toast.dismiss();
                  navigate('/settings');
                }}
                className="text-primary underline"
              >
                Manage in Settings
              </button>
            </p>
          </div>,
          { duration: Infinity }
        );
      }
    }, [isNearLimit, isOverLimit, globalUsage, globalTokenLimit, navigate]);
    ```

    5. Update StatsStrip to include tokens and mode:
    ```tsx
    <StatsStrip
      totalCVs={totalCVs}
      totalJDs={totalJDs}
      timeSaved={timeSaved}
      totalTokens={globalUsage.totalTokens}
      llmMode={llmMode}
    />
    ```

    6. Pass tokenUsage and llmMode to each ProjectCard:
    ```tsx
    <ProjectCard
      key={project.id}
      project={project}
      tokenUsage={getProjectUsage(project.id).totalTokens}
      llmMode={llmMode}
      onArchive={handleArchive}
      onDelete={handleDelete}
    />
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>Dashboard shows usage stats with toast warnings</done>
</task>

</tasks>

<verification>
After all tasks:
1. Run `npm run lint --quiet` - no errors
2. Run `npm run build` - builds successfully
3. Manual test: Dashboard shows token count in stats strip with cost estimate
4. Manual test: Project cards show per-project token usage inline with cost
5. Manual test: Navigate to Settings via sidebar button
6. Manual test: Settings page has LLM settings and usage limits with presets
7. Manual test: Set a low limit, see warning toast appear (dismissable, stays until dismissed)
8. Manual test: Verify scrollbars are hidden but content is still scrollable
</verification>

<success_criteria>
- Sonner installed for toast notifications
- Global hidden scrollbars applied throughout app
- usageStore loads and caches usage data with cost calculation helpers
- Toast warning appears at 80% threshold (near limit) - stays until dismissed
- Toast error appears at 100% (over limit) with link to Settings
- StatsStrip shows total tokens with cost estimate
- ProjectCard shows per-project tokens inline with cost
- Unified Settings page accessible from sidebar
- Settings page has preset quick picks with cost estimates
- Monthly reset period documented (1st of month)
</success_criteria>

<output>
After completion, create `.planning/phases/04.7-dashboard-enhancements/04.7-05-SUMMARY.md`
</output>
