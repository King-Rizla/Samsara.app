---
phase: 01-foundation-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - forge.config.ts
  - vite.main.config.ts
  - vite.preload.config.ts
  - vite.renderer.config.ts
  - src/main/index.ts
  - src/main/preload.ts
  - src/main/database.ts
  - src/renderer/index.html
  - src/renderer/renderer.ts
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Electron app launches and displays a basic window"
    - "SQLite database initializes in app.getPath('userData') with WAL mode"
    - "better-sqlite3 native module is rebuilt for Electron"
    - "Vite dev server supports hot reload for renderer"
  artifacts:
    - path: "package.json"
      provides: "Electron Forge + Vite project configuration"
      contains: "@electron-forge/plugin-vite"
    - path: "forge.config.ts"
      provides: "Forge build configuration"
      contains: "concurrent: false"
    - path: "vite.main.config.ts"
      provides: "Main process Vite config"
      contains: "external: ['better-sqlite3']"
    - path: "src/main/database.ts"
      provides: "SQLite database wrapper"
      contains: "journal_mode = WAL"
    - path: "src/main/index.ts"
      provides: "Main process entry point"
      contains: "MAIN_WINDOW_VITE_DEV_SERVER_URL"
  key_links:
    - from: "src/main/index.ts"
      to: "src/main/database.ts"
      via: "import and initialize"
      pattern: "import.*database"
    - from: "forge.config.ts"
      to: "vite.main.config.ts"
      via: "Vite plugin build config"
      pattern: "vite\\.main\\.config"
---

<objective>
Create the Electron shell with Forge + Vite toolchain and SQLite database.

Purpose: Establishes the desktop application foundation with proper build tooling. This runs in parallel with Plan 02 (Python sidecar) and provides the Electron side for Plan 03 to integrate.

Output: A working Electron app that launches, displays a window, and initializes a SQLite database in the user data directory.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-distribution/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Electron Forge with Vite template</name>
  <files>
    package.json
    forge.config.ts
    vite.main.config.ts
    vite.preload.config.ts
    vite.renderer.config.ts
    src/main/index.ts
    src/main/preload.ts
    src/renderer/index.html
    src/renderer/renderer.ts
    .gitignore
  </files>
  <action>
    Run `npm init electron-app@latest . -- --template=vite-typescript` in the project root (the directory already exists with .planning/).

    After initialization:
    1. In `forge.config.ts`, add `concurrent: false` to VitePlugin options to prevent OOM issues:
       ```typescript
       new VitePlugin({
         concurrent: false,  // Prevent OOM issues
         build: [...],
         renderer: [...],
       })
       ```

    2. In `vite.main.config.ts`, add external for better-sqlite3:
       ```typescript
       export default defineConfig({
         build: {
           rollupOptions: {
             external: ['better-sqlite3'],
           },
         },
       });
       ```

    3. Add to `.gitignore`:
       - `python-dist/`
       - `.env*`
       - `*.db`
       - `*.db-wal`
       - `*.db-shm`

    4. Update `src/main/index.ts` to use the Vite global variables pattern:
       ```typescript
       declare const MAIN_WINDOW_VITE_DEV_SERVER_URL: string;
       declare const MAIN_WINDOW_VITE_NAME: string;
       ```

    Do NOT use python-shell library. The Python IPC will use direct `child_process.spawn` in Plan 03.
  </action>
  <verify>
    Run `npm run start` - Electron window should appear with Vite dev server HMR working.
    Check that `forge.config.ts` contains `concurrent: false`.
    Check that `vite.main.config.ts` contains `external: ['better-sqlite3']`.
  </verify>
  <done>
    Electron Forge app initializes with Vite template, concurrent: false is set, and better-sqlite3 is marked as external.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install and configure better-sqlite3 with database wrapper</name>
  <files>
    package.json
    src/main/database.ts
    src/main/index.ts
  </files>
  <action>
    1. Install better-sqlite3 and rebuild tool:
       ```bash
       npm install better-sqlite3
       npm install -D @electron/rebuild
       ```

    2. Rebuild better-sqlite3 for Electron:
       ```bash
       npx @electron/rebuild -f -w better-sqlite3
       ```

       IMPORTANT: Use `@electron/rebuild` (NOT the deprecated `electron-rebuild`).

    3. Add rebuild script to package.json:
       ```json
       "scripts": {
         "rebuild": "@electron/rebuild -f -w better-sqlite3",
         "postinstall": "@electron/rebuild -f -w better-sqlite3"
       }
       ```

    4. Create `src/main/database.ts`:
       ```typescript
       import Database from 'better-sqlite3';
       import { app } from 'electron';
       import * as path from 'path';

       let db: Database.Database | null = null;

       export function initDatabase(): Database.Database {
         if (db) return db;

         const dbPath = path.join(app.getPath('userData'), 'samsara.db');
         db = new Database(dbPath);

         // Enable WAL mode for better concurrent access
         db.pragma('journal_mode = WAL');
         db.pragma('synchronous = NORMAL');

         // Initialize schema
         db.exec(`
           CREATE TABLE IF NOT EXISTS app_meta (
             key TEXT PRIMARY KEY,
             value TEXT
           );
         `);

         // Store init timestamp
         const stmt = db.prepare('INSERT OR REPLACE INTO app_meta (key, value) VALUES (?, ?)');
         stmt.run('initialized_at', new Date().toISOString());

         return db;
       }

       export function getDatabase(): Database.Database {
         if (!db) throw new Error('Database not initialized. Call initDatabase() first.');
         return db;
       }

       export function closeDatabase(): void {
         if (db) {
           db.close();
           db = null;
         }
       }
       ```

    5. Update `src/main/index.ts` to initialize database on app ready:
       - Import `{ initDatabase, closeDatabase }` from './database'
       - Call `initDatabase()` in the `app.whenReady()` block before creating window
       - Call `closeDatabase()` in app 'before-quit' handler
  </action>
  <verify>
    Run `npm run start`. Check console for any native module errors.
    After app launches, verify `samsara.db` file exists in userData directory:
    - Windows: `%APPDATA%/samsara/samsara.db`
    - macOS: `~/Library/Application Support/samsara/samsara.db`

    The file should be accompanied by `samsara.db-wal` (WAL mode indicator).
  </verify>
  <done>
    better-sqlite3 is installed, rebuilt for Electron using @electron/rebuild, and database initializes in userData with WAL mode enabled.
  </done>
</task>

</tasks>

<verification>
1. `npm run start` launches Electron window without errors
2. No native module ABI mismatch errors in console
3. Database file exists at `app.getPath('userData')/samsara.db`
4. Database has `journal_mode = WAL` (presence of .db-wal file confirms this)
5. `forge.config.ts` contains `concurrent: false`
6. `vite.main.config.ts` contains `external: ['better-sqlite3']`
</verification>

<success_criteria>
- Electron app launches and displays basic window
- SQLite database initializes in user data directory with WAL mode
- No build errors or native module issues
- Foundation ready for Plan 03 integration with Python sidecar
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-distribution/01-01-SUMMARY.md`
</output>
