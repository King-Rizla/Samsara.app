---
phase: 04.7-dashboard-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/database.ts
autonomous: true

must_haves:
  truths:
    - "usage_events table stores raw token usage per LLM call"
    - "usage_daily table stores aggregated daily totals"
    - "SQLite trigger auto-aggregates events into daily table on insert"
    - "projects table has is_pinned and pin_order columns for quick-access sidebar"
  artifacts:
    - path: "src/main/database.ts"
      provides: "Usage tracking schema and CRUD functions"
      contains: "CREATE TABLE IF NOT EXISTS usage_events"
  key_links:
    - from: "usage_events"
      to: "projects"
      via: "FOREIGN KEY ON DELETE CASCADE"
      pattern: "FOREIGN KEY.*project_id.*projects.*ON DELETE CASCADE"
---

<objective>
Add database schema for usage tracking (token counts, API calls) and quick-access project pinning with reorder support.

Purpose: Establishes the data layer for tracking LLM usage costs and enabling project drag-drop to sidebar with reordering.
Output: Migration v3 with usage_events, usage_daily tables, trigger, is_pinned, and pin_order columns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.7-dashboard-enhancements/04.7-RESEARCH.md
@.planning/phases/04.7-dashboard-enhancements/04.7-CONTEXT.md
@src/main/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add usage tracking tables and trigger</name>
  <files>src/main/database.ts</files>
  <action>
    Add migration v3 inside initDatabase() after the version < 2 block.

    Create usage_events table:
    ```sql
    CREATE TABLE IF NOT EXISTS usage_events (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      project_id TEXT NOT NULL,
      event_type TEXT NOT NULL,  -- 'cv_extraction', 'jd_extraction'
      prompt_tokens INTEGER NOT NULL DEFAULT 0,
      completion_tokens INTEGER NOT NULL DEFAULT 0,
      total_tokens INTEGER NOT NULL DEFAULT 0,
      llm_mode TEXT NOT NULL,    -- 'local' or 'cloud'
      model TEXT,                -- e.g., 'qwen2.5:7b', 'gpt-4o-mini' (extensible for future)
      created_at TEXT NOT NULL,
      FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
    );
    ```

    Create usage_daily aggregation table:
    ```sql
    CREATE TABLE IF NOT EXISTS usage_daily (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      project_id TEXT NOT NULL,
      date TEXT NOT NULL,
      total_tokens INTEGER DEFAULT 0,
      request_count INTEGER DEFAULT 0,
      UNIQUE(project_id, date),
      FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
    );
    ```

    Create trigger for auto-aggregation (use INSERT OR REPLACE pattern for SQLite):
    ```sql
    CREATE TRIGGER IF NOT EXISTS update_daily_usage
    AFTER INSERT ON usage_events
    BEGIN
      INSERT INTO usage_daily (project_id, date, total_tokens, request_count)
      VALUES (NEW.project_id, DATE(NEW.created_at), NEW.total_tokens, 1)
      ON CONFLICT(project_id, date) DO UPDATE SET
        total_tokens = total_tokens + NEW.total_tokens,
        request_count = request_count + 1;
    END;
    ```

    Create indexes:
    - idx_usage_events_project ON usage_events(project_id)
    - idx_usage_daily_project_date ON usage_daily(project_id, date)

    Also in this migration, add pinning columns to projects table:
    ```sql
    ALTER TABLE projects ADD COLUMN is_pinned INTEGER NOT NULL DEFAULT 0
    ALTER TABLE projects ADD COLUMN pin_order INTEGER NOT NULL DEFAULT 0
    ```
    Check if columns exist before adding (same pattern as status column in v2 migration).

    Set user_version = 3 after migration.
  </action>
  <verify>npm run lint --quiet shows no errors in database.ts</verify>
  <done>Migration v3 creates usage tables, trigger, is_pinned, and pin_order columns</done>
</task>

<task type="auto">
  <name>Task 2: Add usage tracking and pinning CRUD functions</name>
  <files>src/main/database.ts</files>
  <action>
    Add TypeScript interfaces at top of file (after existing interfaces):
    ```typescript
    export interface UsageEventInput {
      projectId: string;
      eventType: 'cv_extraction' | 'jd_extraction';
      promptTokens: number;
      completionTokens: number;
      totalTokens: number;
      llmMode: 'local' | 'cloud';
      model?: string;
    }

    export interface UsageStats {
      totalTokens: number;
      requestCount: number;
    }

    export interface ProjectUsageStats {
      global: UsageStats;
      byProject: Record<string, UsageStats>;
    }
    ```

    Add CRUD functions at end of file (after Queue-Specific Functions section):

    // ========================================
    // Usage Tracking Functions
    // ========================================

    1. recordUsageEvent(input: UsageEventInput): void
       - Insert into usage_events table
       - Use current ISO timestamp for created_at
       - Log event with console.log('[DB] Recorded usage event:', ...)

    2. getUsageStatsByProject(projectId: string): UsageStats
       - Query usage_daily for sum of total_tokens and request_count for current month
       - WHERE project_id = ? AND date >= strftime('%Y-%m-01', 'now')
       - Return { totalTokens, requestCount } (default to 0 if no results)

    3. getGlobalUsageStats(): UsageStats
       - Query usage_daily for sum across all projects for current month
       - WHERE date >= strftime('%Y-%m-01', 'now')
       - Return { totalTokens, requestCount }

    4. getAllUsageStats(): ProjectUsageStats
       - Call getGlobalUsageStats() for global
       - Query usage_daily grouped by project_id for current month
       - Return { global, byProject }

    // ========================================
    // Project Pinning Functions
    // ========================================

    5. updateProjectPinned(projectId: string, isPinned: boolean): boolean
       - If pinning (isPinned=true): Get max pin_order from pinned projects, set new order = max + 1
       - If unpinning: Set is_pinned = 0, pin_order = 0
       - UPDATE projects SET is_pinned = ?, pin_order = ?, updated_at = ? WHERE id = ?
       - Return result.changes > 0

    6. getPinnedProjects(): ProjectSummary[]
       - Same query as getAllProjects but WHERE is_pinned = 1 ORDER BY pin_order ASC
       - Return array of pinned projects

    7. reorderPinnedProjects(projectIds: string[]): void
       - For each projectId in array, UPDATE pin_order to its index position
       - Use transaction for atomicity: db.transaction(() => { ... })()
  </action>
  <verify>npm run lint --quiet shows no TypeScript/ESLint errors</verify>
  <done>Seven usage/pinning functions exported and type-safe</done>
</task>

</tasks>

<verification>
After both tasks:
1. Run `npm run lint --quiet` - no errors
2. Manually verify migration runs on app start by checking logs for "Migrating database to version 3"
3. Verify tables exist by running app and checking no errors on database queries
</verification>

<success_criteria>
- Migration v3 runs idempotently (can restart app multiple times without error)
- usage_events and usage_daily tables created with proper foreign keys
- SQLite trigger auto-aggregates token counts into daily table
- is_pinned and pin_order columns added to projects table
- All seven CRUD functions compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04.7-dashboard-enhancements/04.7-01-SUMMARY.md`
</output>
