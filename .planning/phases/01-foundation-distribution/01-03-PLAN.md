---
phase: 01-foundation-distribution
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - src/main/pythonManager.ts
  - src/main/index.ts
  - src/main/preload.ts
  - src/renderer/renderer.ts
  - forge.config.ts
  - entitlements.plist
autonomous: false
user_setup:
  - service: windows-code-signing
    why: "Sign Windows executable to avoid SmartScreen warnings"
    env_vars:
      - name: AZURE_ENDPOINT
        source: "Azure Portal -> Trusted Signing -> Endpoint URL"
      - name: AZURE_CERT_PROFILE
        source: "Azure Portal -> Trusted Signing -> Certificate Profile Name"
      - name: AZURE_ACCOUNT
        source: "Azure Portal -> Trusted Signing -> Account Name"
    dashboard_config:
      - task: "Create Azure Trusted Signing account"
        location: "Azure Portal -> Create Resource -> Trusted Signing"
  - service: macos-code-signing
    why: "Sign and notarize macOS app to pass Gatekeeper"
    env_vars:
      - name: APPLE_ID
        source: "Your Apple Developer account email"
      - name: APPLE_ID_PASSWORD
        source: "App-specific password from appleid.apple.com"
      - name: APPLE_TEAM_ID
        source: "Apple Developer Portal -> Membership -> Team ID"
    dashboard_config:
      - task: "Create Developer ID Application certificate"
        location: "Apple Developer Portal -> Certificates"

must_haves:
  truths:
    - "Electron app launches Python sidecar and receives health check response"
    - "Sidecar startup completes within 10 seconds on cold start"
    - "Python process terminates cleanly when Electron app closes"
    - "Packaged app works on clean VM without development tools"
  artifacts:
    - path: "src/main/pythonManager.ts"
      provides: "Python sidecar lifecycle management"
      contains: "startPython"
    - path: "entitlements.plist"
      provides: "macOS code signing entitlements"
      contains: "hardened-runtime"
    - path: "forge.config.ts"
      provides: "Updated Forge config with signing"
      contains: "osxSign"
  key_links:
    - from: "src/main/index.ts"
      to: "src/main/pythonManager.ts"
      via: "import and startup call"
      pattern: "startPython"
    - from: "src/main/pythonManager.ts"
      to: "python-dist/samsara-backend"
      via: "spawn process"
      pattern: "resourcesPath.*samsara-backend"
    - from: "src/renderer/renderer.ts"
      to: "window.electronAPI.pythonHealthCheck"
      via: "IPC call"
      pattern: "pythonHealthCheck"
---

<objective>
Integrate Python sidecar with Electron shell and configure code signing for distribution.

Purpose: Completes the Phase 1 goal by proving the full distribution pipeline works - Electron launches Python sidecar, communicates via IPC, and the signed package runs on clean VMs.
Output: Signed, distributable app that loads spaCy and responds to health check within 10 seconds.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-distribution/01-RESEARCH.md
@.planning/phases/01-foundation-distribution/01-01-SUMMARY.md
@.planning/phases/01-foundation-distribution/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Python sidecar manager with health check</name>
  <files>
    src/main/pythonManager.ts
    src/main/index.ts
    src/main/preload.ts
    src/renderer/renderer.ts
  </files>
  <action>
    1. Create src/main/pythonManager.ts:
       - Import: spawn (child_process), app (electron), path, readline

       - State variables:
         - pythonProcess: ChildProcess | null
         - pythonReady: boolean
         - pendingRequests: Map<string, {resolve, reject}>

       - findPythonPath() function:
         - If app.isPackaged: return path.join(process.resourcesPath, 'samsara-backend', exeName)
         - Else: return path.join(__dirname, '..', '..', 'python-dist', 'samsara-backend', exeName)
         - exeName = process.platform === 'win32' ? 'samsara-backend.exe' : 'samsara-backend'

       - startPython() async function:
         - Spawn python process with stdio: ['pipe', 'pipe', 'pipe']
         - Set up readline on stdout to parse JSON responses
         - Route responses to pending requests by id
         - Log stderr to console.error
         - Implement health check retry loop (20 attempts, 500ms each = 10s max)
         - Set pythonReady = true on successful health check
         - Throw error if health check fails after 10 seconds

       - sendToPython(request, timeout?) function:
         - Generate unique request id
         - Write JSON to stdin with newline
         - Return promise that resolves/rejects based on response

       - stopPython() function:
         - Send shutdown action
         - Wait 1 second, then SIGTERM
         - On Windows: use taskkill to kill process tree

       - Export: startPython, stopPython, sendToPython, isPythonReady

    2. Update src/main/index.ts:
       - Import pythonManager
       - Call startPython() after app.whenReady()
       - Add ipcMain handler 'python-health-check' that calls sendToPython({action: 'health_check'})
       - Register cleanup on 'before-quit' and 'will-quit' (Windows)
       - Log Python startup time

    3. Update src/main/preload.ts:
       - Add pythonHealthCheck: () => ipcRenderer.invoke('python-health-check')

    4. Update src/renderer/renderer.ts:
       - Add button for "Test Python Sidecar"
       - On click: call window.electronAPI.pythonHealthCheck()
       - Display result showing spaCy model is loaded
       - Update type declaration for electronAPI

    Reference the patterns in 01-RESEARCH.md for exact code structure.
  </action>
  <verify>
    1. Run `npm run start`
    2. Check console for Python startup logs and timing
    3. Click "Test Python Sidecar" button
    4. Should display health check response with model name
    5. Close app, verify no zombie Python processes in Task Manager
  </verify>
  <done>
    Electron launches Python sidecar, health check succeeds within 10 seconds, clean shutdown works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure code signing and update Forge config</name>
  <files>
    forge.config.ts
    entitlements.plist
  </files>
  <action>
    1. Create entitlements.plist for macOS hardened runtime:
       ```xml
       <?xml version="1.0" encoding="UTF-8"?>
       <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
       <plist version="1.0">
       <dict>
         <key>com.apple.security.cs.allow-jit</key>
         <true/>
         <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
         <true/>
         <key>com.apple.security.cs.disable-library-validation</key>
         <true/>
       </dict>
       </plist>
       ```

    2. Update forge.config.ts with code signing configuration:
       - Import MakerNSIS from 'electron-forge-maker-nsis'
       - Update packagerConfig:
         - asar: true
         - extraResource: ['./python-dist/samsara-backend']
         - osxSign (conditional on having certs):
           - identity: 'Developer ID Application: ...' (from env or hardcoded placeholder)
           - hardened-runtime: true
           - entitlements: './entitlements.plist'
           - entitlements-inherit: './entitlements.plist'
         - osxNotarize (conditional on env vars):
           - appleId: process.env.APPLE_ID
           - appleIdPassword: process.env.APPLE_ID_PASSWORD
           - teamId: process.env.APPLE_TEAM_ID

       - Update makers array:
         - Add MakerNSIS with codesigning.azureSignOptions (conditional on env vars)
         - Keep or add @electron-forge/maker-dmg for macOS

       - Wrap signing config in conditionals so builds work without certs:
         ```typescript
         ...(process.env.APPLE_ID ? {
           osxSign: { ... },
           osxNotarize: { ... }
         } : {}),
         ```

    3. Add npm script for signed build:
       - In package.json, add: "make:signed": "electron-forge make"

    IMPORTANT: The config must gracefully handle missing signing credentials for development builds.
  </action>
  <verify>
    1. `npm run package` succeeds without signing (no env vars set)
    2. Packaged app includes python-dist/samsara-backend in resources
    3. entitlements.plist exists with correct permissions
  </verify>
  <done>
    Forge config updated with code signing placeholders. Unsigned builds work; signed builds ready when credentials available.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Electron + Python sidecar integration with:
    - Python sidecar launched by Electron
    - spaCy model loaded and responding to health checks
    - IPC working both directions (Electron -> Python -> Electron)
    - Code signing configuration ready for production
    - Packaged app with bundled Python sidecar
  </what-built>
  <how-to-verify>
    **Development mode test:**
    1. Run `npm run start`
    2. Observe console for Python startup time (should be < 10 seconds)
    3. Click "Test Python Sidecar" button
    4. Verify response shows spaCy model is loaded
    5. Close app, check Task Manager for zombie processes

    **Packaged app test (Windows):**
    1. Run `npm run package`
    2. Navigate to `out/samsara-win32-x64/`
    3. Run `samsara.exe`
    4. Repeat steps 2-5 from development test

    **Clean VM test (optional but recommended):**
    1. Copy `out/samsara-win32-x64/` folder to a Windows VM without Python
    2. Run samsara.exe
    3. Verify health check works

    **Report findings:**
    - Python startup time: _____ seconds
    - Health check response: success/failure
    - Bundle size: _____ MB
    - Any errors or warnings observed
  </how-to-verify>
  <resume-signal>
    Type "approved" with test results, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete, verify the full Phase 1 success criteria:

1. **Packaged app loads spaCy**: Health check returns model name within 10 seconds
2. **PyInstaller build completes**: No missing import errors in bundle
3. **Code signing ready**: Config accepts signing credentials (test with/without)
4. **Electron + Python IPC**: Bidirectional JSON communication works
5. **SQLite with WAL**: Database in userData folder
6. **Clean shutdown**: No zombie Python processes
</verification>

<success_criteria>
- Packaged app (out/samsara-win32-x64/samsara.exe) launches and displays UI
- Python health check succeeds within 10 seconds of app launch
- spaCy model "en_core_web_sm" reported in health check response
- No zombie Python processes after app close
- Code signing config present (uses env vars when available)
- App works on clean Windows VM without Python installed
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-distribution/01-03-SUMMARY.md`
</output>
