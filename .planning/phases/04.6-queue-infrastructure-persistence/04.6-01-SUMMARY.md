---
phase: 04.6
plan: 01
subsystem: database
tags: [sqlite, migration, queue, status-tracking]

# Dependency graph
requires: [04.5-01]  # Built on schema versioning from projects migration
provides: [cv-status-column, queue-functions]
affects: [04.6-02, 04.6-03, 04.6-04]  # Queue manager, IPC handlers, UI need these

# Tech tracking
tech-stack:
  added: []
  patterns: [schema-migration-v2, status-state-machine]

# File tracking
key-files:
  created: []
  modified: [src/main/database.ts]

# Decisions
decisions:
  - id: queue-status-values
    choice: "Four status values: queued, processing, completed, failed"
    rationale: "Minimal set covering full lifecycle with clear state transitions"
  - id: default-status-completed
    choice: "DEFAULT 'completed' for existing CVs"
    rationale: "Backward compatible - existing processed CVs remain valid"
  - id: processing-started-timestamp
    choice: "Separate processing_started_at column"
    rationale: "Enables timeout calculation from actual processing start, not submission"

# Metrics
metrics:
  duration: 6 min
  completed: 2026-01-27
---

# Phase 4.6 Plan 01: Database Schema for Queue Persistence Summary

**One-liner:** Schema migration v2 adding status column and 6 queue CRUD functions for CV lifecycle tracking.

## What Was Built

### Database Migration (Version 2)
Added three new columns to the `cvs` table:
- `status TEXT NOT NULL DEFAULT 'completed'` - Tracks CV lifecycle (queued/processing/completed/failed)
- `error_message TEXT` - Stores failure reasons for failed CVs
- `processing_started_at TEXT` - ISO timestamp for timeout calculation

Created index for efficient status filtering:
- `idx_cvs_status ON cvs(status)`

### Queue-Specific Functions
Six new exported functions for queue operations:

| Function | Purpose |
|----------|---------|
| `insertQueuedCV(input)` | Insert CV in 'queued' status before processing |
| `updateCVStatus(id, status, options?)` | Update status with optional error/startedAt |
| `completeCVProcessing(id, cv)` | Update CV with extracted data, mark completed |
| `getNextQueuedCV()` | Get next pending CV for FIFO processing |
| `getQueuedCVsByProject(projectId?)` | Get all queued/processing CVs for UI |
| `resetProcessingCVs()` | Reset stuck 'processing' CVs on app startup |

### New TypeScript Interfaces
- `QueuedCVInput` - Input for creating queued CV
- `QueuedCVRecord` - Record returned from queue queries

## Commits

| Hash | Type | Description |
|------|------|-------------|
| a3572d3 | feat | Add version 2 migration for queue status columns |
| eb25917 | feat | Add queue-specific database functions |

## Key Files

| File | Changes |
|------|---------|
| src/main/database.ts | +230 lines (migration + 6 functions + 2 interfaces) |

## Decisions Made

1. **Status State Machine**: Four values (queued -> processing -> completed/failed) provide clear lifecycle tracking without complexity.

2. **Backward Compatibility**: DEFAULT 'completed' ensures existing CVs (from before queue system) remain valid and display correctly.

3. **Timeout Architecture**: Separate `processing_started_at` column enables timeout calculation from actual processing start rather than submission time, fixing the timeout bug.

4. **FIFO Processing**: `getNextQueuedCV()` orders by `created_at ASC` for fair first-in-first-out queue behavior.

5. **Crash Recovery**: `resetProcessingCVs()` resets stuck CVs on app startup, ensuring queue can recover from crashes.

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

**Ready for Plan 04.6-02:** Queue manager can now use these functions to:
- Insert CVs on drop via `insertQueuedCV()`
- Track processing via `updateCVStatus()`
- Complete processing via `completeCVProcessing()`
- Get next item via `getNextQueuedCV()`
- Recover from crashes via `resetProcessingCVs()`

**Dependencies satisfied:**
- Status column exists for UI to query
- Index exists for efficient filtering
- All CRUD operations available for IPC handlers
