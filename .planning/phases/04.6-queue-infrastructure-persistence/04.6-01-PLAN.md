---
phase: 04.6-queue-infrastructure-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/database.ts
autonomous: true

must_haves:
  truths:
    - "CVs persist to database immediately on drop with status column"
    - "Status column tracks lifecycle: queued -> processing -> completed/failed"
    - "Existing CVs default to 'completed' status (backward compatible)"
  artifacts:
    - path: "src/main/database.ts"
      provides: "CV status column, queue insertion/update functions"
      contains: "status TEXT"
  key_links:
    - from: "src/main/database.ts"
      to: "cv status tracking"
      via: "schema migration version 2"
      pattern: "user_version = 2"
---

<objective>
Add status column to cvs table for queue state persistence.

Purpose: CVs must persist to database immediately on drop with status tracking (queued/processing/completed/failed) so queue survives navigation and app restarts.

Output: Database schema migration adding status column, plus CRUD functions for queue operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.6-queue-infrastructure-persistence/04.6-RESEARCH.md
@src/main/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add status column to cvs table via migration</name>
  <files>src/main/database.ts</files>
  <action>
Add schema migration for version 2 that:
1. Adds `status TEXT NOT NULL DEFAULT 'completed'` column to cvs table
2. Adds `error_message TEXT` column for storing failure reasons
3. Adds `processing_started_at TEXT` column for timeout calculation
4. Creates index on status column for efficient filtering: `CREATE INDEX IF NOT EXISTS idx_cvs_status ON cvs(status)`

Migration logic (within the existing if version < 2 pattern):
```typescript
if (version < 2) {
  console.log('Migrating database to version 2 (queue status)...');

  // Check if columns exist before adding
  const cvColumns = db.prepare("PRAGMA table_info(cvs)").all() as { name: string }[];

  if (!cvColumns.some(col => col.name === 'status')) {
    db.exec(`ALTER TABLE cvs ADD COLUMN status TEXT NOT NULL DEFAULT 'completed'`);
  }
  if (!cvColumns.some(col => col.name === 'error_message')) {
    db.exec(`ALTER TABLE cvs ADD COLUMN error_message TEXT`);
  }
  if (!cvColumns.some(col => col.name === 'processing_started_at')) {
    db.exec(`ALTER TABLE cvs ADD COLUMN processing_started_at TEXT`);
  }

  db.exec(`CREATE INDEX IF NOT EXISTS idx_cvs_status ON cvs(status)`);
  db.pragma('user_version = 2');
  console.log('Database migrated to version 2');
}
```

Important: Place this migration AFTER the version < 1 block, so migrations run in order.
  </action>
  <verify>App starts without error. Run `SELECT * FROM cvs LIMIT 1` via sqlite3 CLI or log to confirm status column exists.</verify>
  <done>CVs table has status, error_message, and processing_started_at columns. Existing CVs have status='completed'.</done>
</task>

<task type="auto">
  <name>Task 2: Add queue-specific database functions</name>
  <files>src/main/database.ts</files>
  <action>
Add new functions for queue operations:

1. **insertQueuedCV** - Insert a CV in 'queued' status (before processing):
```typescript
export interface QueuedCVInput {
  filePath: string;
  fileName: string;
  projectId?: string;
}

export function insertQueuedCV(input: QueuedCVInput): string {
  const database = getDatabase();
  const id = crypto.randomUUID();
  const now = new Date().toISOString();

  const stmt = database.prepare(`
    INSERT INTO cvs (
      id, file_path, file_name, created_at, updated_at,
      contact_json, contact_confidence, parse_confidence,
      status, project_id
    ) VALUES (?, ?, ?, ?, ?, '{}', 0, 0, 'queued', ?)
  `);

  stmt.run(id, input.filePath, input.fileName, now, now, input.projectId || null);
  console.log(`Inserted queued CV with ID: ${id}`);
  return id;
}
```

2. **updateCVStatus** - Update status and optionally set error:
```typescript
export function updateCVStatus(
  id: string,
  status: 'queued' | 'processing' | 'completed' | 'failed',
  options?: { error?: string; startedAt?: string }
): boolean {
  const database = getDatabase();
  const now = new Date().toISOString();

  let query = 'UPDATE cvs SET status = ?, updated_at = ?';
  const params: unknown[] = [status, now];

  if (options?.error !== undefined) {
    query += ', error_message = ?';
    params.push(options.error);
  }
  if (options?.startedAt !== undefined) {
    query += ', processing_started_at = ?';
    params.push(options.startedAt);
  }

  query += ' WHERE id = ?';
  params.push(id);

  const result = database.prepare(query).run(...params);
  return result.changes > 0;
}
```

3. **completeCVProcessing** - Update CV with extracted data and mark completed:
```typescript
export function completeCVProcessing(id: string, cv: ParsedCV): boolean {
  const database = getDatabase();
  const now = new Date().toISOString();
  const contactConfidence = calculateContactConfidence(cv.contact);

  const stmt = database.prepare(`
    UPDATE cvs SET
      status = 'completed',
      updated_at = ?,
      contact_json = ?,
      contact_confidence = ?,
      work_history_json = ?,
      education_json = ?,
      skills_json = ?,
      certifications_json = ?,
      languages_json = ?,
      other_sections_json = ?,
      raw_text = ?,
      section_order_json = ?,
      parse_confidence = ?,
      warnings_json = ?,
      parse_time_ms = ?,
      error_message = NULL
    WHERE id = ?
  `);

  const result = stmt.run(
    now,
    JSON.stringify(cv.contact),
    contactConfidence,
    cv.work_history ? JSON.stringify(cv.work_history) : null,
    cv.education ? JSON.stringify(cv.education) : null,
    cv.skills ? JSON.stringify(cv.skills) : null,
    cv.certifications ? JSON.stringify(cv.certifications) : null,
    cv.languages ? JSON.stringify(cv.languages) : null,
    cv.other_sections ? JSON.stringify(cv.other_sections) : null,
    cv.raw_text || null,
    cv.section_order ? JSON.stringify(cv.section_order) : null,
    cv.parse_confidence,
    cv.warnings ? JSON.stringify(cv.warnings) : null,
    cv.extract_time_ms || null,
    id
  );

  return result.changes > 0;
}
```

4. **getNextQueuedCV** - Get next pending CV for processing:
```typescript
export interface QueuedCVRecord {
  id: string;
  file_path: string;
  file_name: string;
  project_id: string | null;
  created_at: string;
}

export function getNextQueuedCV(): QueuedCVRecord | null {
  const database = getDatabase();
  const stmt = database.prepare(`
    SELECT id, file_path, file_name, project_id, created_at
    FROM cvs
    WHERE status = 'queued'
    ORDER BY created_at ASC
    LIMIT 1
  `);
  return (stmt.get() as QueuedCVRecord) || null;
}
```

5. **getQueuedCVsByProject** - Get all queued/processing CVs for UI display:
```typescript
export function getQueuedCVsByProject(projectId?: string): Array<{
  id: string;
  file_name: string;
  file_path: string;
  status: string;
  error_message: string | null;
  created_at: string;
}> {
  const database = getDatabase();

  let query = `
    SELECT id, file_name, file_path, status, error_message, created_at
    FROM cvs
    WHERE status IN ('queued', 'processing')
  `;

  const params: unknown[] = [];
  if (projectId) {
    query += ' AND project_id = ?';
    params.push(projectId);
  }

  query += ' ORDER BY created_at ASC';

  const stmt = database.prepare(query);
  return params.length ? stmt.all(...params) as any[] : stmt.all() as any[];
}
```

6. **resetProcessingCVs** - On app startup, reset stuck 'processing' CVs to 'queued':
```typescript
export function resetProcessingCVs(): number {
  const database = getDatabase();
  const result = database.prepare(`
    UPDATE cvs SET status = 'queued', processing_started_at = NULL
    WHERE status = 'processing'
  `).run();

  if (result.changes > 0) {
    console.log(`Reset ${result.changes} processing CVs to queued state`);
  }
  return result.changes;
}
```
  </action>
  <verify>TypeScript compiles without errors. Functions are exported and callable.</verify>
  <done>Database has queue-specific functions: insertQueuedCV, updateCVStatus, completeCVProcessing, getNextQueuedCV, getQueuedCVsByProject, resetProcessingCVs.</done>
</task>

</tasks>

<verification>
1. Start the app - database migration runs without error
2. Check logs for "Database migrated to version 2"
3. Open sqlite3 CLI: `sqlite3 path/to/samsara.db "PRAGMA table_info(cvs);"` shows status, error_message, processing_started_at columns
4. TypeScript compiles: `npm run typecheck` passes
</verification>

<success_criteria>
- Database schema includes status column with index
- All 6 queue functions compile and are exported
- Existing CVs have status='completed' (backward compatible)
- Migration is idempotent (can run multiple times safely)
</success_criteria>

<output>
After completion, create `.planning/phases/04.6-queue-infrastructure-persistence/04.6-01-SUMMARY.md`
</output>
