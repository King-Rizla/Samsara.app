---
phase: "04.8"
plan: "01"
subsystem: "database"
tags: ["sqlite", "migration", "matching-metadata", "schema"]
dependency-graph:
  requires: ["04-jd-matching"]
  provides: ["matching_metadata_json column on job_descriptions"]
  affects: ["04.8-02", "04.8-03"]
tech-stack:
  added: []
  patterns: ["idempotent migration with column existence check"]
key-files:
  created: []
  modified: ["src/main/database.ts"]
decisions:
  - id: "04.8-01-1"
    decision: "Nullable TEXT column for matching_metadata_json (no default)"
    rationale: "Existing JDs have no metadata; null signals 'not yet generated'"
metrics:
  duration: "4 min"
  completed: "2026-01-28"
---

# Phase 4.8 Plan 01: Database Schema for Matching Metadata Summary

**One-liner:** Migration v4 adds matching_metadata_json column to job_descriptions with idempotent ALTER TABLE and updated insertJD/getJD functions.

## What Was Done

### Task 1: Add database migration v4
- Added migration block for `version < 4` after existing version 3 block
- Column existence check via `PRAGMA table_info` before `ALTER TABLE`
- Sets `user_version = 4` after successful migration

### Task 2: Update insertJD and getJD functions
- Added `matching_metadata?: unknown` to `ParsedJD` interface
- `insertJD` now includes `matching_metadata_json` in INSERT (14 values)
- `getJD` parses and returns `matching_metadata` from stored JSON
- Null handling ensures backward compatibility

## Deviations from Plan

None - plan executed exactly as written.

## Verification

- Lint passes (no new errors introduced)
- Migration is idempotent (column existence check before ALTER TABLE)
- Existing JDs unaffected (nullable column, optional interface field)

## Commits

| Hash | Message |
|------|---------|
| d87bf1e | feat(04.8-01): add database migration v4 for matching_metadata_json |
| a25a9bb | feat(04.8-01): update insertJD and getJD for matching_metadata |
