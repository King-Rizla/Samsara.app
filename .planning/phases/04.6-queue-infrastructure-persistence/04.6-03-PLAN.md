---
phase: 04.6-queue-infrastructure-persistence
plan: 03
type: execute
wave: 2
depends_on: ["04.6-01"]
files_modified:
  - src/main/preload.ts
  - src/renderer/types/cv.ts
autonomous: true

must_haves:
  truths:
    - "Renderer can enqueue CVs via window.api.enqueueCV"
    - "Renderer can subscribe to queue status updates via window.api.onQueueStatusUpdate"
    - "Renderer can unsubscribe from updates via window.api.removeQueueStatusListener"
  artifacts:
    - path: "src/main/preload.ts"
      provides: "enqueueCV, onQueueStatusUpdate, removeQueueStatusListener APIs"
      exports: ["enqueueCV", "onQueueStatusUpdate", "removeQueueStatusListener"]
    - path: "src/renderer/types/cv.ts"
      provides: "Updated type declarations for new APIs"
      contains: "enqueueCV"
  key_links:
    - from: "src/main/preload.ts"
      to: "queue-status-update channel"
      via: "ipcRenderer.on"
      pattern: "ipcRenderer\\.on\\('queue-status-update'"
---

<objective>
Add preload API for queue operations and push-based status updates.

Purpose: The renderer needs to enqueue CVs and receive real-time status updates from the main process. This plan adds the IPC bridge (preload) for these operations.

Output: Preload API with enqueueCV, onQueueStatusUpdate, removeQueueStatusListener methods.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.6-queue-infrastructure-persistence/04.6-RESEARCH.md
@src/main/preload.ts
@src/renderer/types/cv.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add queue operations to preload API</name>
  <files>src/main/preload.ts</files>
  <action>
Update `src/main/preload.ts` to add queue-related methods:

1. Add type interfaces at the top (after existing interfaces):
```typescript
interface EnqueueResult {
  success: boolean;
  id?: string;
  error?: string;
}

interface QueueStatusUpdate {
  id: string;
  status: 'queued' | 'processing' | 'completed' | 'failed';
  data?: unknown;  // ParsedCV
  error?: string;
  parseConfidence?: number;
}

interface QueuedCV {
  id: string;
  file_name: string;
  file_path: string;
  status: string;
  error_message: string | null;
  created_at: string;
}

interface GetQueuedCVsResult {
  success: boolean;
  data?: QueuedCV[];
  error?: string;
}
```

2. Add new methods to the `api` object in contextBridge.exposeInMainWorld:
```typescript
// Queue operations

/**
 * Enqueue a CV for processing.
 * Immediately persists to database with status='queued'.
 * Returns { success: boolean, id?: string, error?: string }
 */
enqueueCV: (fileName: string, filePath: string, projectId?: string): Promise<EnqueueResult> =>
  ipcRenderer.invoke('enqueue-cv', fileName, filePath, projectId),

/**
 * Get all queued/processing CVs for a project.
 * Returns { success: boolean, data?: QueuedCV[], error?: string }
 */
getQueuedCVs: (projectId?: string): Promise<GetQueuedCVsResult> =>
  ipcRenderer.invoke('get-queued-cvs', projectId),

/**
 * Subscribe to queue status updates from main process.
 * Called when CV status changes (queued -> processing -> completed/failed).
 */
onQueueStatusUpdate: (callback: (update: QueueStatusUpdate) => void): void => {
  ipcRenderer.on('queue-status-update', (_event, update) => callback(update));
},

/**
 * Unsubscribe from queue status updates.
 * Call in cleanup/useEffect return to prevent memory leaks.
 */
removeQueueStatusListener: (): void => {
  ipcRenderer.removeAllListeners('queue-status-update');
},
```
  </action>
  <verify>TypeScript compiles: `npm run typecheck` passes.</verify>
  <done>Preload exposes enqueueCV, getQueuedCVs, onQueueStatusUpdate, removeQueueStatusListener via contextBridge.</done>
</task>

<task type="auto">
  <name>Task 2: Update renderer type declarations</name>
  <files>src/renderer/types/cv.ts</files>
  <action>
Update `src/renderer/types/cv.ts` to include the new API methods:

1. Update `QueueStatus` type to include 'queued':
```typescript
export type QueueStatus = 'queued' | 'submitted' | 'completed' | 'failed';
```

Note: Keep 'submitted' for backward compatibility with existing code that might use it. The queue manager uses 'processing' but the UI can treat 'submitted' and 'queued' as pending states.

2. Add new type for queue status updates:
```typescript
export interface QueueStatusUpdate {
  id: string;
  status: 'queued' | 'processing' | 'completed' | 'failed';
  data?: ParsedCV;
  error?: string;
  parseConfidence?: number;
}
```

3. Update the global Window interface to include new API methods:
```typescript
declare global {
  interface Window {
    api: {
      // ... existing methods ...
      extractCV: (filePath: string, projectId?: string) => Promise<{ success: boolean; data?: ParsedCV; id?: string; totalTime?: number; error?: string }>;
      getAllCVs: (projectId?: string) => Promise<{ success: boolean; data?: { id: string; file_name: string; file_path?: string; contact_json: string; parse_confidence: number; created_at: string }[]; error?: string }>;
      selectCVFile: () => Promise<{ success: boolean; filePath?: string; fileName?: string; canceled?: boolean }>;
      getCV: (cvId: string) => Promise<{ success: boolean; data?: ParsedCV; error?: string }>;
      updateCVField: (cvId: string, fieldPath: string, value: unknown) => Promise<{ success: boolean; error?: string }>;
      deleteCV: (cvId: string) => Promise<{ success: boolean; error?: string }>;
      reprocessCV: (filePath: string, projectId?: string) => Promise<{ success: boolean; data?: ParsedCV; error?: string }>;

      // Queue operations (new)
      enqueueCV: (fileName: string, filePath: string, projectId?: string) => Promise<{ success: boolean; id?: string; error?: string }>;
      getQueuedCVs: (projectId?: string) => Promise<{ success: boolean; data?: { id: string; file_name: string; file_path: string; status: string; error_message: string | null; created_at: string }[]; error?: string }>;
      onQueueStatusUpdate: (callback: (update: QueueStatusUpdate) => void) => void;
      removeQueueStatusListener: () => void;
    };
    electronFile: {
      getPath: (file: File) => string | null;
    };
  }
}
```
  </action>
  <verify>TypeScript compiles: `npm run typecheck` passes. Types are correctly declared.</verify>
  <done>Renderer types updated with QueueStatusUpdate and new API method signatures.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run typecheck` passes
2. No type errors when using window.api.enqueueCV in renderer code
3. QueueStatusUpdate type available in renderer
</verification>

<success_criteria>
- Preload exposes enqueueCV for submitting CVs to queue
- Preload exposes onQueueStatusUpdate for subscribing to push updates
- Preload exposes removeQueueStatusListener for cleanup
- TypeScript types correctly declared in renderer
</success_criteria>

<output>
After completion, create `.planning/phases/04.6-queue-infrastructure-persistence/04.6-03-SUMMARY.md`
</output>
