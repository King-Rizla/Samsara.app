---
phase: 04.7-dashboard-enhancements
plan: 05
type: execute
wave: 3
depends_on: ["04.7-03", "04.7-04"]
files_modified:
  - src/renderer/stores/usageStore.ts
  - src/renderer/components/dashboard/StatsStrip.tsx
  - src/renderer/components/dashboard/ProjectCard.tsx
  - src/renderer/components/dashboard/UsageWarning.tsx
  - src/renderer/components/settings/UsageLimits.tsx
  - src/renderer/routes/Dashboard.tsx
  - src/renderer/routes/Settings.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard stats strip shows total token usage"
    - "Project cards show per-project token count"
    - "Warning banner appears when approaching usage limit"
    - "Settings page allows configuring global token limit"
  artifacts:
    - path: "src/renderer/stores/usageStore.ts"
      provides: "Zustand store for usage state"
      contains: "useUsageStore"
    - path: "src/renderer/components/dashboard/UsageWarning.tsx"
      provides: "Warning banner component"
      contains: "AlertTriangle"
    - path: "src/renderer/components/settings/UsageLimits.tsx"
      provides: "Usage limit configuration UI"
      contains: "globalTokenLimit"
  key_links:
    - from: "src/renderer/routes/Dashboard.tsx"
      to: "src/renderer/stores/usageStore.ts"
      via: "useUsageStore hook"
      pattern: "useUsageStore"
---

<objective>
Integrate usage tracking into UI - display in dashboard, project cards, and settings.

Purpose: Gives users visibility into token/API usage and ability to set limits.
Output: Complete UI for usage tracking with warnings and settings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.7-dashboard-enhancements/04.7-RESEARCH.md
@.planning/phases/04.7-dashboard-enhancements/04.7-03-SUMMARY.md
@.planning/phases/04.7-dashboard-enhancements/04.7-04-SUMMARY.md
@src/renderer/stores/queueStore.ts
@src/renderer/components/dashboard/StatsStrip.tsx
@src/renderer/components/dashboard/ProjectCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usage store</name>
  <files>src/renderer/stores/usageStore.ts</files>
  <action>
    Create a new Zustand store for usage tracking. Follow existing store patterns from queueStore.ts.

    ```typescript
    import { create } from 'zustand';

    interface UsageStats {
      totalTokens: number;
      requestCount: number;
    }

    interface UsageState {
      // Usage data
      globalUsage: UsageStats;
      projectUsage: Record<string, UsageStats>;

      // Settings (cached from main process)
      globalTokenLimit: number | null;
      warningThreshold: number;

      // Loading state
      isLoading: boolean;

      // Actions
      loadUsage: () => Promise<void>;
      loadSettings: () => Promise<void>;
      isOverLimit: () => boolean;
      isNearLimit: () => boolean;
      getProjectUsage: (projectId: string) => UsageStats;
    }

    export const useUsageStore = create<UsageState>((set, get) => ({
      globalUsage: { totalTokens: 0, requestCount: 0 },
      projectUsage: {},
      globalTokenLimit: null,
      warningThreshold: 80,
      isLoading: true,

      loadUsage: async () => {
        try {
          const result = await window.api.getUsageStats();
          if (result.success && result.data) {
            set({
              globalUsage: result.data.global,
              projectUsage: result.data.byProject,
              isLoading: false,
            });
          }
        } catch (error) {
          console.error('Failed to load usage:', error);
          set({ isLoading: false });
        }
      },

      loadSettings: async () => {
        try {
          const result = await window.api.getAppSettings();
          if (result.success && result.data) {
            set({
              globalTokenLimit: result.data.globalTokenLimit ?? null,
              warningThreshold: result.data.warningThreshold,
            });
          }
        } catch (error) {
          console.error('Failed to load settings:', error);
        }
      },

      isOverLimit: () => {
        const { globalUsage, globalTokenLimit } = get();
        if (globalTokenLimit === null) return false;
        return globalUsage.totalTokens >= globalTokenLimit;
      },

      isNearLimit: () => {
        const { globalUsage, globalTokenLimit, warningThreshold } = get();
        if (globalTokenLimit === null) return false;
        const threshold = (globalTokenLimit * warningThreshold) / 100;
        return globalUsage.totalTokens >= threshold && !get().isOverLimit();
      },

      getProjectUsage: (projectId: string) => {
        const { projectUsage } = get();
        return projectUsage[projectId] ?? { totalTokens: 0, requestCount: 0 };
      },
    }));
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>usageStore created with state and actions</done>
</task>

<task type="auto">
  <name>Task 2: Create UsageWarning component</name>
  <files>src/renderer/components/dashboard/UsageWarning.tsx</files>
  <action>
    Create a warning banner that shows when near or over usage limit.

    ```typescript
    import { AlertTriangle } from 'lucide-react';
    import { useUsageStore } from '../../stores/usageStore';

    export function UsageWarning() {
      const { globalUsage, globalTokenLimit, isOverLimit, isNearLimit } = useUsageStore();

      if (globalTokenLimit === null) return null;

      if (isOverLimit()) {
        return (
          <div className="bg-destructive/10 border border-destructive rounded-md p-4 mb-4 flex items-start gap-3">
            <AlertTriangle className="h-5 w-5 text-destructive shrink-0 mt-0.5" />
            <div>
              <p className="font-medium text-destructive">Usage Limit Reached</p>
              <p className="text-sm text-destructive/80">
                You have used {globalUsage.totalTokens.toLocaleString()} of {globalTokenLimit.toLocaleString()} tokens.
                Processing is paused. Increase your limit in Settings to continue.
              </p>
            </div>
          </div>
        );
      }

      if (isNearLimit()) {
        const percentage = Math.round((globalUsage.totalTokens / globalTokenLimit) * 100);
        return (
          <div className="bg-yellow-500/10 border border-yellow-500 rounded-md p-4 mb-4 flex items-start gap-3">
            <AlertTriangle className="h-5 w-5 text-yellow-500 shrink-0 mt-0.5" />
            <div>
              <p className="font-medium text-yellow-500">Approaching Usage Limit</p>
              <p className="text-sm text-yellow-500/80">
                You have used {globalUsage.totalTokens.toLocaleString()} of {globalTokenLimit.toLocaleString()} tokens ({percentage}%).
              </p>
            </div>
          </div>
        );
      }

      return null;
    }
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>UsageWarning component shows appropriate warning</done>
</task>

<task type="auto">
  <name>Task 3: Update StatsStrip with token usage</name>
  <files>src/renderer/components/dashboard/StatsStrip.tsx</files>
  <action>
    Add token usage to the stats strip. Import store and add new stat card.

    Update imports:
    ```typescript
    import { FileText, Briefcase, Clock, Coins } from 'lucide-react';
    ```

    Update the StatsStripProps interface to include tokens:
    ```typescript
    interface StatsStripProps {
      totalCVs: number;
      totalJDs: number;
      timeSaved: string;
      totalTokens?: number;  // Optional for backward compatibility
    }
    ```

    Update the stats array:
    ```typescript
    const stats = [
      { label: 'CVs Processed', value: totalCVs, icon: FileText },
      { label: 'Job Descriptions', value: totalJDs, icon: Briefcase },
      { label: 'Time Saved', value: timeSaved, icon: Clock },
    ];

    // Add tokens stat if provided
    if (totalTokens !== undefined) {
      stats.push({
        label: 'Tokens Used',
        value: totalTokens.toLocaleString(),
        icon: Coins,
      });
    }
    ```

    Alternatively, make it always show but format nicely:
    ```typescript
    const formatTokens = (tokens: number) => {
      if (tokens >= 1000000) return `${(tokens / 1000000).toFixed(1)}M`;
      if (tokens >= 1000) return `${(tokens / 1000).toFixed(1)}K`;
      return tokens.toString();
    };
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>StatsStrip shows token usage count</done>
</task>

<task type="auto">
  <name>Task 4: Update ProjectCard with token display</name>
  <files>src/renderer/components/dashboard/ProjectCard.tsx</files>
  <action>
    Add per-project token usage to the ProjectCard. Update props and display.

    Update ProjectCardProps:
    ```typescript
    interface ProjectCardProps {
      project: Project;
      tokenUsage?: number;  // Tokens used by this project
      onArchive: (id: string) => void;
      onDelete: (id: string) => void;
    }
    ```

    Add token display in CardContent (after CV/JD counts):
    ```typescript
    <CardContent>
      <div className="flex gap-4 text-sm text-muted-foreground">
        <span>{project.cv_count} CVs</span>
        <span>{project.jd_count} JDs</span>
        {tokenUsage !== undefined && tokenUsage > 0 && (
          <span className="flex items-center gap-1">
            <Coins className="h-3 w-3" />
            {tokenUsage.toLocaleString()} tokens
          </span>
        )}
      </div>
      <p className="text-xs text-muted-foreground mt-2">
        Last activity: {formatDate(project.updated_at)}
      </p>
    </CardContent>
    ```

    Import Coins icon:
    ```typescript
    import { MoreHorizontal, Archive, Trash2, Coins } from 'lucide-react';
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>ProjectCard shows per-project token usage</done>
</task>

<task type="auto">
  <name>Task 5: Create UsageLimits settings component</name>
  <files>src/renderer/components/settings/UsageLimits.tsx</files>
  <action>
    Create a new component for configuring usage limits.

    ```typescript
    import { useState, useEffect } from 'react';
    import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '../ui/card';
    import { Input } from '../ui/input';
    import { Label } from '../ui/label';
    import { Button } from '../ui/button';
    import { useUsageStore } from '../../stores/usageStore';

    export function UsageLimits() {
      const { globalTokenLimit, warningThreshold, globalUsage, loadSettings } = useUsageStore();

      const [limit, setLimit] = useState<string>(globalTokenLimit?.toString() ?? '');
      const [threshold, setThreshold] = useState<string>(warningThreshold.toString());
      const [isSaving, setIsSaving] = useState(false);

      useEffect(() => {
        setLimit(globalTokenLimit?.toString() ?? '');
        setThreshold(warningThreshold.toString());
      }, [globalTokenLimit, warningThreshold]);

      const handleSave = async () => {
        setIsSaving(true);
        try {
          const updates: { globalTokenLimit?: number; warningThreshold?: number } = {};

          // Parse limit (empty = unlimited)
          if (limit.trim() === '' || limit === '0') {
            updates.globalTokenLimit = undefined;
          } else {
            const parsed = parseInt(limit, 10);
            if (!isNaN(parsed) && parsed > 0) {
              updates.globalTokenLimit = parsed;
            }
          }

          // Parse threshold
          const parsedThreshold = parseInt(threshold, 10);
          if (!isNaN(parsedThreshold) && parsedThreshold > 0 && parsedThreshold <= 100) {
            updates.warningThreshold = parsedThreshold;
          }

          await window.api.updateAppSettings(updates);
          await loadSettings();
        } catch (error) {
          console.error('Failed to save settings:', error);
        } finally {
          setIsSaving(false);
        }
      };

      return (
        <Card className="bg-card border-border">
          <CardHeader>
            <CardTitle>Usage Limits</CardTitle>
            <CardDescription>
              Configure monthly token limits to control API costs
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="token-limit">Monthly Token Limit</Label>
              <Input
                id="token-limit"
                type="number"
                placeholder="Unlimited"
                value={limit}
                onChange={(e) => setLimit(e.target.value)}
                className="bg-background"
              />
              <p className="text-xs text-muted-foreground">
                Leave empty for unlimited. Current usage: {globalUsage.totalTokens.toLocaleString()} tokens
              </p>
            </div>

            <div className="space-y-2">
              <Label htmlFor="warning-threshold">Warning Threshold (%)</Label>
              <Input
                id="warning-threshold"
                type="number"
                min="1"
                max="100"
                value={threshold}
                onChange={(e) => setThreshold(e.target.value)}
                className="bg-background"
              />
              <p className="text-xs text-muted-foreground">
                Show warning when usage reaches this percentage of the limit
              </p>
            </div>

            <Button onClick={handleSave} disabled={isSaving}>
              {isSaving ? 'Saving...' : 'Save Limits'}
            </Button>
          </CardContent>
        </Card>
      );
    }
    ```

    If Input component doesn't exist, create it or use basic HTML input styled with Tailwind:
    ```typescript
    <input
      type="number"
      className="w-full px-3 py-2 rounded-md bg-background border border-input text-sm"
      ...
    />
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>UsageLimits component allows configuring token limits</done>
</task>

<task type="auto">
  <name>Task 6: Integrate into Dashboard and Settings routes</name>
  <files>
    src/renderer/routes/Dashboard.tsx
    src/renderer/routes/Settings.tsx
  </files>
  <action>
    Update Dashboard.tsx to load and display usage:

    1. Import store and components:
    ```typescript
    import { useUsageStore } from '../stores/usageStore';
    import { UsageWarning } from '../components/dashboard/UsageWarning';
    ```

    2. Add useEffect to load usage on mount:
    ```typescript
    const { globalUsage, projectUsage, loadUsage, loadSettings, getProjectUsage } = useUsageStore();

    useEffect(() => {
      loadUsage();
      loadSettings();
    }, [loadUsage, loadSettings]);
    ```

    3. Add UsageWarning at top of dashboard content:
    ```tsx
    <main className="...">
      <UsageWarning />
      <StatsStrip
        totalCVs={totalCVs}
        totalJDs={totalJDs}
        timeSaved={timeSaved}
        totalTokens={globalUsage.totalTokens}
      />
      ...
    </main>
    ```

    4. Pass tokenUsage to each ProjectCard:
    ```tsx
    <ProjectCard
      key={project.id}
      project={project}
      tokenUsage={getProjectUsage(project.id).totalTokens}
      onArchive={handleArchive}
      onDelete={handleDelete}
    />
    ```

    Update Settings.tsx (create if doesn't exist, or update if it does):

    1. Import UsageLimits:
    ```typescript
    import { UsageLimits } from '../components/settings/UsageLimits';
    ```

    2. Add to settings page layout:
    ```tsx
    <div className="space-y-6">
      <LLMSettings />
      <UsageLimits />
    </div>
    ```

    If Settings route doesn't exist, check what the Settings sidebar button navigates to and add the component there, OR create a new Settings.tsx route.
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>Dashboard shows usage stats and warnings, Settings has usage limit controls</done>
</task>

</tasks>

<verification>
After all tasks:
1. Run `npm run lint --quiet` - no errors
2. Run `npm run build` - builds successfully
3. Manual test: Dashboard shows token count in stats strip
4. Manual test: Project cards show per-project token usage
5. Manual test: Set a low limit in Settings, see warning appear on Dashboard
</verification>

<success_criteria>
- usageStore loads and caches usage data
- UsageWarning appears when near/over limit
- StatsStrip shows total tokens used
- ProjectCard shows per-project tokens
- Settings page has UsageLimits component
- Warning and limit states work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/04.7-dashboard-enhancements/04.7-05-SUMMARY.md`
</output>
