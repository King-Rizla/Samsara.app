---
phase: 06-bulk-processing
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/renderer/components/queue/QueueList.tsx
  - src/renderer/components/queue/QueueTabs.tsx
  - src/renderer/components/queue/QueueControls.tsx
  - package.json
autonomous: false

must_haves:
  truths:
    - "QueueList renders 100+ items without jank or scroll lag"
    - "User can click 'Retry All Failed' to requeue all failed CVs in one action"
    - "Bulk processing of 100 CVs completes without memory growth visible in Electron DevTools"
    - "A summary toast appears after a batch completes: 'X succeeded, Y failed'"
  artifacts:
    - path: "src/renderer/components/queue/QueueList.tsx"
      provides: "Virtualized list using @tanstack/react-virtual for 100+ items"
      contains: "useVirtualizer"
    - path: "src/renderer/components/queue/QueueControls.tsx"
      provides: "Retry All Failed button"
      contains: "Retry All"
  key_links:
    - from: "src/renderer/components/queue/QueueList.tsx"
      to: "@tanstack/react-virtual"
      via: "useVirtualizer hook"
      pattern: "useVirtualizer"
    - from: "src/renderer/components/queue/QueueControls.tsx"
      to: "src/renderer/stores/queueStore.ts"
      via: "retryFailed with all failed IDs"
      pattern: "retryFailed"
---

<objective>
Add list virtualization for large queues and batch completion UX (retry-all, summary toast).

Purpose: Ensure the UI remains responsive when processing 100+ CVs and give users bulk failure recovery tools.

Output: Virtualized QueueList with @tanstack/react-virtual, "Retry All Failed" button, and batch completion summary toast.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-bulk-processing/06-CONTEXT.md
@.planning/phases/06-bulk-processing/06-RESEARCH.md
@.planning/phases/06-bulk-processing/06-01-SUMMARY.md
@src/renderer/components/queue/QueueList.tsx
@src/renderer/components/queue/QueueTabs.tsx
@src/renderer/components/queue/QueueControls.tsx
@src/renderer/stores/queueStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @tanstack/react-virtual and virtualize QueueList</name>
  <files>package.json, src/renderer/components/queue/QueueList.tsx</files>
  <action>
    1. Install `@tanstack/react-virtual@^3.13.0` as a dependency: `npm install @tanstack/react-virtual`

    2. Rewrite QueueList.tsx to use virtualization:
       - Import `useVirtualizer` from `@tanstack/react-virtual`
       - Create a parent scroll container div with `ref={parentRef}` and `overflow-y: auto`, `height: 100%`
       - Use `useVirtualizer({ count: items.length, getScrollElement: () => parentRef.current, estimateSize: () => 72, overscan: 5 })`
       - **IMPORTANT:** Set `useFlushSync: false` in virtualizer options to avoid React 19 flushSync warnings
       - Render virtualizer rows with absolute positioning (`position: absolute, top: virtualRow.start, height: virtualRow.size`)
       - Inner div uses `height: totalSize` for scroll area
       - Each virtual row renders `<QueueItem>` for the corresponding item
       - Keep existing empty state rendering when items.length === 0
       - Preserve the existing `onExport` prop passthrough

    3. Ensure the parent container in QueueTabs.tsx gives QueueList proper height constraints (it already uses `flex-1 min-h-0` which should work).

  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx vitest run` passes
    - `@tanstack/react-virtual` is in package.json dependencies
  </verify>
  <done>
    QueueList renders items via virtualization. Only visible rows + 5 overscan rows are in the DOM at any time. Scrolling through 100+ items is smooth.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Retry All Failed button and batch summary toast</name>
  <files>src/renderer/components/queue/QueueControls.tsx, src/renderer/components/queue/QueueTabs.tsx</files>
  <action>
    1. In QueueControls.tsx, add a "Retry All Failed" button:
       - Only visible when there are failed items (check queueStore items with status === 'failed')
       - On click, collect all failed item IDs and call `queueStore.retryFailed(failedIds)` (this method already exists)
       - Style consistently with existing control buttons
       - Disable while retry is in progress (use local loading state)

    2. Add a batch completion detection mechanism in QueueTabs.tsx (or a new small hook):
       - Track when a batch is "in progress" (more than 5 items in queued/submitted state)
       - When all items in the batch transition to completed or failed (submitted count drops to 0 after being > 5), show a summary toast
       - Toast message: "Batch complete: X succeeded, Y failed" using the project's existing toast system (check for sonner or similar)
       - If no toast library exists, use a simple auto-dismissing notification div at the top of QueueTabs
       - Only trigger once per batch (use a ref to track previous submitted count)

  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx vitest run` passes
    - "Retry All Failed" button appears when failed items exist
  </verify>
  <done>
    "Retry All Failed" button requeues all failed CVs. Batch completion summary notification shows success/fail counts.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Virtualized queue list for 100+ items, Retry All Failed button, and batch summary notification.
  </what-built>
  <how-to-verify>
    1. Drop a folder with 10+ CV files — verify files trickle into Submitted tab
    2. Scroll through the list — verify smooth scrolling (no jank)
    3. After batch completes, verify summary notification appears
    4. If any CVs failed, verify "Retry All Failed" button appears and works
    5. Open DevTools → Memory tab, check no significant memory growth during/after batch
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors
2. `npx vitest run` — existing tests pass
3. Manual: Process 10+ CVs, verify virtualization, retry-all, summary toast
4. DevTools Memory: No significant growth after batch completion
</verification>

<success_criteria>

- QueueList is virtualized with @tanstack/react-virtual
- Scrolling 100+ items is smooth (only ~15 DOM nodes at a time)
- "Retry All Failed" button works for bulk failure recovery
- Batch summary notification shows after large batch completes
- No memory growth or crashes during bulk processing
  </success_criteria>

<output>
After completion, create `.planning/phases/06-bulk-processing/06-02-SUMMARY.md`
</output>
