---
phase: 04.7-dashboard-enhancements
plan: 03
type: execute
wave: 2
depends_on: ["04.7-01", "04.7-02"]
files_modified:
  - src/main/index.ts
  - src/main/preload.ts
  - src/main/settings.ts
autonomous: true

must_haves:
  truths:
    - "IPC handler records usage event when extraction succeeds"
    - "Settings include globalTokenLimit and warningThreshold fields"
    - "Preload API exposes getUsageStats, getSettings, updateSettings"
    - "Usage is recorded after successful CV/JD extraction"
  artifacts:
    - path: "src/main/preload.ts"
      provides: "Usage and settings IPC API"
      exports: ["getUsageStats", "getSettings", "updateSettings", "setPinnedProject"]
    - path: "src/main/settings.ts"
      provides: "Extended settings interface with usage limits"
      contains: "globalTokenLimit"
  key_links:
    - from: "src/main/index.ts"
      to: "src/main/database.ts"
      via: "recordUsageEvent call"
      pattern: "recordUsageEvent"
---

<objective>
Add IPC handlers for usage tracking, pinned projects, and extend settings with usage limits.

Purpose: Bridges Python token counts to SQLite storage and exposes usage data to renderer.
Output: Complete IPC layer for usage tracking and settings management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.7-dashboard-enhancements/04.7-RESEARCH.md
@.planning/phases/04.7-dashboard-enhancements/04.7-01-SUMMARY.md
@src/main/index.ts
@src/main/preload.ts
@src/main/settings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend settings interface with usage limits</name>
  <files>src/main/settings.ts</files>
  <action>
    Extend the AppSettings interface:
    ```typescript
    export interface AppSettings {
      llmMode: 'local' | 'cloud';
      openaiApiKey?: string;
      // New usage limit fields
      globalTokenLimit?: number;        // Monthly token limit (null/undefined = unlimited)
      warningThreshold?: number;        // Percent (e.g., 80 means warn at 80%), default 80
    }
    ```

    Update DEFAULT_SETTINGS:
    ```typescript
    const DEFAULT_SETTINGS: AppSettings = {
      llmMode: 'local',
      warningThreshold: 80,  // Default to 80% warning threshold
    };
    ```

    No other changes needed - existing loadSettings/saveSettings already handle partial updates.
  </action>
  <verify>npm run lint --quiet shows no TypeScript errors in settings.ts</verify>
  <done>AppSettings includes globalTokenLimit and warningThreshold</done>
</task>

<task type="auto">
  <name>Task 2: Add IPC handlers for usage tracking and settings</name>
  <files>src/main/index.ts</files>
  <action>
    Import the new database functions at top of file:
    ```typescript
    import {
      // ... existing imports ...
      recordUsageEvent,
      getAllUsageStats,
      updateProjectPinned,
      getPinnedProjects,
      type UsageEventInput,
    } from './database';
    ```

    Import settings functions:
    ```typescript
    import { loadSettings, saveSettings, type AppSettings } from './settings';
    ```

    Modify existing extract-cv handler to record usage after successful extraction:
    Find the ipcMain.handle('extract-cv', ...) handler.
    After successful extraction and database insert, add:
    ```typescript
    // Record usage if token_usage present in response
    if (result.data?.token_usage && projectId) {
      recordUsageEvent({
        projectId,
        eventType: 'cv_extraction',
        promptTokens: result.data.token_usage.prompt_tokens || 0,
        completionTokens: result.data.token_usage.completion_tokens || 0,
        totalTokens: result.data.token_usage.total_tokens || 0,
        llmMode: loadSettings().llmMode,
      });
    }
    ```

    Similarly for extract-jd handler if it exists.

    Add new IPC handlers:

    1. get-usage-stats:
    ```typescript
    ipcMain.handle('get-usage-stats', async () => {
      try {
        const stats = getAllUsageStats();
        return { success: true, data: stats };
      } catch (error) {
        console.error('get-usage-stats error:', error);
        return { success: false, error: String(error) };
      }
    });
    ```

    2. set-pinned-project:
    ```typescript
    ipcMain.handle('set-pinned-project', async (_event, projectId: string, isPinned: boolean) => {
      try {
        const success = updateProjectPinned(projectId, isPinned);
        return { success };
      } catch (error) {
        console.error('set-pinned-project error:', error);
        return { success: false, error: String(error) };
      }
    });
    ```

    3. get-pinned-projects:
    ```typescript
    ipcMain.handle('get-pinned-projects', async () => {
      try {
        const projects = getPinnedProjects();
        return { success: true, data: projects };
      } catch (error) {
        console.error('get-pinned-projects error:', error);
        return { success: false, error: String(error) };
      }
    });
    ```

    4. get-app-settings:
    ```typescript
    ipcMain.handle('get-app-settings', async () => {
      try {
        const settings = loadSettings();
        // Don't expose API key directly, just whether it exists
        return {
          success: true,
          data: {
            llmMode: settings.llmMode,
            hasApiKey: Boolean(settings.openaiApiKey),
            globalTokenLimit: settings.globalTokenLimit,
            warningThreshold: settings.warningThreshold ?? 80,
          },
        };
      } catch (error) {
        console.error('get-app-settings error:', error);
        return { success: false, error: String(error) };
      }
    });
    ```

    5. update-app-settings:
    ```typescript
    ipcMain.handle('update-app-settings', async (_event, updates: Partial<Omit<AppSettings, 'openaiApiKey'>>) => {
      try {
        const updated = saveSettings(updates);
        return {
          success: true,
          data: {
            llmMode: updated.llmMode,
            hasApiKey: Boolean(updated.openaiApiKey),
            globalTokenLimit: updated.globalTokenLimit,
            warningThreshold: updated.warningThreshold ?? 80,
          },
        };
      } catch (error) {
        console.error('update-app-settings error:', error);
        return { success: false, error: String(error) };
      }
    });
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>IPC handlers for usage, pinning, and settings registered</done>
</task>

<task type="auto">
  <name>Task 3: Expose new APIs in preload</name>
  <files>src/main/preload.ts</files>
  <action>
    Add type definitions near top of file:
    ```typescript
    interface UsageStats {
      totalTokens: number;
      requestCount: number;
    }

    interface ProjectUsageStats {
      global: UsageStats;
      byProject: Record<string, UsageStats>;
    }

    interface UsageStatsResult {
      success: boolean;
      data?: ProjectUsageStats;
      error?: string;
    }

    interface AppSettingsData {
      llmMode: 'local' | 'cloud';
      hasApiKey: boolean;
      globalTokenLimit?: number;
      warningThreshold: number;
    }

    interface AppSettingsResult {
      success: boolean;
      data?: AppSettingsData;
      error?: string;
    }

    interface PinnedProjectsResult {
      success: boolean;
      data?: ProjectSummary[];
      error?: string;
    }
    ```

    Add to the contextBridge.exposeInMainWorld('api', { ... }) object:

    ```typescript
    // Usage tracking

    /**
     * Get usage statistics for current month.
     * Returns global and per-project token counts.
     */
    getUsageStats: (): Promise<UsageStatsResult> =>
      ipcRenderer.invoke('get-usage-stats'),

    /**
     * Pin or unpin a project for quick sidebar access.
     */
    setPinnedProject: (projectId: string, isPinned: boolean): Promise<{ success: boolean; error?: string }> =>
      ipcRenderer.invoke('set-pinned-project', projectId, isPinned),

    /**
     * Get all pinned projects.
     */
    getPinnedProjects: (): Promise<PinnedProjectsResult> =>
      ipcRenderer.invoke('get-pinned-projects'),

    // Settings API (extended)

    /**
     * Get all app settings including usage limits.
     */
    getAppSettings: (): Promise<AppSettingsResult> =>
      ipcRenderer.invoke('get-app-settings'),

    /**
     * Update app settings (excluding API key - use setLLMSettings for that).
     */
    updateAppSettings: (updates: { globalTokenLimit?: number; warningThreshold?: number }): Promise<AppSettingsResult> =>
      ipcRenderer.invoke('update-app-settings', updates),
    ```
  </action>
  <verify>npm run lint --quiet shows no errors</verify>
  <done>Preload exposes usage stats, pinned projects, and settings APIs</done>
</task>

</tasks>

<verification>
After all tasks:
1. Run `npm run lint --quiet` - no errors
2. Run `npm run typecheck` if available - no errors
3. Build succeeds: `npm run build` or `npm run package`
</verification>

<success_criteria>
- Settings interface extended with usage limit fields
- IPC handlers record usage on successful extraction
- Preload exposes 5 new API methods (getUsageStats, setPinnedProject, getPinnedProjects, getAppSettings, updateAppSettings)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04.7-dashboard-enhancements/04.7-03-SUMMARY.md`
</output>
