---
phase: 07-testing-and-bug-fixing-protocol
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/main/__tests__/database.test.ts
  - src/main/__tests__/queueManager.test.ts
  - src/main/__tests__/pythonManager.test.ts
  - src/main/__tests__/ipcHandlers.test.ts
autonomous: true

must_haves:
  truths:
    - "20+ vitest unit tests exist for critical main-process modules"
    - "Database functions tested with in-memory SQLite"
    - "IPC handlers tested for input validation and error handling"
    - "All vitest tests pass"
  artifacts:
    - path: "src/main/__tests__/database.test.ts"
      provides: "Database function unit tests"
      min_lines: 100
    - path: "src/main/__tests__/queueManager.test.ts"
      provides: "Queue manager unit tests"
      min_lines: 60
    - path: "src/main/__tests__/ipcHandlers.test.ts"
      provides: "IPC handler input validation tests"
      min_lines: 80
  key_links:
    - from: "src/main/__tests__/database.test.ts"
      to: "src/main/database.ts"
      via: "import database functions"
      pattern: "from.*database"
---

<objective>
Generate vitest unit tests for critical Electron main-process modules: database operations, queue manager, Python manager IPC, and IPC handler input validation. Focus on testing defensive code paths, error handling, and input validation.

Purpose: Ensure the main process - which handles all data, IPC, and Python sidecar communication - is robust against malformed inputs and error conditions.
Output: 4 test files with 60+ tests, all passing with vitest.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@vitest.config.ts
@src/main/database.ts
@src/main/queueManager.ts
@src/main/pythonManager.ts
@src/main/index.ts
@src/main/settings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database and queue manager unit tests</name>
  <files>
    src/main/__tests__/database.test.ts
    src/main/__tests__/queueManager.test.ts
  </files>
  <action>
1. Read `src/main/database.ts` to understand exported functions and their signatures.

2. Create `src/main/__tests__/database.test.ts`:
   - Mock `better-sqlite3` to use in-memory database OR test pure functions that don't require DB
   - Test all CRUD operations: create, read, update, delete for CVs, JDs, projects
   - Test with missing/null IDs
   - Test with empty strings for required fields
   - Test SQL injection attempts in string fields (verify parameterized queries)
   - Test concurrent operations (if applicable)
   - Test migration functions (schema version checks)
   - Test edge cases: very long strings, unicode in names, special chars in paths
   - 25+ tests

3. Read `src/main/queueManager.ts` to understand the queue logic.

4. Create `src/main/__tests__/queueManager.test.ts`:
   - Mock the Python manager and database dependencies
   - Test queue enqueue with valid/invalid items
   - Test queue processing order (FIFO)
   - Test timeout handling (simulated)
   - Test status transitions: queued -> processing -> completed/failed
   - Test crash recovery (stuck 'processing' items)
   - Test concurrent enqueue calls
   - 15+ tests

NOTE: For Electron-specific modules, mock `electron` imports using vitest.mock(). If modules import from 'electron' at top level, create a `__mocks__/electron.ts` or use vi.mock('electron', ...).

Run: `npx vitest run src/main/__tests__/ --reporter=verbose`
  </action>
  <verify>
    - `npx vitest run src/main/__tests__/database.test.ts` passes
    - `npx vitest run src/main/__tests__/queueManager.test.ts` passes
    - Combined 40+ test cases
  </verify>
  <done>Database tests cover all CRUD operations, SQL injection defense, edge cases. Queue manager tests cover lifecycle, timeout, crash recovery. All pass with vitest.</done>
</task>

<task type="auto">
  <name>Task 2: Create IPC handler validation and Python manager tests</name>
  <files>
    src/main/__tests__/pythonManager.test.ts
    src/main/__tests__/ipcHandlers.test.ts
  </files>
  <action>
1. Read `src/main/pythonManager.ts` to understand the sidecar communication.

2. Create `src/main/__tests__/pythonManager.test.ts`:
   - Mock child_process.spawn
   - Test sidecar spawn with valid/invalid paths
   - Test JSON-lines IPC protocol (valid JSON, malformed JSON, partial lines)
   - Test timeout behavior
   - Test sidecar crash handling (exit codes)
   - Test ACK pattern for processing coordination
   - 15+ tests

3. Read `src/main/index.ts` to find IPC handler registrations (ipcMain.handle calls).

4. Create `src/main/__tests__/ipcHandlers.test.ts`:
   - Mock ipcMain and event objects
   - Test each IPC handler with valid inputs
   - Test each IPC handler with missing required fields
   - Test each IPC handler with wrong types (string where number expected, etc.)
   - Test each IPC handler with injection payloads in string fields
   - Test each IPC handler with path traversal attempts in file paths
   - Test error response format consistency ({success: false, error: string})
   - 20+ tests

Fix any bugs discovered (e.g., missing input validation on IPC handlers - add validation if missing).

Run: `npx vitest run src/main/__tests__/ --reporter=verbose`
  </action>
  <verify>
    - `npx vitest run src/main/__tests__/ --reporter=verbose` all pass
    - `npx vitest run --reporter=verbose 2>&1 | grep "Tests"` shows 60+ tests
  </verify>
  <done>Python manager tests cover spawn, IPC protocol, timeout, crash recovery. IPC handler tests validate all inputs, reject malformed data, and verify consistent error responses. All pass.</done>
</task>

</tasks>

<verification>
1. `npx vitest run` passes all tests
2. `npx vitest run --reporter=verbose` shows 60+ individual test cases
3. No skipped or pending tests
</verification>

<success_criteria>
- 60+ TypeScript unit tests across 4 files, all passing
- Database functions tested with SQL injection defense
- IPC handlers tested for input validation
- Python manager tested for protocol correctness and crash recovery
- Bugs found during testing are FIXED
</success_criteria>

<output>
After completion, create `.planning/phases/07-testing-and-bug-fixing-protocol/07-03-SUMMARY.md`
</output>
