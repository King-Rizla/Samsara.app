---
phase: 01-foundation-distribution
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - python-src/main.py
  - python-src/requirements.txt
  - python-src/samsara.spec
autonomous: true

must_haves:
  truths:
    - "PyInstaller builds Python sidecar with spaCy into onedir bundle"
    - "Bundled sidecar loads spaCy en_core_web_sm model without import errors"
    - "Sidecar responds to health_check request via stdin/stdout JSON"
    - "Model is preloaded at startup, not per-request"
  artifacts:
    - path: "python-src/main.py"
      provides: "Python entry point with JSON-over-stdio IPC"
      contains: "spacy.load"
    - path: "python-src/requirements.txt"
      provides: "Python dependencies"
      contains: "spacy==3.8"
    - path: "python-src/samsara.spec"
      provides: "PyInstaller spec with spaCy hidden imports"
      contains: "srsly.msgpack.util"
    - path: "python-dist/samsara-backend/"
      provides: "PyInstaller onedir output"
  key_links:
    - from: "python-src/main.py"
      to: "en_core_web_sm"
      via: "spacy.load at startup"
      pattern: 'spacy\\.load.*en_core_web_sm'
    - from: "python-src/samsara.spec"
      to: "python-src/main.py"
      via: "PyInstaller entry point"
      pattern: "main\\.py"
---

<objective>
Create the Python sidecar with PyInstaller bundling and spaCy model.

Purpose: Builds the standalone Python backend that will handle NLP processing. This runs in parallel with Plan 01 (Electron shell) and provides the Python side for Plan 03 to integrate.

Output: A PyInstaller `--onedir` bundle that loads spaCy and responds to JSON commands on stdin/stdout.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-distribution/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Python project structure with spaCy</name>
  <files>
    python-src/main.py
    python-src/requirements.txt
  </files>
  <action>
    1. Create `python-src/` directory in project root.

    2. Create `python-src/requirements.txt`:
       ```
       spacy==3.8.11
       pyinstaller==6.18.0
       ```

    3. Create `python-src/main.py` with JSON-over-stdio IPC pattern:
       ```python
       """
       Samsara Python Sidecar
       Communicates via JSON lines on stdin/stdout.
       spaCy model is preloaded at startup for fast inference.
       """
       import sys
       import json
       import spacy

       # Preload model at startup (before accepting requests)
       # This avoids 2-5 second load time per request
       print(json.dumps({"status": "loading_model"}), flush=True)
       nlp = spacy.load("en_core_web_sm", disable=["parser", "lemmatizer"])
       print(json.dumps({"status": "model_loaded", "model": "en_core_web_sm"}), flush=True)


       def handle_request(request: dict) -> dict:
           """Handle a single JSON request and return response."""
           action = request.get('action')
           request_id = request.get('id', 'unknown')

           if action == 'health_check':
               return {
                   'id': request_id,
                   'success': True,
                   'data': {
                       'status': 'healthy',
                       'model': 'en_core_web_sm',
                       'model_loaded': nlp is not None
                   }
               }

           if action == 'shutdown':
               sys.exit(0)

           return {
               'id': request_id,
               'success': False,
               'error': f'Unknown action: {action}'
           }


       def main():
           """Main loop: read JSON lines from stdin, write responses to stdout."""
           for line in sys.stdin:
               line = line.strip()
               if not line:
                   continue

               try:
                   request = json.loads(line)
                   response = handle_request(request)
                   print(json.dumps(response), flush=True)
               except json.JSONDecodeError as e:
                   error_response = {
                       'success': False,
                       'error': f'Invalid JSON: {str(e)}'
                   }
                   print(json.dumps(error_response), flush=True)
               except Exception as e:
                   error_response = {
                       'success': False,
                       'error': str(e)
                   }
                   print(json.dumps(error_response), flush=True)


       if __name__ == '__main__':
           main()
       ```

    4. Set up Python virtual environment and install dependencies:
       ```bash
       cd python-src
       python -m venv .venv
       # Windows: .venv\Scripts\activate
       # macOS/Linux: source .venv/bin/activate
       pip install -r requirements.txt
       python -m spacy download en_core_web_sm
       ```

    5. Test the sidecar manually:
       ```bash
       echo '{"action": "health_check", "id": "test-1"}' | python main.py
       ```
       Should output JSON with `"success": true` and model info.
  </action>
  <verify>
    Run the manual test command. Output should include:
    - `{"status": "loading_model"}`
    - `{"status": "model_loaded", "model": "en_core_web_sm"}`
    - `{"id": "test-1", "success": true, "data": {"status": "healthy", "model": "en_core_web_sm", "model_loaded": true}}`
  </verify>
  <done>
    Python sidecar loads spaCy model at startup and responds to health_check via stdin/stdout JSON protocol.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PyInstaller spec and build onedir bundle</name>
  <files>
    python-src/samsara.spec
    python-dist/samsara-backend/
  </files>
  <action>
    1. Create `python-src/samsara.spec` with all required spaCy hidden imports:
       ```python
       # -*- mode: python ; coding: utf-8 -*-
       """
       PyInstaller spec for Samsara Python sidecar.

       CRITICAL: spaCy requires explicit hidden imports that PyInstaller
       cannot detect via static analysis. Missing any of these causes
       runtime import errors in the bundled application.
       """
       import spacy
       import en_core_web_sm
       from PyInstaller.utils.hooks import collect_data_files, collect_submodules

       block_cipher = None

       # Collect all spaCy data and submodules
       spacy_datas = collect_data_files('spacy')
       thinc_datas = collect_data_files('thinc')

       # Collect model data
       model_path = en_core_web_sm.__path__[0]

       a = Analysis(
           ['main.py'],
           pathex=[],
           binaries=[],
           datas=[
               *spacy_datas,
               *thinc_datas,
               (model_path, 'en_core_web_sm'),
           ],
           hiddenimports=[
               # spaCy core hidden imports
               'srsly.msgpack.util',
               'cymem',
               'cymem.cymem',
               'preshed.maps',
               'thinc.backends.linalg',
               'blis',
               'spacy.lang.en',
               'spacy_legacy',
               # Additional thinc imports
               'thinc.api',
               'thinc.config',
               'thinc.layers',
               'thinc.model',
               'thinc.shims',
               'thinc.types',
               'thinc.util',
               # Catalogue for spaCy registry
               'catalogue',
               # Confection for config
               'confection',
               # Wasabi for logging
               'wasabi',
           ] + collect_submodules('spacy') + collect_submodules('thinc') + collect_submodules('blis'),
           hookspath=[],
           hooksconfig={},
           runtime_hooks=[],
           excludes=[],
           win_no_prefer_redirects=False,
           win_private_assemblies=False,
           cipher=block_cipher,
           noarchive=False,
       )

       pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

       exe = EXE(
           pyz,
           a.scripts,
           [],
           exclude_binaries=True,
           name='samsara-backend',
           debug=False,
           bootloader_ignore_signals=False,
           strip=False,
           upx=False,  # UPX often causes issues with spaCy
           console=True,  # Keep console for stdio IPC
           disable_windowed_traceback=False,
           argv_emulation=False,
           target_arch=None,
           codesign_identity=None,
           entitlements_file=None,
       )

       coll = COLLECT(
           exe,
           a.binaries,
           a.zipfiles,
           a.datas,
           strip=False,
           upx=False,
           upx_exclude=[],
           name='samsara-backend',
       )
       ```

    2. Build the PyInstaller bundle:
       ```bash
       cd python-src
       # Activate venv first
       pyinstaller samsara.spec --distpath ../python-dist --workpath ../python-build --clean
       ```

       This creates `python-dist/samsara-backend/` directory (onedir mode, NOT onefile).

    3. Test the bundled executable:
       ```bash
       # Windows
       echo '{"action": "health_check", "id": "bundle-test"}' | ../python-dist/samsara-backend/samsara-backend.exe

       # macOS/Linux
       echo '{"action": "health_check", "id": "bundle-test"}' | ../python-dist/samsara-backend/samsara-backend
       ```

    4. Add build artifacts to .gitignore (in project root):
       ```
       python-dist/
       python-build/
       python-src/.venv/
       python-src/__pycache__/
       *.pyc
       ```
  </action>
  <verify>
    1. `python-dist/samsara-backend/` directory exists with executable
    2. Running the bundled executable with health_check JSON produces valid response
    3. No "ModuleNotFoundError" or "No module named 'srsly.msgpack.util'" errors
    4. Model loading message appears: `{"status": "model_loaded", "model": "en_core_web_sm"}`
  </verify>
  <done>
    PyInstaller creates onedir bundle that successfully loads spaCy model and responds to health_check requests.
  </done>
</task>

</tasks>

<verification>
1. `python-src/main.py` exists with stdin/stdout JSON protocol
2. `python-src/samsara.spec` exists with all spaCy hidden imports
3. `python-dist/samsara-backend/` directory exists after build
4. Bundled executable responds to `{"action": "health_check"}` with `{"success": true}`
5. No spaCy import errors when running bundled executable
6. Model preloads at startup (status messages visible)
</verification>

<success_criteria>
- PyInstaller `--onedir` build completes without errors
- Bundled sidecar loads spaCy en_core_web_sm model
- Health check request/response works via stdin/stdout JSON
- Ready for Plan 03 integration with Electron shell
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-distribution/01-02-SUMMARY.md`
</output>
