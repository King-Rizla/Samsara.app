---
phase: 09-communication-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/credentialManager.ts
  - src/main/database.ts
  - src/main/index.ts
  - src/main/preload.ts
  - src/renderer/components/settings/CommunicationSettings.tsx
  - src/renderer/stores/communicationStore.ts
  - src/renderer/types/communication.ts
  - src/renderer/routes/ProjectLayout.tsx
autonomous: true
user_setup:
  - service: twilio
    why: "SMS messaging for candidate outreach"
    env_vars:
      - name: TWILIO_ACCOUNT_SID
        source: "Twilio Console -> Account Info -> Account SID"
      - name: TWILIO_AUTH_TOKEN
        source: "Twilio Console -> Account Info -> Auth Token"
      - name: TWILIO_PHONE_NUMBER
        source: "Twilio Console -> Phone Numbers -> Active Numbers"
    dashboard_config:
      - task: "Create Twilio account and get phone number"
        location: "https://www.twilio.com/console"
  - service: smtp
    why: "Email messaging for candidate outreach"
    env_vars:
      - name: SMTP_HOST
        source: "Your email provider (e.g., smtp.gmail.com)"
      - name: SMTP_USER
        source: "Your email address"
      - name: SMTP_PASSWORD
        source: "App password (not regular password for Gmail)"
    dashboard_config:
      - task: "Generate app password if using Gmail"
        location: "Google Account -> Security -> App passwords"

must_haves:
  truths:
    - "User can enter Twilio credentials (account SID, auth token, phone number) in Communication Settings"
    - "User can enter SMTP credentials (host, port, user, password, from email) in Communication Settings"
    - "User can test Twilio credentials and see success/failure status"
    - "User can test SMTP credentials and see success/failure status"
    - "Credentials are encrypted using OS keychain via safeStorage"
  artifacts:
    - path: "src/main/credentialManager.ts"
      provides: "Credential storage with safeStorage encryption"
      exports:
        [
          "storeCredential",
          "getCredential",
          "deleteCredential",
          "testTwilioCredentials",
          "testSmtpCredentials",
        ]
    - path: "src/renderer/components/settings/CommunicationSettings.tsx"
      provides: "UI for entering and testing provider credentials"
      min_lines: 150
    - path: "src/renderer/stores/communicationStore.ts"
      provides: "Zustand store for communication state"
      exports: ["useCommunicationStore"]
  key_links:
    - from: "src/renderer/components/settings/CommunicationSettings.tsx"
      to: "window.api.testTwilioCredentials"
      via: "IPC invoke"
      pattern: "api\\.testTwilioCredentials"
    - from: "src/main/credentialManager.ts"
      to: "safeStorage"
      via: "Electron API"
      pattern: "safeStorage\\.encryptString"
---

<objective>
Build secure credential storage and provider configuration UI for SMS (Twilio) and email (SMTP) providers.

Purpose: Users need to securely store their API credentials before sending any messages. This is the foundation for all communication features in Phase 9.

Output: CredentialManager module with safeStorage encryption, CommunicationSettings UI with provider tabs, IPC handlers for credential operations, test-send verification for both providers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-communication-infrastructure/09-RESEARCH.md
@.planning/phases/09-communication-infrastructure/09-CONTEXT.md
@src/main/index.ts
@src/main/preload.ts
@src/main/database.ts
@src/renderer/routes/ProjectLayout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credential manager and communication types</name>
  <files>
    src/main/credentialManager.ts
    src/renderer/types/communication.ts
    src/main/database.ts
  </files>
  <action>
Create `src/main/credentialManager.ts` with safeStorage-based credential encryption:

```typescript
import { safeStorage } from "electron";
import { getDatabase } from "./database";
import * as crypto from "crypto";

export type ProviderType = "twilio" | "smtp";
export type TwilioCredentialType =
  | "account_sid"
  | "auth_token"
  | "phone_number";
export type SmtpCredentialType =
  | "host"
  | "port"
  | "user"
  | "password"
  | "from_email";
export type CredentialType = TwilioCredentialType | SmtpCredentialType;

export interface StoredCredential {
  id: string;
  projectId: string | null;
  provider: ProviderType;
  credentialType: CredentialType;
  label?: string;
  createdAt: string;
  updatedAt: string;
}
```

Implement functions:

- `storeCredential(projectId: string | null, provider: ProviderType, credentialType: CredentialType, plainValue: string, label?: string): string` - Encrypt with safeStorage, store in DB, return ID
- `getCredential(projectId: string | null, provider: ProviderType, credentialType: CredentialType): string | null` - Try project-specific first, fallback to global (null projectId)
- `deleteCredential(projectId: string | null, provider: ProviderType, credentialType: CredentialType): boolean`
- `hasCredential(projectId: string | null, provider: ProviderType, credentialType: CredentialType): boolean` - Check without decrypting
- `listCredentials(projectId: string | null): StoredCredential[]` - List without values

Add encryption availability check:

- `isEncryptionAvailable(): boolean` - Check `safeStorage.isEncryptionAvailable()`

Create `src/renderer/types/communication.ts` with types:

- `CommunicationProvider` type ('twilio' | 'smtp')
- `CredentialStatus` type ('unconfigured' | 'configured' | 'verified' | 'failed')
- `TwilioCredentials` interface (accountSid, authToken, phoneNumber - for UI form state)
- `SmtpCredentials` interface (host, port, user, password, fromEmail - for UI form state)
- `TestResult` interface (success: boolean, error?: string, data?: Record<string, string>)

Add migration v6 to `database.ts` for dnc_registry table:

```sql
CREATE TABLE IF NOT EXISTS dnc_registry (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,           -- 'phone' | 'email'
  value TEXT NOT NULL,          -- Normalized phone/email
  reason TEXT NOT NULL,         -- 'opt_out' | 'bounce' | 'manual'
  source_message_id TEXT,
  created_at TEXT NOT NULL,
  UNIQUE(type, value)
);

CREATE INDEX IF NOT EXISTS idx_dnc_type_value ON dnc_registry(type, value);
```

Also add columns to outreach_templates for global templates:

```sql
ALTER TABLE outreach_templates ADD COLUMN is_global INTEGER DEFAULT 0;
```

And cost tracking columns to messages:

```sql
ALTER TABLE messages ADD COLUMN cost_cents INTEGER;
ALTER TABLE messages ADD COLUMN currency TEXT DEFAULT 'USD';
```

  </action>
  <verify>
- `npx tsc --noEmit` shows no new errors in credentialManager.ts or communication.ts
- Database migration v6 runs without error (check console on app start)
  </verify>
  <done>
- credentialManager.ts exports all 6 functions (store, get, delete, has, list, isEncryptionAvailable)
- communication.ts exports all type definitions
- Migration v6 creates dnc_registry table and adds columns
  </done>
</task>

<task type="auto">
  <name>Task 2: Add IPC handlers and preload API for credentials</name>
  <files>
    src/main/index.ts
    src/main/preload.ts
    src/main/credentialManager.ts
  </files>
  <action>
Add test functions to `credentialManager.ts`:

```typescript
import Twilio from "twilio";
import nodemailer from "nodemailer";

export async function testTwilioCredentials(projectId: string | null): Promise<{
  success: boolean;
  error?: string;
  data?: { friendlyName: string; status: string };
}> {
  const accountSid = getCredential(projectId, "twilio", "account_sid");
  const authToken = getCredential(projectId, "twilio", "auth_token");

  if (!accountSid || !authToken) {
    return { success: false, error: "Twilio credentials not configured" };
  }

  try {
    const client = new Twilio(accountSid, authToken);
    const account = await client.api.accounts(accountSid).fetch();
    return {
      success: true,
      data: { friendlyName: account.friendlyName, status: account.status },
    };
  } catch (error) {
    return {
      success: false,
      error:
        error instanceof Error ? error.message : "Twilio verification failed",
    };
  }
}

export async function testSmtpCredentials(projectId: string | null): Promise<{
  success: boolean;
  error?: string;
}> {
  const host = getCredential(projectId, "smtp", "host");
  const port = getCredential(projectId, "smtp", "port");
  const user = getCredential(projectId, "smtp", "user");
  const password = getCredential(projectId, "smtp", "password");

  if (!host || !user || !password) {
    return { success: false, error: "SMTP credentials not configured" };
  }

  const transporter = nodemailer.createTransport({
    host,
    port: parseInt(port || "587", 10),
    secure: port === "465",
    auth: { user, pass: password },
  });

  try {
    await transporter.verify();
    return { success: true };
  } catch (error) {
    return {
      success: false,
      error:
        error instanceof Error ? error.message : "SMTP verification failed",
    };
  }
}
```

Add IPC handlers to `index.ts`:

```typescript
// Credential IPC handlers
ipcMain.handle(
  "store-credential",
  async (
    _event,
    projectId: string | null,
    provider: string,
    credentialType: string,
    value: string,
  ) => {
    try {
      const id = storeCredential(
        projectId,
        provider as ProviderType,
        credentialType as CredentialType,
        value,
      );
      return { success: true, id };
    } catch (error) {
      return {
        success: false,
        error:
          error instanceof Error ? error.message : "Failed to store credential",
      };
    }
  },
);

ipcMain.handle(
  "get-credential-status",
  async (
    _event,
    projectId: string | null,
    provider: string,
    credentialType: string,
  ) => {
    try {
      const exists = hasCredential(
        projectId,
        provider as ProviderType,
        credentialType as CredentialType,
      );
      return { success: true, configured: exists };
    } catch (error) {
      return { success: false, error: String(error) };
    }
  },
);

ipcMain.handle(
  "delete-credential",
  async (
    _event,
    projectId: string | null,
    provider: string,
    credentialType: string,
  ) => {
    try {
      const deleted = deleteCredential(
        projectId,
        provider as ProviderType,
        credentialType as CredentialType,
      );
      return { success: true, deleted };
    } catch (error) {
      return { success: false, error: String(error) };
    }
  },
);

ipcMain.handle(
  "test-twilio-credentials",
  async (_event, projectId: string | null) => {
    return testTwilioCredentials(projectId);
  },
);

ipcMain.handle(
  "test-smtp-credentials",
  async (_event, projectId: string | null) => {
    return testSmtpCredentials(projectId);
  },
);

ipcMain.handle("is-encryption-available", async () => {
  return { available: isEncryptionAvailable() };
});
```

Add preload API to `preload.ts`:

```typescript
// Communication credential operations (Phase 9)

storeCredential: (
  projectId: string | null,
  provider: string,
  credentialType: string,
  value: string
): Promise<{ success: boolean; id?: string; error?: string }> =>
  ipcRenderer.invoke('store-credential', projectId, provider, credentialType, value),

getCredentialStatus: (
  projectId: string | null,
  provider: string,
  credentialType: string
): Promise<{ success: boolean; configured?: boolean; error?: string }> =>
  ipcRenderer.invoke('get-credential-status', projectId, provider, credentialType),

deleteCredential: (
  projectId: string | null,
  provider: string,
  credentialType: string
): Promise<{ success: boolean; deleted?: boolean; error?: string }> =>
  ipcRenderer.invoke('delete-credential', projectId, provider, credentialType),

testTwilioCredentials: (
  projectId: string | null
): Promise<{ success: boolean; error?: string; data?: { friendlyName: string; status: string } }> =>
  ipcRenderer.invoke('test-twilio-credentials', projectId),

testSmtpCredentials: (
  projectId: string | null
): Promise<{ success: boolean; error?: string }> =>
  ipcRenderer.invoke('test-smtp-credentials', projectId),

isEncryptionAvailable: (): Promise<{ available: boolean }> =>
  ipcRenderer.invoke('is-encryption-available'),
```

Install required packages:

```bash
npm install twilio nodemailer @types/nodemailer
```

  </action>
  <verify>
- `npm ls twilio nodemailer` shows both packages installed
- `npx tsc --noEmit` passes
- IPC handlers registered in index.ts (search for 'test-twilio-credentials')
  </verify>
  <done>
- 6 IPC handlers added for credential operations
- Preload exposes 6 new API methods
- twilio and nodemailer packages installed
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CommunicationSettings UI and store</name>
  <files>
    src/renderer/components/settings/CommunicationSettings.tsx
    src/renderer/stores/communicationStore.ts
    src/renderer/routes/ProjectLayout.tsx
  </files>
  <action>
Create `src/renderer/stores/communicationStore.ts`:

```typescript
import { create } from "zustand";
import type { CredentialStatus } from "../types/communication";

interface CommunicationState {
  twilioStatus: CredentialStatus;
  smtpStatus: CredentialStatus;
  twilioTestResult: {
    success: boolean;
    error?: string;
    friendlyName?: string;
  } | null;
  smtpTestResult: { success: boolean; error?: string } | null;
  isTestingTwilio: boolean;
  isTestingSmtp: boolean;
  isSaving: boolean;

  // Actions
  setTwilioStatus: (status: CredentialStatus) => void;
  setSmtpStatus: (status: CredentialStatus) => void;
  setTwilioTestResult: (
    result: { success: boolean; error?: string; friendlyName?: string } | null,
  ) => void;
  setSmtpTestResult: (
    result: { success: boolean; error?: string } | null,
  ) => void;
  setIsTestingTwilio: (testing: boolean) => void;
  setIsTestingSmtp: (testing: boolean) => void;
  setIsSaving: (saving: boolean) => void;

  // Async actions
  loadCredentialStatus: (projectId: string | null) => Promise<void>;
  saveTwilioCredentials: (
    projectId: string | null,
    accountSid: string,
    authToken: string,
    phoneNumber: string,
  ) => Promise<boolean>;
  saveSmtpCredentials: (
    projectId: string | null,
    host: string,
    port: string,
    user: string,
    password: string,
    fromEmail: string,
  ) => Promise<boolean>;
  testTwilio: (projectId: string | null) => Promise<void>;
  testSmtp: (projectId: string | null) => Promise<void>;
}

export const useCommunicationStore = create<CommunicationState>((set, get) => ({
  twilioStatus: "unconfigured",
  smtpStatus: "unconfigured",
  twilioTestResult: null,
  smtpTestResult: null,
  isTestingTwilio: false,
  isTestingSmtp: false,
  isSaving: false,

  // ... implement all actions
}));
```

Create `src/renderer/components/settings/CommunicationSettings.tsx`:

Build a tabbed interface with two provider tabs (Twilio SMS, Email SMTP):

**Twilio Tab:**

- Account SID input (password field, shows dots)
- Auth Token input (password field)
- Phone Number input (text field, E.164 format hint)
- Save button (calls saveTwilioCredentials)
- Test Connection button (calls testTwilio)
- Status indicator: unconfigured (gray), configured (blue), verified (green), failed (red)
- Inline error display if test fails

**SMTP Tab:**

- Host input (e.g., smtp.gmail.com)
- Port input (dropdown: 587, 465, 25)
- Username input
- Password input (password field)
- From Email input
- Save button
- Test Connection button
- Status indicator

**Shared UI patterns:**

- Use existing Card, Button, Input from ui/ components
- Use Tabs from ui/ components
- Show "Credentials encrypted with OS keychain" note
- Warning if isEncryptionAvailable() returns false

Update `ProjectLayout.tsx`:

- Add "Communication" link/button that opens CommunicationSettings
- Could be a button that opens a Sheet, or a route to /project/:id/settings/communication
- Preferred: Sheet (side panel) like LLMSettings pattern

Form validation:

- Twilio Account SID must start with "AC" and be 34 characters
- Phone number should be E.164 format (starts with +)
- SMTP host cannot be empty
- Port must be numeric
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npx vitest run` passes (no new test failures)
- CommunicationSettings.tsx exports default component
  </verify>
  <done>
- CommunicationSettings has two tabs for Twilio and SMTP
- Each tab has credential inputs, save, and test buttons
- Status indicators show unconfigured/configured/verified/failed
- Error messages display inline
- Store manages credential status and test results
  </done>
  </task>

</tasks>

<verification>
1. App starts without errors (`npm start`)
2. Navigate to a project, open Communication Settings
3. Enter Twilio test credentials (or invalid ones), click Save, then Test
4. Verify status shows verified (green) or failed (red) appropriately
5. Enter SMTP credentials, save, test
6. Credentials persist after app restart (safeStorage encryption)
7. `npx tsc --noEmit` passes
8. `npx vitest run` passes
</verification>

<success_criteria>

- User can configure Twilio credentials with validation feedback
- User can configure SMTP credentials with validation feedback
- Test Connection verifies credentials against real providers
- Credentials are encrypted via safeStorage (not stored in plain text)
- Status indicators update based on configuration and test results
  </success_criteria>

<output>
After completion, create `.planning/phases/09-communication-infrastructure/09-01-SUMMARY.md`
</output>
