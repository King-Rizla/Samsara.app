---
phase: 06-bulk-processing
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/components/queue/DropZone.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can drag a folder onto the drop zone and see a confirmation dialog with file count"
    - "Dragged folder files enqueue successfully and appear in the queue list"
    - "User can click drop zone, select a single folder, and see confirmation dialog"
  artifacts:
    - path: "src/renderer/components/queue/DropZone.tsx"
      provides: "Folder detection for both drag-drop and file picker flows"
      min_lines: 150
  key_links:
    - from: "DropZone.handleDrop"
      to: "window.api.batchEnqueue"
      via: "dataTransfer.items with webkitGetAsEntry()"
      pattern: "webkitGetAsEntry.*isDirectory"
    - from: "DropZone.handleClick"
      to: "window.api.batchEnqueue"
      via: "single folder selection detection"
      pattern: "filePaths.length === 1.*batchEnqueue"
---

<objective>
Fix folder drag-drop and single-folder selection bugs to properly route folders through batch enqueue.

Purpose: Close UAT gap where dragging/selecting folders fails instead of scanning contained files.
Output: Working folder drag-drop and folder selection flows that trigger batch enqueue with confirmation dialog.
</objective>

<execution_context>
@C:\Users\edwar\Documents\dev\Projects\Samsara\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\edwar\Documents\dev\Projects\Samsara\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\edwar\Documents\dev\Projects\Samsara\.planning\PROJECT.md
@C:\Users\edwar\Documents\dev\Projects\Samsara\.planning\ROADMAP.md
@C:\Users\edwar\Documents\dev\Projects\Samsara\.planning\STATE.md

## Prior Phase Work

@C:\Users\edwar\Documents\dev\Projects\Samsara\.planning\phases\06-bulk-processing\06-01-SUMMARY.md
@C:\Users\edwar\Documents\dev\Projects\Samsara\.planning\phases\06-bulk-processing\06-02-SUMMARY.md

## Gap Analysis

@C:\Users\edwar\Documents\dev\Projects\Samsara\.planning\phases\06-bulk-processing\06-UAT.md
@C:\Users\edwar\Documents\dev\Projects\Samsara\.planning\debug\folder-drag-drop.md

## Target File

@C:\Users\edwar\Documents\dev\Projects\Samsara\src\renderer\components\queue\DropZone.tsx
</context>

<tasks>

<task type="auto">
  <name>Fix folder detection in handleDrop using webkitGetAsEntry()</name>
  <files>src/renderer/components/queue/DropZone.tsx</files>
  <action>
Update `handleDrop` to use the File and Directory Entries API for proper folder detection:

1. **Replace the `files.some((f) => !f.name.includes("."))` heuristic** with proper directory detection:
   - Loop through `e.dataTransfer.items` (not `e.dataTransfer.files`)
   - For each item, call `item.webkitGetAsEntry()`
   - Check if entry is a directory using `entry.isDirectory`
   - Also collect all file paths (for files and folders)

2. **Route to batchEnqueue if any directory detected OR multiple files**:
   - If `hasDirectory || allPaths.length > 1`, call `window.api.batchEnqueue(allPaths)`
   - Otherwise, use existing single-file `processFile()` path

3. **Why this approach**:
   - `dataTransfer.files` excludes folders in Chromium
   - `webkitGetAsEntry()` is the standard Electron/Chrome way to detect directories in drag-drop
   - Keeps backward compatibility for single file drops

**Implementation notes**:

- DataTransferItemList requires iteration by index (not forEach/map)
- Check `entry.isDirectory` for directory detection
- Use `window.electronFile.getPath(file)` to get file paths (existing pattern)
- Preserve existing `validExtensions` check for single-file path
  </action>
  <verify>
  `npx tsc --noEmit` passes
  Code uses `dataTransfer.items` and `webkitGetAsEntry()`
  Pattern `entry.isDirectory` exists in handleDrop
  </verify>
  <done>
  handleDrop detects folders using webkitGetAsEntry() API
  Folders route to batchEnqueue
  Single files still use existing processFile path
  </done>
  </task>

<task type="auto">
  <name>Fix single-folder selection in handleClick</name>
  <files>src/renderer/components/queue/DropZone.tsx</files>
  <action>
Update `handleClick` to route single folder selections through batchEnqueue:

1. **Change the routing logic at line 124**:
   - Currently: `if (result.filePaths && result.filePaths.length > 1)`
   - Update to: `if (result.filePaths && result.filePaths.length >= 1)`
   - This ensures BOTH single folders AND multi-file selections go to batchEnqueue

2. **Simplify the conditional logic**:
   - Remove the `else if (result.filePath && result.fileName)` branch
   - The main process batch-enqueue handler already handles:
     - Single file with extension -> enqueues it
     - Single folder -> recursively scans and enqueues contents
     - Multiple files/folders -> processes each appropriately

3. **Why this approach**:
   - File picker has `openDirectory` property enabled (from 06-02)
   - Single folder selection returns `filePaths.length === 1`
   - Current `> 1` check causes single folders to fall through to `processFile()`
   - `processFile()` expects a file path, fails on folders (no extension)
   - Main process `batch-enqueue` handler is already designed to handle single items

**Result**: All file picker selections (single file, single folder, multiple files/folders) route through batchEnqueue, which handles validation and confirmation dialog uniformly.
</action>
<verify>
`npx tsc --noEmit` passes
handleClick condition changed to `>= 1` or routes all selections to batchEnqueue
No `processFile` call in handleClick conditional
</verify>
<done>
Single folder selection via click routes to batchEnqueue
Multi-file selection continues to work
Backward compatibility maintained (single file goes through batchEnqueue, which works for single items)
</done>
</task>

<task type="auto">
  <name>Run tests and verify fix</name>
  <files>src/renderer/components/queue/DropZone.tsx</files>
  <action>
Verify the fix works correctly:

1. **Type check**: `npx tsc --noEmit`
2. **Unit tests**: `npx vitest run`
3. **Manual test preparation**: Build app with `npm run build` (if needed for testing)

Expected outcomes:

- No TypeScript errors
- All existing tests pass (152/152)
- DropZone component properly detects folders in both drag-drop and click flows
  </action>
  <verify>
  `npx tsc --noEmit` exits with code 0
  `npx vitest run` shows all tests passing
  </verify>
  <done>
  TypeScript compilation clean
  All unit tests pass
  Code ready for user verification
  </done>
  </task>

</tasks>

<verification>
**Code checks:**
- DropZone.tsx uses `dataTransfer.items` and `webkitGetAsEntry()` in handleDrop
- handleDrop checks `entry.isDirectory` for folder detection
- handleClick routes all selections (including single folder) to batchEnqueue
- TypeScript types are correct
- All tests pass

**Functional verification** (user testing):

1. Drag a folder onto drop zone -> confirmation dialog appears -> files enqueue
2. Click drop zone -> select single folder -> confirmation dialog appears -> files enqueue
3. Drag single file -> processes normally (no dialog)
4. Drag multiple files -> confirmation dialog appears -> files enqueue
   </verification>

<success_criteria>

- [ ] DropZone.tsx modified to use webkitGetAsEntry() for folder detection
- [ ] handleDrop detects folders using File and Directory Entries API
- [ ] handleClick routes single-folder selection to batchEnqueue
- [ ] TypeScript compilation passes
- [ ] All unit tests pass (152/152)
- [ ] Gap from UAT Test #1 is closed
- [ ] User can drag folders and see confirmation dialog
- [ ] User can click and select a single folder successfully
      </success_criteria>

<output>
After completion, create `.planning/phases/06-bulk-processing/06-03-SUMMARY.md`
</output>
