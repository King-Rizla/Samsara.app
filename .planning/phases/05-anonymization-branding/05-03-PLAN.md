---
phase: 05-anonymization-branding
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/renderer/components/export/ExportModal.tsx
  - src/renderer/components/export/RecruiterSettings.tsx
  - src/renderer/components/settings/SettingsModal.tsx
  - src/renderer/stores/settingsStore.ts
  - src/renderer/App.tsx
  - src/renderer/types/api.d.ts
  - src/main/index.ts
  - src/main/preload.ts
  - src/renderer/components/queue/QueueItem.tsx
autonomous: false

must_haves:
  truths:
    - "User can click Export button on a CV and see mode selection dialog"
    - "User can select export mode (Full, Client, Punt) with Client as default"
    - "User can toggle blind profile inclusion on/off"
    - "User can configure recruiter details in Settings"
    - "User can bulk export multiple selected CVs to a chosen folder"
    - "Exported PDF appears in Downloads folder (or chosen folder)"
  artifacts:
    - path: "src/renderer/components/export/ExportModal.tsx"
      provides: "Export dialog with mode selection"
      exports: ["ExportModal"]
    - path: "src/renderer/components/export/RecruiterSettings.tsx"
      provides: "Recruiter configuration form"
      exports: ["RecruiterSettings"]
    - path: "src/renderer/stores/settingsStore.ts"
      provides: "Zustand store for app settings"
      exports: ["useSettingsStore"]
  key_links:
    - from: "src/renderer/components/export/ExportModal.tsx"
      to: "window.api.exportCV"
      via: "IPC invoke"
      pattern: "api\\.exportCV"
    - from: "src/renderer/stores/settingsStore.ts"
      to: "window.api.getRecruiterSettings"
      via: "IPC invoke"
      pattern: "api\\.getRecruiterSettings"
    - from: "src/renderer/components/export/ExportModal.tsx"
      to: "window.api.selectFolder"
      via: "IPC invoke for folder dialog"
      pattern: "api\\.selectFolder"
---

<objective>
Create export UI with mode selection, blind profile toggle, and recruiter settings configuration.

Purpose: Give recruiters a polished interface to export CVs with the right redaction level and their branded front sheet, including bulk export for efficiency.

Output: Export modal component, settings integration, bulk export support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-anonymization-branding/05-CONTEXT.md
@.planning/phases/05-anonymization-branding/05-02-SUMMARY.md
@src/renderer/App.tsx
@src/renderer/stores/queueStore.ts
@src/renderer/components/settings/SettingsModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings store and recruiter settings UI</name>
  <files>
    src/renderer/stores/settingsStore.ts
    src/renderer/components/export/RecruiterSettings.tsx
    src/renderer/components/settings/SettingsModal.tsx
    src/renderer/types/api.d.ts
  </files>
  <action>
1. Create `src/renderer/types/api.d.ts` if not exists (or update existing):
   Add types for export and settings APIs:
   ```typescript
   interface RecruiterSettings {
     name?: string;
     phone?: string;
     email?: string;
   }

   interface ExportResult {
     success: boolean;
     outputPath?: string;
     error?: string;
   }

   interface Api {
     // ... existing methods ...
     exportCV(cvId: string, mode: 'full' | 'client' | 'punt', outputDir?: string, includeBlindProfile?: boolean): Promise<ExportResult>;
     getRecruiterSettings(): Promise<{ success: boolean; data?: RecruiterSettings; error?: string }>;
     setRecruiterSettings(settings: RecruiterSettings): Promise<{ success: boolean; error?: string }>;
   }
   ```

2. Create `src/renderer/stores/settingsStore.ts`:
   ```typescript
   import { create } from 'zustand';

   interface RecruiterSettings {
     name?: string;
     phone?: string;
     email?: string;
   }

   interface SettingsState {
     recruiter: RecruiterSettings;
     isLoading: boolean;
     loadRecruiterSettings: () => Promise<void>;
     saveRecruiterSettings: (settings: RecruiterSettings) => Promise<boolean>;
   }

   export const useSettingsStore = create<SettingsState>((set) => ({
     recruiter: {},
     isLoading: false,

     loadRecruiterSettings: async () => {
       set({ isLoading: true });
       const result = await window.api.getRecruiterSettings();
       if (result.success && result.data) {
         set({ recruiter: result.data });
       }
       set({ isLoading: false });
     },

     saveRecruiterSettings: async (settings: RecruiterSettings) => {
       const result = await window.api.setRecruiterSettings(settings);
       if (result.success) {
         set({ recruiter: settings });
       }
       return result.success;
     },
   }));
   ```

3. Create `src/renderer/components/export/RecruiterSettings.tsx`:
   - Simple form with three inputs: Name, Phone, Email
   - Use terminal theme styling (dark background, purple accents)
   - Save button calls `saveRecruiterSettings`
   - Load settings on mount via `loadRecruiterSettings`
   - Show success/error toast on save

4. Update `src/renderer/components/settings/SettingsModal.tsx`:
   - Add "Recruiter" tab/section
   - Import and render `RecruiterSettings` component
   - If SettingsModal doesn't exist, create minimal modal that includes LLM settings (existing) + Recruiter settings (new)
  </action>
  <verify>
1. TypeScript compiles: `npm run type-check`
2. Open Settings in app, see Recruiter section
3. Enter recruiter details, save, reload app, verify details persist
  </verify>
  <done>
Settings store exists. Recruiter settings UI allows entering name/phone/email. Settings persist via IPC.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add selectFolder IPC handler and create Export modal</name>
  <files>
    src/main/index.ts
    src/main/preload.ts
    src/renderer/components/export/ExportModal.tsx
  </files>
  <action>
**Part A: Add selectFolder IPC handler (for bulk export folder selection)**

1. In `src/main/preload.ts`, add selectFolder to the api object:
   ```typescript
   selectFolder: (): Promise<{ canceled: boolean; path?: string }> =>
     ipcRenderer.invoke('select-folder'),
   ```

2. In `src/main/index.ts`, add IPC handler:
   ```typescript
   ipcMain.handle('select-folder', async () => {
     const result = await dialog.showOpenDialog({
       properties: ['openDirectory'],
       title: 'Select export folder'
     });
     return {
       canceled: result.canceled,
       path: result.filePaths[0]
     };
   });
   ```
   - Import `dialog` from electron if not already imported

**Part B: Create Export modal component**

Create `src/renderer/components/export/ExportModal.tsx`:

1. Props interface:
   ```typescript
   interface ExportModalProps {
     isOpen: boolean;
     onClose: () => void;
     cvId: string;           // Single CV export
     cvIds?: string[];       // Bulk export (optional)
     cvName?: string;        // Display name for single export
   }
   ```

2. State:
   - `mode: 'full' | 'client' | 'punt'` - default 'client' (as per CONTEXT.md)
   - `includeBlindProfile: boolean` - default true
   - `isExporting: boolean`
   - `error: string | null`
   - `outputDir: string | null` - for bulk, user selects folder

3. UI layout (terminal aesthetic):
   - Modal with dark background, purple border
   - Title: "Export CV" (or "Export X CVs" for bulk)
   - Mode selection as radio buttons or segmented control:
     - **Full** - "No redaction"
     - **Client** - "Remove phone & email" (DEFAULT, pre-selected)
     - **Punt** - "Remove phone, email & name"
   - Checkbox: "Include Blind Profile" (default checked)
   - Warning if recruiter not configured: "Set up recruiter details in Settings for blind profile"
   - For bulk: "Choose folder" button using `window.api.selectFolder()`
   - Export button (purple primary)
   - Cancel button

4. Export logic:
   ```typescript
   const handleExport = async () => {
     setIsExporting(true);
     try {
       if (cvIds && cvIds.length > 1) {
         // Bulk export
         for (const id of cvIds) {
           await window.api.exportCV(id, mode, outputDir, includeBlindProfile);
         }
       } else {
         // Single export
         const result = await window.api.exportCV(cvId, mode, undefined, includeBlindProfile);
         if (result.success) {
           // Show success toast with path
         } else {
           setError(result.error);
         }
       }
       onClose();
     } finally {
       setIsExporting(false);
     }
   };
   ```

5. Folder selection handler:
   ```typescript
   const handleSelectFolder = async () => {
     const result = await window.api.selectFolder();
     if (!result.canceled && result.path) {
       setOutputDir(result.path);
     }
   };
   ```
  </action>
  <verify>
1. TypeScript compiles: `npm run type-check`
2. IPC handler registered: Check index.ts has 'select-folder' handler
3. Modal opens when triggered
4. Mode selection works (radio buttons update state)
5. Blind profile toggle works
6. Export button is disabled while exporting (spinner shown)
7. Folder selection dialog opens when "Choose folder" clicked
  </verify>
  <done>
selectFolder IPC handler exists in index.ts/preload.ts. Export modal renders with mode selection, blind profile toggle, folder selection for bulk, and export button. UI matches terminal theme.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire export button into queue and App</name>
  <files>
    src/renderer/App.tsx
    src/renderer/stores/queueStore.ts
    src/renderer/components/queue/QueueItem.tsx
  </files>
  <action>
1. Add export modal state to App.tsx or relevant parent:
   ```typescript
   const [exportModalOpen, setExportModalOpen] = useState(false);
   const [exportCvId, setExportCvId] = useState<string | null>(null);
   const [exportCvIds, setExportCvIds] = useState<string[]>([]);

   const handleExport = (cvId: string) => {
     setExportCvId(cvId);
     setExportCvIds([]);
     setExportModalOpen(true);
   };

   const handleBulkExport = (cvIds: string[]) => {
     setExportCvId(cvIds[0]);
     setExportCvIds(cvIds);
     setExportModalOpen(true);
   };
   ```

2. Add Export button to QueueItem.tsx:
   - Small export icon button next to delete button
   - Only visible on completed items
   - onClick calls handleExport(item.id)

3. Add bulk export to queue toolbar (if exists) or create one:
   - "Export Selected" button when multiple items selected
   - Disabled if no items selected
   - onClick calls handleBulkExport(selectedIds)

4. Load recruiter settings on app start:
   - In App.tsx useEffect, call `useSettingsStore.getState().loadRecruiterSettings()`

NOTE: selectFolder IPC handler already added in Task 2. Do not duplicate.
  </action>
  <verify>
1. TypeScript compiles: `npm run type-check`
2. Export button visible on completed queue items
3. Clicking export opens modal
4. Selecting multiple items shows "Export Selected" action
5. Bulk export to selected folder works
  </verify>
  <done>
Export button exists on queue items. Bulk export available for multiple selections. Full export flow works end-to-end.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete export workflow:
- Export modal with mode selection (Full/Client/Punt)
- Blind profile toggle
- Single CV export from queue
- Bulk export for multiple CVs
- Recruiter settings in Settings dialog
  </what-built>
  <how-to-verify>
1. Start the app: `npm start`
2. Add a CV to the queue (drop a PDF)
3. Wait for processing to complete
4. Click the Export button on the queue item
5. Verify modal appears with:
   - Three mode options (Full, Client, Punt)
   - Client mode pre-selected
   - "Include Blind Profile" checkbox (checked by default)
6. Go to Settings, enter recruiter details (name, phone, email), save
7. Export a CV in Client mode with blind profile
8. Check Downloads folder for output PDF:
   - First page should be Blind Profile with recruiter footer
   - CV pages follow with phone/email redacted (blank space)
9. Export same CV in Punt mode - verify name also removed from CV
10. Export in Full mode - verify no redaction
11. Test bulk export: select multiple CVs, export to specific folder
  </how-to-verify>
  <resume-signal>Type "approved" if export workflow works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Export modal opens from queue item
3. Three modes selectable with Client as default
4. Blind profile toggle works
5. Recruiter settings save and persist
6. Exported PDF has correct structure:
   - Full: No changes
   - Client: Phone/email removed (blank space)
   - Punt: Phone/email/name removed
7. Combined PDF when blind profile enabled:
   - Page 1: Blind Profile with recruiter box
   - Page 2+: Original CV (redacted per mode)
8. Bulk export works for multiple CVs
9. **End-to-end performance test (<500ms requirement)**:
   - Open DevTools console
   - Run timing test:
   ```javascript
   const start = performance.now();
   await window.api.exportCV(cvId, 'client', null, true);
   const elapsed = performance.now() - start;
   console.log(`Export completed in ${elapsed.toFixed(0)}ms`);
   // MUST be <500ms for typical 2-3 page CV with blind profile
   ```
   - This measures: IPC call + Python redaction + blind profile generation + PDF merge + file write
   - If >500ms, investigate which step is slow (add timing logs to Python main.py export_cv handler)
</verification>

<success_criteria>
- Export modal renders with terminal theme styling
- Mode selection defaults to "Client"
- Blind profile checkbox defaults to checked
- Recruiter warning appears if not configured
- Single export saves to Downloads
- Bulk export saves to user-selected folder
- Exported PDFs are valid and open correctly
- All three modes produce correct output
</success_criteria>

<output>
After completion, create `.planning/phases/05-anonymization-branding/05-03-SUMMARY.md`
</output>
