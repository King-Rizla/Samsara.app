---
phase: 04.6-queue-infrastructure-persistence
plan: 05
subsystem: ipc
tags: [timeout, ack, python-sidecar, queuemanager, ipc-callback]

# Dependency graph
requires:
  - phase: 04.6-02
    provides: QueueManager with serial processing and timeout handling
  - phase: 01-03
    provides: Python sidecar IPC via JSON lines stdin/stdout
provides:
  - Processing-started ACK message from Python sidecar
  - ACK callback mechanism in pythonManager for timeout coordination
  - QueueManager timeout triggered by ACK, not submission time
  - Single timeout boundary (no redundant timeouts)
affects: [future-timeout-tuning, llm-extraction-optimization]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "ACK pattern for long-running operations with timeout coordination"
    - "Callback-based timeout start for queue fairness"

key-files:
  created: []
  modified:
    - python-src/main.py
    - src/main/pythonManager.ts
    - src/main/queueManager.ts

key-decisions:
  - "ACK sent immediately when extract_cv begins, before parse_document()"
  - "sendToPython with timeout=0 delegates timeout to caller"
  - "Single timeout boundary in QueueManager only"

patterns-established:
  - "ACK pattern: Python sends {type:'ack', event:'processing_started', id} before long operations"
  - "Callback timeout: Start timeout when operation BEGINS, not when REQUEST is submitted"

# Metrics
duration: 5min
completed: 2026-01-27
---

# Phase 04.6 Plan 05: Timeout-on-ACK Fix Summary

**Fixed timeout bug: CVs waiting in queue now get their full 120s processing window, with timeout starting only when Python begins extraction**

## Performance

- **Duration:** 5 min 25s
- **Started:** 2026-01-27T19:27:19Z
- **Completed:** 2026-01-27T19:32:44Z
- **Tasks:** 3
- **Files modified:** 3

## Accomplishments

- Python sidecar sends processing_started ACK immediately when extract_cv begins
- pythonManager handles ACK messages via callback without resolving promise
- QueueManager starts 120s timeout only after receiving ACK, not on submission
- Eliminated redundant double timeout (was in both pythonManager and QueueManager)

## Task Commits

Each task was committed atomically:

1. **Task 1: Python ACK message on processing start** - `9ba1137` (feat)
2. **Task 2: pythonManager ACK callback with no internal timeout** - `fe4b4aa` (feat)
3. **Task 3: QueueManager starts timeout ONLY on ACK** - `df38e4d` (feat)

## Files Modified

- `python-src/main.py` - Added processing_started ACK message before extraction
- `src/main/pythonManager.ts` - ACK callback mechanism, no internal timeout for extractCV
- `src/main/queueManager.ts` - Timeout starts on ACK callback, not on processNext()

## Decisions Made

- **ACK format:** `{type: 'ack', event: 'processing_started', id: request_id}` - Simple JSON, same IPC channel
- **Timeout delegation:** extractCV passes 0 to sendToPython, QueueManager is sole timeout owner
- **Callback pattern:** onProcessingStarted callback passed through pythonManager to extractCV caller

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- Python verification could not run locally (Python 3.14 on system, spaCy requires 3.12) - Change verified correct via code inspection; packaged app uses correct Python version
- TypeScript compilation shows errors in node_modules due to type definition version mismatch - not from project code; lint passes for project files

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Timeout fix complete and ready for production use
- Queue fairness guaranteed: CV #5 waiting 120s in queue still gets full 120s processing time
- Console logs show "Python ACK received" for debugging timeout behavior

---
*Phase: 04.6-queue-infrastructure-persistence*
*Completed: 2026-01-27*
