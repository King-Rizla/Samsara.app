---
phase: 05-anonymization-branding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - python-src/export/__init__.py
  - python-src/export/redaction.py
  - python-src/main.py
  - python-src/requirements.txt
  - src/main/index.ts
  - src/main/preload.ts
autonomous: true

must_haves:
  truths:
    - "User can export CV with phone and email removed (Client mode)"
    - "User can export CV with phone, email, and name removed (Punt mode)"
    - "User can export CV with no redaction (Full mode)"
    - "Redacted text is physically removed from PDF (not overlaid)"
  artifacts:
    - path: "python-src/export/redaction.py"
      provides: "PyMuPDF-based text redaction"
      exports: ["create_redacted_cv"]
    - path: "python-src/export/__init__.py"
      provides: "Export module initialization"
    - path: "python-src/main.py"
      provides: "export_cv action handler"
      contains: "action == 'export_cv'"
  key_links:
    - from: "src/main/index.ts"
      to: "python-src/main.py"
      via: "IPC invoke export-cv"
      pattern: "ipcMain.handle\\('export-cv'"
    - from: "src/main/preload.ts"
      to: "ipcRenderer"
      via: "exportCV API"
      pattern: "exportCV.*ipcRenderer.invoke"
---

<objective>
Implement PDF redaction engine that removes contact information from CVs based on export mode.

Purpose: Enable recruiters to export "blind" CVs without candidate contact details, preventing clients from contacting candidates directly (anti-backdoor protection).

Output: Python redaction module + IPC handlers for CV export with three modes (full/client/punt).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-anonymization-branding/05-CONTEXT.md
@.planning/phases/05-anonymization-branding/05-RESEARCH.md
@python-src/main.py
@src/main/preload.ts
@src/main/index.ts
@src/main/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create redaction module with PyMuPDF</name>
  <files>
    python-src/export/__init__.py
    python-src/export/redaction.py
    python-src/requirements.txt
  </files>
  <action>
Create the export module directory and redaction implementation:

1. Create `python-src/export/__init__.py`:
   - Export `create_redacted_cv` function

2. Create `python-src/export/redaction.py`:
   - Import pymupdf (already in requirements)
   - Implement `create_redacted_cv(source_path: str, contact_info: dict, mode: str) -> bytes`:
     - mode: 'full' | 'client' | 'punt'
     - full: No redaction, return original bytes
     - client: Redact phone and email only
     - punt: Redact phone, email, AND name
   - Use PyMuPDF's `page.search_for(text)` to find instances
   - Use `page.add_redact_annot(rect, fill=(1, 1, 1))` for white fill (blank space, no black bars)
   - Use `page.apply_redactions()` to physically remove text
   - Return PDF bytes via `doc.tobytes()`
   - Handle empty/None contact fields gracefully

3. Add `reportlab` to requirements.txt (needed for Plan 02):
   - Add line: `reportlab>=4.0.0`

**Important patterns from RESEARCH.md:**
- Always use `apply_redactions()` - this physically removes text, not just overlays
- Use white fill (1, 1, 1) for blank space as specified in CONTEXT.md
- Process all pages in the document
- Close document after processing
  </action>
  <verify>
Test in Python REPL:
```python
from export.redaction import create_redacted_cv
# With a test PDF that contains "test@email.com" and "555-1234"
result = create_redacted_cv("test.pdf", {"email": "test@email.com", "phone": "555-1234"}, "client")
len(result) > 0  # Returns bytes
```
  </verify>
  <done>
Redaction module exists at python-src/export/redaction.py with create_redacted_cv function that takes source_path, contact_info dict, and mode string, returning redacted PDF bytes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add export_cv action to Python sidecar</name>
  <files>python-src/main.py</files>
  <action>
Add `export_cv` action handler to main.py:

1. Import the redaction function at top of file:
   ```python
   from export.redaction import create_redacted_cv
   ```

2. Add action handler in `handle_request()` function (after extract_jd):
   ```python
   if action == 'export_cv':
       cv_id = request.get('cv_id')
       source_path = request.get('source_path')
       contact_info = request.get('contact_info')
       mode = request.get('mode', 'client')  # Default to client mode
       output_dir = request.get('output_dir')

       # Validate required params
       # Call create_redacted_cv
       # Write to output_dir with filename based on name (or "Candidate" for punt)
       # Return success with output_path
   ```

3. Handle errors:
   - FileNotFoundError: Source PDF not found
   - ValueError: Invalid mode
   - Exception: Wrap in generic error response

4. Output file naming:
   - full/client mode: `{name}_CV.pdf` (sanitize name for filesystem)
   - punt mode: `Candidate_CV.pdf`
   - If no name: `Candidate_CV.pdf`
  </action>
  <verify>
Test via JSON stdin:
```bash
echo '{"action": "export_cv", "id": "test", "cv_id": "xxx", "source_path": "/path/to/cv.pdf", "contact_info": {"name": "John", "email": "j@x.com", "phone": "555"}, "mode": "client", "output_dir": "/tmp"}' | python main.py
```
  </verify>
  <done>
Python sidecar handles 'export_cv' action, creates redacted PDF, and returns output path.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add IPC handlers and preload API for export</name>
  <files>
    src/main/index.ts
    src/main/preload.ts
  </files>
  <action>
1. In `src/main/preload.ts`, add exportCV to the api object:
   ```typescript
   /**
    * Export CV with optional redaction.
    * mode: 'full' | 'client' | 'punt'
    * Returns { success: boolean, outputPath?: string, error?: string }
    */
   exportCV: (cvId: string, mode: 'full' | 'client' | 'punt', outputDir?: string): Promise<{ success: boolean; outputPath?: string; error?: string }> =>
     ipcRenderer.invoke('export-cv', cvId, mode, outputDir),
   ```

2. In `src/main/index.ts`, add IPC handler:
   - Import `app` for `app.getPath('downloads')` default
   - Add `ipcMain.handle('export-cv', async (event, cvId, mode, outputDir) => { ... })`
   - Get CV from database using `getCVFull(cvId)`
   - Get CV record for file_path using `getCV(cvId)`
   - Default outputDir to `app.getPath('downloads')`
   - Call pythonManager with export_cv action
   - Return `{ success: true, outputPath }` or `{ success: false, error }`

3. IPC handler flow:
   ```typescript
   ipcMain.handle('export-cv', async (_event, cvId: string, mode: string, outputDir?: string) => {
     const cvRecord = getCV(cvId);
     if (!cvRecord) return { success: false, error: 'CV not found' };

     const cvData = getCVFull(cvId);
     const contact = cvData?.contact || {};
     const actualOutputDir = outputDir || app.getPath('downloads');

     const result = await sendPythonRequest({
       action: 'export_cv',
       cv_id: cvId,
       source_path: cvRecord.file_path,
       contact_info: contact,
       mode: mode,
       output_dir: actualOutputDir
     });

     if (result.success) {
       return { success: true, outputPath: result.data.output_path };
     }
     return { success: false, error: result.error };
   });
   ```
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npm run type-check
```
  </verify>
  <done>
IPC handler 'export-cv' exists in index.ts. Preload exposes exportCV function to renderer. Full round-trip from renderer to Python sidecar works.
  </done>
</task>

</tasks>

<verification>
1. Python module imports without error: `python -c "from export.redaction import create_redacted_cv"`
2. TypeScript compiles: `npm run type-check`
3. Full integration test:
   - Load a CV through existing queue
   - Call `window.api.exportCV(cvId, 'client')` from DevTools console
   - Verify PDF appears in Downloads folder
   - Open PDF and verify contact details are removed (blank space where email/phone were)
</verification>

<success_criteria>
- export_cv action returns { success: true, output_path: string } when given valid CV
- Redacted PDF has blank space where contact info was (not black bars)
- Three modes work: full (no change), client (phone+email removed), punt (phone+email+name removed)
- Output files are named correctly: `{Name}_CV.pdf` or `Candidate_CV.pdf`
- Performance: <500ms for typical 2-3 page CV
</success_criteria>

<output>
After completion, create `.planning/phases/05-anonymization-branding/05-01-SUMMARY.md`
</output>
