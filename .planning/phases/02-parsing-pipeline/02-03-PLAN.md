---
phase: 02-parsing-pipeline
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/main/database.ts
  - src/main/index.ts
  - src/main/pythonManager.ts
  - src/preload/index.ts
  - src/renderer/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can drop a PDF/DOCX file on the window"
    - "Dropped file is sent to Python sidecar for parsing"
    - "Extracted CV data is displayed in the UI"
    - "Extracted data persists to SQLite database"
    - "Confidence scores are stored per field"
    - "Total processing time is under 2 seconds"
  artifacts:
    - path: "src/main/database.ts"
      provides: "SQLite schema for CV storage with confidence scores"
      exports: ["insertCV", "getCV", "getAllCVs"]
    - path: "src/renderer/src/App.tsx"
      provides: "Drag-drop interface showing extracted data"
      min_lines: 50
  key_links:
    - from: "src/renderer/src/App.tsx"
      to: "src/main/pythonManager.ts"
      via: "IPC invoke for extract_cv"
      pattern: "ipcRenderer\\.invoke\\(.*extract"
    - from: "src/main/index.ts"
      to: "python-src/main.py"
      via: "pythonManager.send extract_cv action"
      pattern: "pythonManager.*send.*extract"
    - from: "src/main/database.ts"
      to: "better-sqlite3"
      via: "CV table with contact, work_history, education JSON columns"
      pattern: "CREATE TABLE.*cv"
---

<objective>
Persist extracted CV data to SQLite and create drag-drop UI for parsing.

Purpose: Complete the end-to-end flow where a user drops a CV file, it gets parsed, data is displayed, and persists to the database. This validates the <2s requirement and provides the foundation for Phase 3 (Visual Editor).

Output: SQLite schema for CV storage, drag-drop file handler, extracted data display, end-to-end parsing flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-parsing-pipeline/02-RESEARCH.md
@.planning/phases/02-parsing-pipeline/02-CONTEXT.md
@.planning/phases/02-parsing-pipeline/02-01-SUMMARY.md
@.planning/phases/02-parsing-pipeline/02-02-SUMMARY.md
@src/main/database.ts
@src/main/index.ts
@src/main/pythonManager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQLite schema for CV storage</name>
  <files>src/main/database.ts</files>
  <action>
    Update database.ts to add CV table schema:

    CREATE TABLE IF NOT EXISTS cvs (
      id TEXT PRIMARY KEY,
      file_path TEXT NOT NULL,
      file_name TEXT NOT NULL,
      created_at TEXT NOT NULL,
      updated_at TEXT NOT NULL,
      -- Contact fields with confidence
      contact_json TEXT NOT NULL, -- JSON: ContactInfo
      contact_confidence REAL NOT NULL,
      -- Structured data as JSON (for agent consumption)
      work_history_json TEXT, -- JSON: List[WorkEntry]
      education_json TEXT, -- JSON: List[EducationEntry]
      skills_json TEXT, -- JSON: List[SkillGroup]
      certifications_json TEXT, -- JSON: List[str]
      languages_json TEXT, -- JSON: List[str]
      other_sections_json TEXT, -- JSON: dict
      -- Metadata
      raw_text TEXT, -- Full text for agent re-interpretation
      section_order_json TEXT, -- JSON: List[str]
      parse_confidence REAL NOT NULL,
      warnings_json TEXT, -- JSON: List[str]
      parse_time_ms INTEGER
    )

    Add functions:
    - insertCV(cv: ParsedCV, filePath: string): Insert or replace CV record
    - getCV(id: string): Get CV by ID
    - getAllCVs(): Get all CVs (id, file_name, contact_json, parse_confidence, created_at)
    - deleteCV(id: string): Delete CV by ID

    Use crypto.randomUUID() for IDs. Store dates as ISO strings.
  </action>
  <verify>
    Test in dev mode:
    - App starts without database errors
    - insertCV successfully stores a CV
    - getCV retrieves the stored CV with all fields
    - getAllCVs returns list of CVs
  </verify>
  <done>CV table created with JSON columns for structured data, CRUD functions implemented</done>
</task>

<task type="auto">
  <name>Task 2: Wire up extract_cv IPC and persistence</name>
  <files>src/main/index.ts, src/main/pythonManager.ts, src/preload/index.ts</files>
  <action>
    **pythonManager.ts:**
    - Add extractCV(filePath: string): Promise<ParsedCV> method
    - Sends { action: 'extract_cv', id: uuid, file_path: filePath } to Python
    - Returns parsed CV data or throws on error

    **index.ts:**
    - Add IPC handler for 'extract-cv' channel
    - Accepts file path, calls pythonManager.extractCV
    - On success: calls insertCV to persist, returns { success: true, data: ParsedCV, id: string }
    - On error: returns { success: false, error: string }
    - Log total processing time (Python + DB)

    **preload/index.ts:**
    - Expose extractCV: (filePath: string) => ipcRenderer.invoke('extract-cv', filePath)

    Handle file path validation:
    - Check file exists
    - Check extension is .pdf, .docx, or .doc
    - Return clear error if invalid
  </action>
  <verify>
    Test IPC flow:
    - Call window.api.extractCV(testFilePath) from renderer console
    - Verify response has success: true and data with contact, work_history, etc.
    - Verify CV is persisted (call getAllCVs)
    - Verify error handling for invalid paths
  </verify>
  <done>extract-cv IPC handler parses file, persists to DB, returns structured data</done>
</task>

<task type="auto">
  <name>Task 3: Create drag-drop UI with extracted data display</name>
  <files>src/renderer/src/App.tsx</files>
  <action>
    Update App.tsx to create a simple parsing interface:

    **Drag-drop zone:**
    - Large drop zone in center of window
    - Accept .pdf, .docx files
    - Show "Drop CV here to parse" message
    - On drop: call window.api.extractCV(file.path)
    - Show loading spinner during processing

    **Results display:**
    - After successful parse, show extracted data:
      - Contact section: Name, Email, Phone, LinkedIn (highlight low confidence < 0.7)
      - Work History: List of jobs with company, title, dates
      - Education: List of degrees with institution, degree, dates
      - Skills: Grouped skill lists
    - Show parse_confidence score as percentage
    - Show parse_time_ms to demonstrate <2s requirement
    - Show any warnings from parsing

    **Error handling:**
    - Show error message if parsing fails
    - Clear error on new drop

    Use basic Tailwind CSS for styling (already set up in Phase 1).
    Keep it simple - this is for validation, not final UI (Phase 3 is Visual Editor).
  </action>
  <verify>
    Manual testing:
    - Drop a PDF CV on the window
    - Verify loading spinner appears
    - Verify extracted data displays (name, email, work history)
    - Verify parse time is shown and < 2 seconds
    - Verify low-confidence fields are highlighted
    - Try dropping an invalid file type - verify error message
  </verify>
  <done>Drag-drop UI accepts CVs, displays extracted data with confidence highlighting, shows parse time</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 2 parsing pipeline:
    1. PDF/DOCX file parsing with PyMuPDF/python-docx
    2. Entity extraction (contact, work history, education, skills)
    3. SQLite persistence with confidence scores
    4. Drag-drop UI showing extracted data
  </what-built>
  <how-to-verify>
    1. Run `npm run start` to launch the app
    2. Find or create a test CV in PDF or DOCX format
    3. Drop the CV file on the application window
    4. Verify the following:
       - Loading spinner appears briefly
       - Parse time is displayed and < 2 seconds
       - Contact information is extracted (name, email, phone if present)
       - Work history shows job entries (company, title, dates)
       - Education shows degree entries (institution, degree)
       - Skills are listed
       - Low-confidence fields (< 70%) are visually distinct
    5. Close and reopen the app - verify CV persists in database
    6. Test with a second CV to verify multiple CVs can be parsed
  </how-to-verify>
  <resume-signal>Type "approved" if parsing works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. Database has cvs table with all columns
2. extract-cv IPC handler works end-to-end
3. Drag-drop accepts PDF and DOCX files
4. Extracted data displays with confidence scores
5. Parse time is under 2 seconds for typical CVs
6. Data persists across app restarts
7. Human verification confirms visual results match extracted data
</verification>

<success_criteria>
Phase 2 Success Criteria (from ROADMAP.md):
1. User can drop a PDF/DOCX file and see extracted contact fields within 2 seconds - VERIFIED
2. Parsing works on 90%+ of adversarial corpus - TO BE TESTED (corpus TBD)
3. Extracted data persists to SQLite with confidence scores per field - VERIFIED
4. spaCy model is preloaded at sidecar startup (no per-request loading penalty) - VERIFIED (Phase 1)

This plan validates criteria 1, 3, and 4. Criterion 2 (adversarial corpus) will be addressed after basic pipeline is working, either as a gap closure plan or manual testing.
</success_criteria>

<output>
After completion, create `.planning/phases/02-parsing-pipeline/02-03-SUMMARY.md`
</output>
