---
phase: "04.8"
plan: "02"
subsystem: "python-extraction"
tags: ["pydantic", "llm-prompt", "matching-metadata", "boolean-search", "ipc"]
dependency_graph:
  requires: ["04.8-01"]
  provides: ["matching-metadata-schemas", "enhanced-jd-prompt", "ipc-wiring"]
  affects: ["04.8-04"]
tech_stack:
  added: []
  patterns: ["single-llm-call-dual-output", "forward-reference-model-rebuild"]
key_files:
  created: []
  modified:
    - "python-src/extractors/llm/schemas.py"
    - "python-src/extractors/llm/prompts.py"
    - "python-src/main.py"
    - "src/main/index.ts"
decisions:
  - id: "04.8-02-01"
    decision: "Forward reference with model_rebuild() for matching_metadata field on LLMJDExtraction"
    reason: "LLMMatchingMetadata defined after LLMJDExtraction to keep JD schemas grouped"
metrics:
  duration: "5 min"
  completed: "2026-01-28"
---

# Phase 4.8 Plan 02: Python Matching Metadata Schemas & Prompt Summary

Extended JD extraction with Pydantic schemas for matching metadata (skill variants, three-tier boolean strings, search hints) and enhanced prompt for single-call extraction of both requirements and metadata, wired through IPC to database.

## What Was Done

### Task 1: Matching Metadata Pydantic Schemas
Added four new models to `schemas.py`:
- **LLMExpandedSkill**: skill name + variants (synonyms/abbreviations) + related_tools
- **LLMBooleanStrings**: wide/midline/narrow three-tier boolean search strings
- **LLMSearchHints**: suggested_titles, industries, negative_keywords
- **LLMMatchingMetadata**: composite model aggregating the above

Added `matching_metadata: Optional[LLMMatchingMetadata]` field to `LLMJDExtraction` with forward reference resolution via `model_rebuild()`.

### Task 2: Enhanced JD Extraction Prompt
Rewrote `JD_EXTRACTION_PROMPT` as a two-part prompt:
- Part 1: Requirements extraction (unchanged behavior)
- Part 2: Matching metadata generation with expanded_skills, boolean_strings, search_hints
- Complete JSON example showing both parts
- Boolean syntax guidelines with character limits per tier

### Task 3: IPC Wiring
- Python `main.py`: Added `matching_metadata` to IPC response using `model_dump()`
- TypeScript `index.ts`: Added `matching_metadata` to result type cast and `jdData` object
- End-to-end flow: LLM -> Python schema -> IPC JSON -> TypeScript -> insertJD -> database column

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added matching_metadata to Python IPC response**
- **Found during:** Task 3
- **Issue:** Python main.py manually mapped fields but did not include matching_metadata
- **Fix:** Added `model_dump()` serialization for matching_metadata in the response dict
- **Files modified:** python-src/main.py

**2. [Rule 3 - Blocking] Added matching_metadata to TypeScript IPC type and data mapping**
- **Found during:** Task 3
- **Issue:** TypeScript handler type cast and jdData construction omitted matching_metadata
- **Fix:** Added matching_metadata to both the type assertion and ParsedJD construction
- **Files modified:** src/main/index.ts

## Commits

| # | Hash | Message |
|---|------|---------|
| 1 | ab3bdb7 | feat(04.8-02): add matching metadata Pydantic schemas |
| 2 | 6cd5559 | feat(04.8-02): enhance JD extraction prompt with matching metadata |
| 3 | a47e9b9 | feat(04.8-02): wire matching_metadata through IPC to database |
