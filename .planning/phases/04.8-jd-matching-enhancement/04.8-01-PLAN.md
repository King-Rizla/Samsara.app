---
phase: 04.8-jd-matching-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/database.ts
autonomous: true

must_haves:
  truths:
    - "Database can store matching_metadata JSON for job descriptions"
    - "Existing JDs continue to work without matching_metadata"
    - "Migration is idempotent (can run multiple times safely)"
  artifacts:
    - path: "src/main/database.ts"
      provides: "Migration v4 adding matching_metadata_json column"
      contains: "matching_metadata_json"
  key_links:
    - from: "insertJD function"
      to: "matching_metadata_json column"
      via: "optional parameter in INSERT"
      pattern: "matching_metadata_json"
---

<objective>
Add database schema support for matching_metadata storage on job descriptions.

Purpose: Enable storing LLM-generated skill variants, boolean strings, and search hints alongside JD requirements. This is the foundation for Phase 4.8 JD Matching Enhancement.

Output: Database migration v4 that adds matching_metadata_json column to job_descriptions table.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.8-jd-matching-enhancement/04.8-RESEARCH.md

# Key existing code
@src/main/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add database migration v4 for matching_metadata</name>
  <files>src/main/database.ts</files>
  <action>
Add migration block for version 4 in initDatabase() after the version 3 block:

```typescript
if (version < 4) {
  console.log('Migrating database to version 4 (matching metadata)...');

  // Check if column exists before adding (idempotent migration)
  const jdColumns = db.prepare("PRAGMA table_info(job_descriptions)").all() as { name: string }[];

  if (!jdColumns.some(col => col.name === 'matching_metadata_json')) {
    db.exec(`ALTER TABLE job_descriptions ADD COLUMN matching_metadata_json TEXT`);
  }

  db.pragma('user_version = 4');
  console.log('Database migrated to version 4');
}
```

This adds an optional matching_metadata_json column that stores the enhanced matching data:
- expanded_skills (skills with variants and related tools)
- boolean_strings (wide/midline/narrow search strings)
- search_hints (suggested titles, industries, negative keywords)

The column is nullable so existing JDs continue to work without matching metadata.
  </action>
  <verify>
1. App starts without errors
2. Run: `npm run start` and check console for "Database migrated to version 4" (on fresh DB) or successful startup (on existing DB)
3. Check database has the column: Open SQLite DB and run `PRAGMA table_info(job_descriptions);`
  </verify>
  <done>matching_metadata_json column exists on job_descriptions table, migration is idempotent</done>
</task>

<task type="auto">
  <name>Task 2: Update insertJD and getJD functions</name>
  <files>src/main/database.ts</files>
  <action>
Update the ParsedJD interface to include optional matching_metadata:

```typescript
export interface ParsedJD {
  title: string;
  company?: string;
  raw_text: string;
  required_skills: SkillRequirement[];
  preferred_skills: SkillRequirement[];
  experience_min?: number;
  experience_max?: number;
  education_level?: string;
  certifications: string[];
  matching_metadata?: unknown;  // JSON object stored as-is
}
```

Update FullJD interface similarly:

```typescript
export interface FullJD extends ParsedJD {
  id: string;
  created_at: string;
  updated_at: string;
}
```

Update insertJD function to include matching_metadata_json:

```typescript
export function insertJD(jd: ParsedJD, projectId?: string): string {
  // ... existing code ...

  const stmt = database.prepare(`
    INSERT INTO job_descriptions (
      id, title, company, raw_text,
      required_skills_json, preferred_skills_json,
      experience_min, experience_max,
      education_level, certifications_json,
      matching_metadata_json,
      created_at, updated_at, project_id
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
  `);

  stmt.run(
    id,
    jd.title,
    jd.company || null,
    jd.raw_text,
    jd.required_skills ? JSON.stringify(jd.required_skills) : null,
    jd.preferred_skills ? JSON.stringify(jd.preferred_skills) : null,
    jd.experience_min ?? null,
    jd.experience_max ?? null,
    jd.education_level || null,
    jd.certifications ? JSON.stringify(jd.certifications) : null,
    jd.matching_metadata ? JSON.stringify(jd.matching_metadata) : null,
    now,
    now,
    projectId || null
  );

  // ... rest unchanged ...
}
```

Update getJD function to return matching_metadata:

```typescript
export function getJD(id: string): FullJD | null {
  const database = getDatabase();
  const row = database.prepare('SELECT * FROM job_descriptions WHERE id = ?').get(id) as (JDRecord & { matching_metadata_json?: string }) | undefined;

  if (!row) return null;

  return {
    id: row.id,
    title: row.title,
    company: row.company || undefined,
    raw_text: row.raw_text,
    required_skills: JSON.parse(row.required_skills_json || '[]'),
    preferred_skills: JSON.parse(row.preferred_skills_json || '[]'),
    experience_min: row.experience_min ?? undefined,
    experience_max: row.experience_max ?? undefined,
    education_level: row.education_level || undefined,
    certifications: JSON.parse(row.certifications_json || '[]'),
    matching_metadata: row.matching_metadata_json ? JSON.parse(row.matching_metadata_json) : undefined,
    created_at: row.created_at,
    updated_at: row.updated_at,
  };
}
```
  </action>
  <verify>
1. TypeScript compiles: `npm run lint` passes
2. Existing JD operations still work (create JD, view JD)
3. New JDs can be created with or without matching_metadata
  </verify>
  <done>insertJD accepts optional matching_metadata, getJD returns matching_metadata when present</done>
</task>

</tasks>

<verification>
1. App starts successfully with migration applied
2. `npm run lint` passes
3. Create a new JD via the app - should work without matching_metadata
4. Database inspection shows matching_metadata_json column exists
</verification>

<success_criteria>
- Database migration v4 successfully adds matching_metadata_json column
- Migration is idempotent (running twice doesn't error)
- Existing JDs continue to work (matching_metadata is optional/nullable)
- insertJD and getJD handle matching_metadata correctly
</success_criteria>

<output>
After completion, create `.planning/phases/04.8-jd-matching-enhancement/04.8-01-SUMMARY.md`
</output>
